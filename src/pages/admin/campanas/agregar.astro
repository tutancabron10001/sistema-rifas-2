---
import "../../../styles/global.css";
import { db, client } from '../../../db/client';
import { campaigns, events, numerosRifa } from '../../../db/schema';
import { v2 as cloudinary } from 'cloudinary';
import { desc } from 'drizzle-orm';

// Verificar autenticación
if (!Astro.cookies.has("admin_session")) {
  return Astro.redirect("/admin/login");
}

cloudinary.config({
  cloud_name: import.meta.env.CLOUDINARY_CLOUD_NAME || process.env.CLOUDINARY_CLOUD_NAME,
  api_key: import.meta.env.CLOUDINARY_API_KEY || process.env.CLOUDINARY_API_KEY,
  api_secret: import.meta.env.CLOUDINARY_API_SECRET || process.env.CLOUDINARY_API_SECRET,
});

let error = '';
let success = false;

if (Astro.request.method === 'POST') {
  try {
    const form = await Astro.request.formData();
    const name = String(form.get('name') || '').trim();
    const description = String(form.get('description') || '').trim();
    const price = Number(form.get('price') || 0);
    const promoPriceRaw = form.get('promoPrice');
    const promoPrice = promoPriceRaw && String(promoPriceRaw).trim() !== '' ? Number(promoPriceRaw) : null;
    const numbersMode = String(form.get('numbersMode') || '').trim();
    const raffleDate = String(form.get('raffleDate') || '').trim();
    const imageFile = form.get('image');

    console.log('=== POST recibido ===', { name, price, numbersMode, raffleDate });

    if (!name || !numbersMode || !raffleDate || Number.isNaN(price)) {
      error = 'Todos los campos requeridos deben estar completos';
    } else {
      let imageUrl: string | null = null;
      
      // Upload to Cloudinary
      if (imageFile && typeof imageFile === 'object' && 'arrayBuffer' in imageFile) {
        const file = imageFile as File;
        if (file.size > 0) {
          const buffer = Buffer.from(await file.arrayBuffer());
          const uploadResult = await new Promise<any>((resolve, reject) => {
            const stream = cloudinary.uploader.upload_stream(
              { folder: 'sistema-rifas/campanas' },
              (err, result) => {
                if (err) reject(err);
                else resolve(result);
              }
            );
            stream.end(buffer);
          });
          imageUrl = uploadResult?.secure_url ?? uploadResult?.url ?? null;
          console.log('Imagen subida:', imageUrl);
        }
      }

      const nowIso = new Date().toISOString();

      // Insert campaign
      await db.insert(campaigns).values({
        name,
        description: description || null,
        price,
        promoPrice,
        imageUrl,
        numbersMode,
        createdAt: nowIso,
      });
      console.log('Campaña insertada');

      // Get the campaign ID using raw client
      const resultCampaign = await client.execute('SELECT last_insert_rowid() as id');
      const campaignId = Number(resultCampaign.rows[0]?.id);
      console.log('Campaign ID:', campaignId);

      // Create event
      await db.insert(events).values({
        campaignId,
        name,
        price,
        promoPrice,
        createdAt: nowIso,
        raffleDate,
      });
      console.log('Evento insertado');

      // Get the event ID using raw client
      const resultEvent = await client.execute('SELECT last_insert_rowid() as id');
      const eventId = Number(resultEvent.rows[0]?.id);
      console.log('Event ID:', eventId);

      // Generate raffle numbers
      let maxNumber = 99;
      let padding = 2;
      if (numbersMode === '0-999') { maxNumber = 999; padding = 3; }
      else if (numbersMode === '0-9999') { maxNumber = 9999; padding = 4; }

      const numerosToInsert = [];
      for (let i = 0; i <= maxNumber; i++) {
        numerosToInsert.push({
          eventId,
          numero: String(i).padStart(padding, '0'),
          estado: 'disponible',
          precioSeleccionado: price,
          tipoPrecio: 'normal',
          abonado: 0,
          numeroIdentificacion: null,
          createdAt: nowIso,
        });
      }

      // Batch insert
      const batchSize = 500;
      for (let i = 0; i < numerosToInsert.length; i += batchSize) {
        await db.insert(numerosRifa).values(numerosToInsert.slice(i, i + batchSize));
      }
      console.log(`${numerosToInsert.length} números creados`);

      // Redirect to campaigns list
      return Astro.redirect('/admin/campanas');
    }
  } catch (e) {
    console.error('Error:', e);
    error = 'Error al guardar: ' + String(e);
  }
}
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agregar Campaña — Administración</title>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-rose-50 via-sky-50 to-white text-slate-900">
    <!-- Animated background elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute top-1/4 -left-48 w-96 h-96 bg-rose-200/50 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-1/4 -right-48 w-96 h-96 bg-sky-200/50 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <!-- Header -->
    <header class="absolute top-0 left-0 right-0 z-10 p-6">
      <div class="flex items-center justify-between max-w-4xl mx-auto">
        <a href="/admin/campanas" class="group flex items-center gap-2 text-slate-700 hover:text-slate-900 transition-all duration-300">
          <svg class="w-6 h-6 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="font-medium">Volver</span>
        </a>
        <div class="text-center">
          <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-rose-600 via-fuchsia-600 to-sky-600 bg-clip-text text-transparent">
            Agregar Campaña
          </h1>
        </div>
        <div class="w-24"></div>
      </div>
    </header>

    <main class="relative z-10 max-w-4xl mx-auto pt-32 pb-12 px-4">
      {error && (
        <div class="mb-6 p-4 bg-rose-50 border border-rose-200 text-rose-800 rounded-xl">
          {error}
        </div>
      )}

      <div class="app-surface p-8">
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Nombre de campaña *</label>
            <input name="name" type="text" required class="app-input" />
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Descripción</label>
            <textarea name="description" rows="4" class="app-input"></textarea>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Precio 1 *</label>
              <input name="price" type="number" step="0.01" min="0" required class="app-input" />
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Precio promoción</label>
              <input name="promoPrice" type="number" step="0.01" min="0" class="app-input" />
            </div>
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Imagen (Cloudinary)</label>
            <input name="image" type="file" accept="image/*" class="app-input" />
            <p class="text-xs text-slate-500 mt-2">La imagen se subirá a Cloudinary.</p>
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Números *</label>
            <select name="numbersMode" class="app-input" required>
              <option value="0-99">0 a 99</option>
              <option value="0-999">0 a 999</option>
              <option value="0-9999">0 a 9999</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Fecha de rifa *</label>
            <input name="raffleDate" type="datetime-local" required class="app-input" />
          </div>

          <div class="pt-4 flex gap-4">
            <button type="submit" class="flex-1 bg-gradient-to-r from-rose-600 to-fuchsia-600 hover:from-rose-500 hover:to-fuchsia-500 text-white font-extrabold py-3 px-6 rounded-xl shadow-lg shadow-rose-500/25 hover:shadow-2xl hover:shadow-rose-500/30 transform hover:scale-[1.02] active:scale-95 transition-all duration-300">
              Guardar Campaña
            </button>
            <a href="/admin/campanas" class="flex-1 bg-white hover:bg-slate-50 text-slate-800 font-bold py-3 px-6 rounded-xl text-center transition-all duration-300 border border-slate-200">
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </main>
  </body>
</html>
