---
import "../../../../styles/global.css";
import { db } from '../../../../db/client';
import { campaigns, events } from '../../../../db/schema';
import { eq, desc } from 'drizzle-orm';
import { v2 as cloudinary } from 'cloudinary';

// Verificar autenticación
if (!Astro.cookies.has("admin_session")) {
  return Astro.redirect("/admin/login");
}

cloudinary.config({
  cloud_name: import.meta.env.CLOUDINARY_CLOUD_NAME || process.env.CLOUDINARY_CLOUD_NAME,
  api_key: import.meta.env.CLOUDINARY_API_KEY || process.env.CLOUDINARY_API_KEY,
  api_secret: import.meta.env.CLOUDINARY_API_SECRET || process.env.CLOUDINARY_API_SECRET,
});

const id = Number(Astro.params.id);
if (!id || Number.isNaN(id)) {
  return Astro.redirect('/admin/campanas');
}

let error = '';

// Fetch campaign and latest event
let campaign = (await db.select().from(campaigns).where(eq(campaigns.id, id)).limit(1))[0];
let event = (await db.select().from(events).where(eq(events.campaignId, id)).orderBy(desc(events.id)).limit(1))[0];

if (!campaign) {
  return Astro.redirect('/admin/campanas');
}

if (Astro.request.method === 'POST') {
  try {
    const form = await Astro.request.formData();
    const name = String(form.get('name') || '').trim();
    const description = String(form.get('description') || '').trim();
    const price = Number(form.get('price') || 0);
    const promoPriceRaw = form.get('promoPrice');
    const promoPrice = promoPriceRaw && String(promoPriceRaw).trim() !== '' ? Number(promoPriceRaw) : null;
    const raffleDate = String(form.get('raffleDate') || '').trim();
    const imageFile = form.get('image');

    if (!name || Number.isNaN(price) || !raffleDate) {
      error = 'Campos requeridos faltantes';
    } else {
      let imageUrl = campaign.imageUrl;
      if (imageFile && typeof imageFile === 'object' && 'arrayBuffer' in imageFile) {
        const file = imageFile as File;
        if (file.size > 0) {
          const buffer = Buffer.from(await file.arrayBuffer());
          const uploadResult = await new Promise<any>((resolve, reject) => {
            const stream = cloudinary.uploader.upload_stream(
              { folder: 'sistema-rifas/campanas' },
              (err, result) => {
                if (err) reject(err);
                else resolve(result);
              }
            );
            stream.end(buffer);
          });
          imageUrl = uploadResult?.secure_url ?? uploadResult?.url ?? imageUrl;
        }
      }

      await db.update(campaigns)
        .set({ name, description: description || null, price, promoPrice, imageUrl })
        .where(eq(campaigns.id, id));

      if (event) {
        await db.update(events)
          .set({ name, price, promoPrice, raffleDate })
          .where(eq(events.id, event.id));
      }

      return Astro.redirect('/admin/campanas');
    }
  } catch (e) {
    error = 'Error al actualizar: ' + String(e);
  }
}
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Editar Campaña — Administración</title>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-gray-950 via-pink-950 to-black text-white">
    <!-- Animated background elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute top-1/4 -left-48 w-96 h-96 bg-pink-500/20 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-1/4 -right-48 w-96 h-96 bg-rose-500/20 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <!-- Header -->
    <header class="absolute top-0 left-0 right-0 z-10 p-6">
      <div class="flex items-center justify-between max-w-4xl mx-auto">
        <a href="/admin/campanas" class="group flex items-center gap-2 text-pink-200 hover:text-pink-100 transition-all duration-300">
          <svg class="w-6 h-6 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="font-medium">Volver</span>
        </a>
        <div class="text-center">
          <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-pink-300 via-rose-300 to-pink-400 bg-clip-text text-transparent">
            Editar Campaña
          </h1>
        </div>
        <div class="w-24"></div>
      </div>
    </header>

    <main class="relative z-10 max-w-4xl mx-auto pt-32 pb-12 px-4">
      {error && (
        <div class="mb-6 p-4 bg-red-500/20 border border-red-500/50 text-red-200 rounded-lg">{error}</div>
      )}

      <div class="bg-gradient-to-br from-pink-900/30 to-rose-900/30 backdrop-blur-xl rounded-2xl p-8 border border-pink-500/30 shadow-xl">
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
          <div>
            <label class="block text-sm font-semibold text-pink-300 uppercase mb-2">Nombre de campaña *</label>
            <input name="name" type="text" required class="w-full bg-gray-900/50 border border-pink-500/30 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-pink-400/60 focus:bg-gray-900/70 transition" value={campaign.name} />
          </div>
          <div>
            <label class="block text-sm font-semibold text-pink-300 uppercase mb-2">Descripción</label>
            <textarea name="description" rows="4" class="w-full bg-gray-900/50 border border-pink-500/30 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-pink-400/60 focus:bg-gray-900/70 transition">{campaign.description}</textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-pink-300 uppercase mb-2">Precio 1 *</label>
              <input name="price" type="number" step="0.01" min="0" required class="w-full bg-gray-900/50 border border-pink-500/30 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-pink-400/60 focus:bg-gray-900/70 transition" value={campaign.price} />
            </div>
            <div>
              <label class="block text-sm font-semibold text-pink-300 uppercase mb-2">Precio promoción</label>
              <input name="promoPrice" type="number" step="0.01" min="0" class="w-full bg-gray-900/50 border border-pink-500/30 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-pink-400/60 focus:bg-gray-900/70 transition" value={campaign.promoPrice ?? ''} />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-pink-300 uppercase mb-2">Imagen (Cloudinary)</label>
            {campaign.imageUrl ? (
              <img src={campaign.imageUrl} alt={campaign.name} class="w-full h-48 object-cover rounded-lg mb-3 border border-pink-500/20" />
            ) : null}
            <input name="image" type="file" accept="image/*" class="w-full bg-gray-900/50 border border-pink-500/30 rounded-lg px-4 py-3 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-pink-600 file:text-white hover:file:bg-pink-500 file:cursor-pointer transition" />
            <p class="text-xs text-pink-200/50 mt-2">Si cargas una imagen nueva, reemplazará a la actual.</p>
          </div>

          <div>
            <label class="block text-sm font-semibold text-pink-300 uppercase mb-2">Números</label>
            <div class="w-full bg-gray-900/30 border border-pink-500/20 rounded-lg px-4 py-3 text-pink-200/70">{campaign.numbersMode}</div>
            <p class="text-xs text-pink-200/50 mt-2">La configuración de números no se modifica aquí.</p>
          </div>

          <div>
            <label class="block text-sm font-semibold text-pink-300 uppercase mb-2">Fecha de rifa *</label>
            <input name="raffleDate" type="datetime-local" required class="w-full bg-gray-900/50 border border-pink-500/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-pink-400/60 focus:bg-gray-900/70 transition" value={event ? event.raffleDate : ''} />
          </div>

          <div class="pt-4 flex gap-4">
            <button type="submit" class="flex-1 bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-pink-500/50 hover:shadow-2xl hover:shadow-pink-500/60 transform hover:scale-[1.02] active:scale-95 transition-all duration-300">
              Guardar Cambios
            </button>
            <a href="/admin/campanas" class="flex-1 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 text-white font-bold py-3 px-6 rounded-lg text-center transition-all duration-300">
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </main>
  </body>
  </html>