---
import "../../../../styles/global.css";
import { db } from '../../../../db/client';
import { campaigns, events } from '../../../../db/schema';
import { eq, desc } from 'drizzle-orm';
import { v2 as cloudinary } from 'cloudinary';

// Verificar autenticación
if (!Astro.cookies.has("admin_session")) {
  return Astro.redirect("/admin/login");
}

cloudinary.config({
  cloud_name: import.meta.env.CLOUDINARY_CLOUD_NAME || process.env.CLOUDINARY_CLOUD_NAME,
  api_key: import.meta.env.CLOUDINARY_API_KEY || process.env.CLOUDINARY_API_KEY,
  api_secret: import.meta.env.CLOUDINARY_API_SECRET || process.env.CLOUDINARY_API_SECRET,
});

const id = Number(Astro.params.id);
if (!id || Number.isNaN(id)) {
  return Astro.redirect('/admin/campanas');
}

let error = '';

// Fetch campaign and latest event
let campaign = (await db.select().from(campaigns).where(eq(campaigns.id, id)).limit(1))[0];
let event = (await db.select().from(events).where(eq(events.campaignId, id)).orderBy(desc(events.id)).limit(1))[0];

if (!campaign) {
  return Astro.redirect('/admin/campanas');
}

if (Astro.request.method === 'POST') {
  try {
    const form = await Astro.request.formData();
    const name = String(form.get('name') || '').trim();
    const description = String(form.get('description') || '').trim();
    const price = Number(form.get('price') || 0);
    const promoPriceRaw = form.get('promoPrice');
    const promoPrice = promoPriceRaw && String(promoPriceRaw).trim() !== '' ? Number(promoPriceRaw) : null;
    const raffleDate = String(form.get('raffleDate') || '').trim();
    const imageFile = form.get('image');

    if (!name || Number.isNaN(price) || !raffleDate) {
      error = 'Campos requeridos faltantes';
    } else {
      let imageUrl = campaign.imageUrl;
      if (imageFile && typeof imageFile === 'object' && 'arrayBuffer' in imageFile) {
        const file = imageFile as File;
        if (file.size > 0) {
          const buffer = Buffer.from(await file.arrayBuffer());
          const uploadResult = await new Promise<any>((resolve, reject) => {
            const stream = cloudinary.uploader.upload_stream(
              { folder: 'sistema-rifas/campanas' },
              (err, result) => {
                if (err) reject(err);
                else resolve(result);
              }
            );
            stream.end(buffer);
          });
          imageUrl = uploadResult?.secure_url ?? uploadResult?.url ?? imageUrl;
        }
      }

      await db.update(campaigns)
        .set({ name, description: description || null, price, promoPrice, imageUrl })
        .where(eq(campaigns.id, id));

      if (event) {
        await db.update(events)
          .set({ name, price, promoPrice, raffleDate })
          .where(eq(events.id, event.id));
      }

      return Astro.redirect('/admin/campanas');
    }
  } catch (e) {
    error = 'Error al actualizar: ' + String(e);
  }
}
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Editar Campaña — Administración</title>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-rose-50 via-sky-50 to-white text-slate-900">
    <!-- Animated background elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute top-1/4 -left-48 w-96 h-96 bg-rose-200/50 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-1/4 -right-48 w-96 h-96 bg-sky-200/50 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <!-- Header -->
    <header class="absolute top-0 left-0 right-0 z-10 p-6">
      <div class="flex items-center justify-between max-w-4xl mx-auto">
        <a href="/admin/campanas" class="group flex items-center gap-2 text-slate-700 hover:text-slate-900 transition-all duration-300">
          <svg class="w-6 h-6 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="font-medium">Volver</span>
        </a>
        <div class="text-center">
          <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-rose-600 via-fuchsia-600 to-sky-600 bg-clip-text text-transparent">
            Editar Campaña
          </h1>
        </div>
        <div class="w-24"></div>
      </div>
    </header>

    <main class="relative z-10 max-w-4xl mx-auto pt-32 pb-12 px-4">
      {error && (
        <div class="mb-6 p-4 bg-rose-50 border border-rose-200 text-rose-800 rounded-xl">{error}</div>
      )}

      <div class="app-surface p-8">
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Nombre de campaña *</label>
            <input name="name" type="text" required class="app-input" value={campaign.name} />
          </div>
          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Descripción</label>
            <textarea name="description" rows="4" class="app-input">{campaign.description}</textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Precio 1 *</label>
              <input name="price" type="number" step="0.01" min="0" required class="app-input" value={campaign.price} />
            </div>
            <div>
              <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Precio promoción</label>
              <input name="promoPrice" type="number" step="0.01" min="0" class="app-input" value={campaign.promoPrice ?? ''} />
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Imagen (Cloudinary)</label>
            {campaign.imageUrl ? (
              <img src={campaign.imageUrl} alt={campaign.name} class="w-full h-48 object-cover rounded-xl mb-3 border border-slate-200" />
            ) : null}
            <input name="image" type="file" accept="image/*" class="app-input" />
            <p class="text-xs text-slate-500 mt-2">Si cargas una imagen nueva, reemplazará a la actual.</p>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Números</label>
            <div class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700">{campaign.numbersMode}</div>
            <p class="text-xs text-slate-500 mt-2">La configuración de números no se modifica aquí.</p>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-700 uppercase mb-2">Fecha de rifa *</label>
            <input name="raffleDate" type="datetime-local" required class="app-input" value={event ? event.raffleDate : ''} />
          </div>

          <div class="pt-4 flex gap-4">
            <button type="submit" class="flex-1 bg-gradient-to-r from-rose-600 to-fuchsia-600 hover:from-rose-500 hover:to-fuchsia-500 text-white font-extrabold py-3 px-6 rounded-xl shadow-lg shadow-rose-500/25 hover:shadow-2xl hover:shadow-rose-500/30 transform hover:scale-[1.02] active:scale-95 transition-all duration-300">
              Guardar Cambios
            </button>
            <a href="/admin/campanas" class="flex-1 bg-white hover:bg-slate-50 text-slate-800 font-bold py-3 px-6 rounded-xl text-center transition-all duration-300 border border-slate-200">
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </main>
  </body>
  </html>