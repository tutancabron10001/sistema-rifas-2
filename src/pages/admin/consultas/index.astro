---
import "../../../styles/global.css";
import { db } from '../../../db/client';
import { campaigns, events } from '../../../db/schema';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import StatCard from '../../../components/admin/StatCard.astro';
import DataTable from '../../../components/admin/DataTable.astro';
import Modal from '../../../components/admin/Modal.astro';

// Verificar autenticaci√≥n
if (!Astro.cookies.has("admin_session")) {
  return Astro.redirect("/admin/login");
}

const campaignList = await db.select().from(campaigns).orderBy(campaigns.createdAt);
const eventList = await db.select().from(events).orderBy(events.createdAt);

// Get current page from URL
const url = Astro.url;
const urlParams = new URLSearchParams(url.search);
const mode = urlParams.get('mode') || 'admin';
const currentPage = mode === 'admin' ? 'consultas-admin' : 
                   mode === 'pago' ? 'consultas-pago' : 
                   mode === 'pagos' ? 'consultas-pagos' : 
                   mode === 'estados' ? 'consultas-estados' : 'consultas-admin';
---

<AdminLayout title="Consultas" currentPage={currentPage}>
  <!-- Page Header -->
  <div class="bg-white shadow-sm border-b border-gray-200">
    <div class="px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div>
          <nav class="flex" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
              <li>
                <a href="/admin" class="text-gray-400 hover:text-gray-500">
                  <svg class="flex-shrink-0 h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                  </svg>
                </a>
              </li>
              <li>
                <div class="flex items-center">
                  <svg class="flex-shrink-0 h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  <span class="ml-2 text-sm font-medium text-gray-500">Consultas</span>
                </div>
              </li>
            </ol>
          </nav>
          <h1 class="mt-2 text-2xl font-bold text-gray-900" id="pageTitle">üìã Consultas Administrativas</h1>
          <p class="mt-1 text-sm text-gray-500" id="pageDescription">Gestiona transacciones pendientes y comprobantes por validar</p>
        </div>
        <div class="flex items-center space-x-3">
          <button class="btn-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nueva Transacci√≥n
          </button>
          <button class="btn-secondary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Exportar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="px-4 sm:px-6 lg:px-8 py-8">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <StatCard 
        title="Transacciones Pendientes" 
        value="24" 
        icon="pending-icon" 
        color="yellow"
        trend={{ value: "12% vs mes anterior", direction: "up" }}
      />
      <StatCard 
        title="Comprobantes por Validar" 
        value="47" 
        icon="document-icon" 
        color="red"
        trend={{ value: "8% vs mes anterior", direction: "up" }}
      />
      <StatCard 
        title="Monto por Procesar" 
        value="$2,450,000" 
        icon="money-icon" 
        color="green"
        trend={{ value: "5% vs mes anterior", direction: "down" }}
      />
      <StatCard 
        title="Transacciones Urgentes" 
        value="8" 
        icon="alert-icon" 
        color="red"
        trend={{ value: "3 nuevas hoy", direction: "up" }}
      />
    </div>

    <!-- Actions Section -->
    <div class="bg-white rounded-lg shadow mb-8">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-medium text-gray-900">Acciones Sugeridas</h2>
        <p class="mt-1 text-sm text-gray-500">Usa la üîç para ver comprobantes ‚Ä¢ Pagar/Abonar al final</p>
      </div>
      <div class="p-6">
        <div id="pendingActionsList" class="space-y-4">
          <!-- Dynamic content will be loaded here -->
          <div class="text-center py-8 text-gray-500">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <p class="mt-2">Cargando acciones pendientes...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-medium text-gray-900">Transacciones Recientes</h2>
          <div class="flex items-center space-x-3">
            <input type="text" 
                   placeholder="Buscar transacci√≥n..." 
                   class="block w-64 px-3 py-2 border border-gray-300 rounded-md text-sm leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            <select class="block px-3 py-2 border border-gray-300 rounded-md text-sm leading-5 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
              <option>Todos los estados</option>
              <option>Pendiente</option>
              <option>Validado</option>
              <option>Rechazado</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="transactionsTableContainer">
        <!-- Table will be dynamically loaded here -->
        <div class="p-6 text-center text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <p class="mt-2">Cargando transacciones...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Proof History Modal -->
  <Modal id="proofHistoryModal" title="Hist√≥rico de Comprobantes" size="xl">
    <div class="grid grid-cols-2 gap-4">
      <!-- Proof cards will be loaded here -->
    </div>
  </Modal>

  <!-- Admin Abono Modal -->
  <Modal id="adminAbonoModal" title="Registrar Abono" size="lg">
    <form id="adminAbonoForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Monto del Abono</label>
        <input type="number" 
               name="amount" 
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Comprobante</label>
        <input type="file" 
               name="proof" 
               accept="image/*"
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" 
                onclick="closeModal('adminAbonoModal')"
                class="btn-secondary">
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          Registrar Abono
        </button>
      </div>
    </form>
  </Modal>

  <!-- Admin Pago Modal -->
  <Modal id="adminPagoModal" title="Registrar Pago" size="lg">
    <form id="adminPagoForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Monto del Pago</label>
        <input type="number" 
               name="amount" 
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Comprobante</label>
        <input type="file" 
               name="proof" 
               accept="image/*"
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" 
                onclick="closeModal('adminPagoModal')"
                class="btn-secondary">
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          Registrar Pago
        </button>
      </div>
    </form>
  </Modal>

</AdminLayout>

<script>
  // Global variables
  let currentMode = 'admin';
  let pendingData = [];
  let currentPage = 1;
  const itemsPerPage = 10;

  // Get URL parameters
  function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // Update page content based on mode
  function updatePageContent(mode) {
    const pageTitle = document.getElementById('pageTitle');
    const pageDescription = document.getElementById('pageDescription');
    
    const pageConfig = {
      'admin': {
        title: '‚úÖ Pendientes del Administrador',
        description: 'Resumen de transacciones con comprobantes pendientes y acciones para registrar pagos/abonos.'
      },
      'pago': {
        title: 'üí≥ Pendientes de Pago',
        description: 'Transacciones que requieren confirmaci√≥n de pago por parte de los usuarios.'
      },
      'pagos': {
        title: 'üí∞ Pagos',
        description: 'Historial de pagos completados y confirmados en el sistema.'
      },
      'estados': {
        title: 'üìä Estados Financieros',
        description: 'Resumen financiero general del sistema de rifas.'
      }
    };
    
    const config = pageConfig[mode] || pageConfig['admin'];
    pageTitle.textContent = config.title;
    pageDescription.textContent = config.description;
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded, initializing...');
    
    // Get mode from URL parameter
    const urlMode = getUrlParameter('mode') || 'admin';
    currentMode = urlMode;
    console.log('üìã URL mode detected:', urlMode);
    
    // Update page content
    updatePageContent(currentMode);
    console.log('üìù Page content updated for mode:', currentMode);
    
    // Load data
    loadPendingActions(currentMode);
    
    // Setup modal form listeners
    setupModalFormListeners();
  });

  // Setup modal form listeners
  function setupModalFormListeners() {
    // Admin Abono form submission
    const adminAbonoForm = document.getElementById('adminAbonoForm');
    if (adminAbonoForm) {
      adminAbonoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const txNum = String(adminAbonoCtx?.tx || '').trim();
        if (!txNum) return;

        const input = document.getElementById('adminAbonoAmountInput');
        const raw = input ? String(input.value || '') : '';
        const amount = Number(raw.replace(/[^\d]/g, ''));
        if (!Number.isFinite(amount) || amount <= 0) {
          setAdminAbonoStatus('Monto inv√°lido.');
          return;
        }

        const btn = document.getElementById('adminAbonoConfirm');
        const prevText = btn ? btn.textContent : '';
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Procesando‚Ä¶';
        }
        setAdminAbonoStatus('Registrando abono‚Ä¶');

        try {
          const resp = await fetch('/api/mark-abono-transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              transactionNumber: txNum, 
              amount, 
              proofId: Number(adminAbonoCtx?.proofId ?? 0) || 0 
            }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            setAdminAbonoStatus(data?.error || 'Error registrando abono');
            return;
          }

          setAdminAbonoStatus('Abono registrado. Actualizando‚Ä¶');
          await loadPendingActions(currentMode);
          closeAdminAbono();
        } catch (e) {
          console.error(e);
          setAdminAbonoStatus('Error registrando abono');
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent = prevText;
          }
        }
      });
    }

    // Admin Pago form submission
    const adminPagoForm = document.getElementById('adminPagoForm');
    if (adminPagoForm) {
      adminPagoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const txNum = String(adminPagoCtx?.tx || '').trim();
        if (!txNum) return;

        const numbers = Array.isArray(adminPagoCtx?.numbers) ? adminPagoCtx.numbers : [];
        if (!numbers.length) {
          setAdminPagoStatus('No hay n√∫meros asociados a esta transacci√≥n.');
          return;
        }

        const btn = document.getElementById('adminPagoConfirm');
        const prevText = btn ? btn.textContent : '';
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'Procesando‚Ä¶';
        }
        setAdminPagoStatus('Registrando pago‚Ä¶');

        try {
          // Detectar el kind del comprobante para usar el endpoint correcto
          const tx = adminPagoCtx.tx;
          const proofs = (proofsByTx && tx && proofsByTx[tx]) ? proofsByTx[tx] : [];
          const proof = proofs.find((p) => p.id === adminPagoCtx.proofId);
          const proofKind = proof ? String(proof.kind || '').toLowerCase() : '';
          const proofAmount = proof && proof.amount != null ? Number(proof.amount) : null;

          // Si el comprobante es de tipo 'abono', usar el endpoint de abono
          if (proofKind === 'abono' && proofAmount != null && Number.isFinite(proofAmount) && proofAmount > 0) {
            const payload = {
              transactionNumber: tx,
              amount: Math.trunc(proofAmount),
              proofId: adminPagoCtx.proofId,
            };

            const resp = await fetch('/api/mark-abono-transaction', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            
            const data = await resp.json();
            if (!resp.ok) {
              setAdminPagoStatus(data?.error || 'Error registrando abono');
              return;
            }
          } else {
            // Usar endpoint de validaci√≥n para pagos
            const resp = await fetch('/api/admin/validate-proofs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ 
                transactionNumber: txNum,
                kind: 'pago'
              }),
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
              setAdminPagoStatus(data?.error || 'Error validando pagos');
              return;
            }
          }

          setAdminPagoStatus('Pago registrado. Actualizando‚Ä¶');
          await loadPendingActions(currentMode);
          closeAdminPago();
        } catch (e) {
          console.error(e);
          setAdminPagoStatus('Error registrando pago');
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent = prevText;
          }
        }
      });
    }

    // COP formatting for admin abono input
    const adminAbonoInput = document.getElementById('adminAbonoAmountInput');
    if (adminAbonoInput) {
      adminAbonoInput.addEventListener('input', function () {
        try {
          let valor = String(this.value || '').replace(/[^\d]/g, '');
          if (valor) {
            const numero = parseInt(valor, 10);
            this.value = '$ ' + (Number.isFinite(numero) ? numero.toLocaleString('es-CO') : '');
          } else {
            this.value = '';
          }
        } catch {
          // ignore
        }
      });
    }

    // Modal close buttons
    const adminAbonoCloseBtn = document.getElementById('adminAbonoCloseBtn');
    if (adminAbonoCloseBtn) {
      adminAbonoCloseBtn.addEventListener('click', closeAdminAbono);
    }

    const adminAbonoCancel = document.getElementById('adminAbonoCancel');
    if (adminAbonoCancel) {
      adminAbonoCancel.addEventListener('click', closeAdminAbono);
    }

    const adminPagoCloseBtn = document.getElementById('adminPagoCloseBtn');
    if (adminPagoCloseBtn) {
      adminPagoCloseBtn.addEventListener('click', closeAdminPago);
    }

    const adminPagoCancel = document.getElementById('adminPagoCancel');
    if (adminPagoCancel) {
      adminPagoCancel.addEventListener('click', closeAdminPago);
    }

    // Proof history modal close
    const proofHistoryCloseBtn = document.getElementById('proofHistoryCloseBtn');
    if (proofHistoryCloseBtn) {
      proofHistoryCloseBtn.addEventListener('click', closeProofHistory);
    }
  }

  // Action handlers
  function viewTransaction(txNumber) {
    console.log('View transaction:', txNumber);
    openProofHistory(txNumber);
  }

  function validateTransaction(txNumber) {
    console.log('Validate transaction:', txNumber);
    // Implement validation logic
  }

  // Load pending actions (existing function)
  async function loadPendingActions(mode) {
    console.log('üîÑ Loading pending actions for mode:', mode);
    try {
      const response = await fetch(`/api/admin/pending-actions?mode=${mode}`);
      console.log('üì° Response status:', response.status);
      
      const data = await response.json();
      console.log('üìä API Response:', data);
      
      // Handle the actual API response format (summary/items, not success/statistics)
      if (response.ok && data) {
        pendingData = data.items || [];
        console.log('‚úÖ Data loaded successfully:', pendingData.length, 'items');
        
        // Merge into caches so the proof-history modal works from here
        pendingData.forEach((it) => {
          const tx = String(it?.transactionNumber || '').trim();
          if (!tx) return;
          const proofs = Array.isArray(it?.proofs) ? it.proofs : [];
          proofsByTx[tx] = proofs;
          txAggByNumber[tx] = {
            totalPrice: Number(it?.totalPrice ?? 0) || 0,
            totalAbonado: Number(it?.totalAbonado ?? 0) || 0,
            paidCount: Number(it?.paidCount ?? 0) || 0,
            creditedTotal: Number(it?.creditedTotal ?? 0) || 0,
            saldoPendiente: Number(it?.saldoPendiente ?? 0) || 0,
          };
        });
        
        renderPendingActions(pendingData);
        renderTransactionsTable(pendingData);
        updateStatistics(data);
        
        // Setup event listeners after rendering
        setupEventListeners();
        
        // Start countdown timers
        ensureCountdownInterval();
        updateAllCountdowns();
      } else {
        console.error('‚ùå Error loading pending actions:', data.error || 'Unknown error');
        // Show error message to user
        const container = document.getElementById('pendingActionsList');
        if (container) {
          container.innerHTML = `
            <div class="text-center py-8 text-red-500">
              <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="mt-2">Error al cargar datos: ${data.error || 'Error desconocido'}</p>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('‚ùå Network error:', error);
      // Show error message to user
      const container = document.getElementById('pendingActionsList');
      if (container) {
        container.innerHTML = `
          <div class="text-center py-8 text-red-500">
            <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="mt-2">Error de conexi√≥n: ${error.message}</p>
          </div>
        `;
      }
    }
  }

  // Setup event listeners for buttons
  function setupEventListeners() {
    // Proof history buttons
    document.querySelectorAll('.proof-history-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const tx = btn.getAttribute('data-tx');
        if (tx) openProofHistory(tx);
      });
    });

    // Pay full transaction
    document.querySelectorAll('button.admin-pay').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const txNum = String(btn.getAttribute('data-tx') || '').trim();
        if (!txNum) return;
        const item = (Array.isArray(pendingData) ? pendingData : []).find((x) => String(x?.transactionNumber || '').trim() === txNum);
        openAdminPago(txNum, item);
      });
    });

    // Abono by transaction (admin enters amount)
    document.querySelectorAll('button.admin-abono').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const txNum = String(btn.getAttribute('data-tx') || '').trim();
        if (!txNum) return;
        const item = (Array.isArray(pendingData) ? pendingData : []).find((x) => String(x?.transactionNumber || '').trim() === txNum);
        openAdminAbono(txNum, item);
      });
    });
  }

  // Render pending actions
  function renderPendingActions(items) {
    const container = document.getElementById('pendingActionsList');
    
    if (!items || items.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="mt-2">No hay acciones pendientes</p>
        </div>
      `;
      return;
    }

    // Use existing renderTransactionCard logic but with new styling
    container.innerHTML = items.map(item => renderTransactionCard(item)).join('');
  }

  // Render transactions table
  function renderTransactionsTable(items) {
    const container = document.getElementById('transactionsTableContainer');
    
    if (!items || items.length === 0) {
      container.innerHTML = `
        <div class="p-6 text-center text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <p class="mt-2">No hay transacciones disponibles</p>
        </div>
      `;
      return;
    }

    const tableHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Transacci√≥n
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Participante
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Evento
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Total
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Pagado
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Pendiente
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Acciones
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            ${items.map(item => `
              <tr class="hover:bg-gray-50 transition-colors duration-150">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  #${item.transactionNumber || '‚Äî'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  ${item.usuarioNombre || 'Usuario'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  ${item.eventName || 'Evento'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                  $${Number(item.totalPrice || 0).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                  $${Number(item.creditedTotal || 0).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                  $${Number(item.saldoPendiente || 0).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <div class="flex items-center justify-end space-x-2">
                    <button onclick="viewTransaction('${item.transactionNumber}')" 
                            class="text-indigo-600 hover:text-indigo-900 transition-colors duration-150"
                            title="Ver detalles">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </button>
                    <button onclick="validateTransaction('${item.transactionNumber}')" 
                            class="text-green-600 hover:text-green-900 transition-colors duration-150"
                            title="Validar">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;

    container.innerHTML = tableHTML;
  }

  // Update statistics
  function updateStatistics(data) {
    const summary = data.summary || {};
    
    // Update the stat cards if they exist
    const statCards = document.querySelectorAll('.stat-card');
    if (statCards.length >= 4) {
      statCards[0].querySelector('.text-2xl').textContent = summary.transactionsPending || '0';
      statCards[1].querySelector('.text-2xl').textContent = summary.proofsPending || '0';
      statCards[2].querySelector('.text-2xl').textContent = `$${Number(summary.pendingAmountTotal || 0).toLocaleString()}`;
      statCards[3].querySelector('.text-2xl').textContent = summary.transactionsUnpaid || '0';
    }
  }

  // Global variables for proofs and transactions
  let proofsByTx = {};
  let txAggByNumber = {};
  let countdownInterval = null;

  // Countdown timer functions
  function formatRemaining(ms) {
    if (!Number.isFinite(ms)) return '‚Äî';
    if (ms <= 0) return '00:00';
    const total = Math.ceil(ms / 1000);
    const hrs = Math.floor(total / 3600);
    const mins = Math.floor((total % 3600) / 60);
    const secs = total % 60;
    const pad = (n) => String(n).padStart(2, '0');
    return hrs > 0 ? `${hrs}:${pad(mins)}:${pad(secs)}` : `${mins}:${pad(secs)}`;
  }

  function updateCountdownElement(el) {
    if (!el) return;
    const expiresAt = String(el.getAttribute('data-expires-at') || '').trim();
    const prefix = String(el.getAttribute('data-prefix') || '').trim();
    if (!expiresAt) return;
    const expMs = Date.parse(expiresAt);
    if (!Number.isFinite(expMs)) return;
    const remaining = expMs - Date.now();
    el.textContent = remaining > 0
      ? `${prefix}${formatRemaining(remaining)}`
      : 'Tiempo agotado';
  }

  function updateAllCountdowns() {
    document.querySelectorAll('.countdown-timer[data-expires-at]').forEach((el) => {
      updateCountdownElement(el);
    });
  }

  function ensureCountdownInterval() {
    if (countdownInterval) return;
    countdownInterval = setInterval(updateAllCountdowns, 1000);
  }

  // Proof history modal functions
  function openProofHistory(transactionNumber) {
    const modal = document.getElementById('proofHistoryModal');
    const title = document.getElementById('proofHistoryTitle');
    const summary = document.getElementById('proofHistorySummary');
    const grid = document.getElementById('proofHistoryGrid');
    const empty = document.getElementById('proofHistoryEmpty');
    const rejGrid = document.getElementById('proofHistoryRejectedGrid');
    const rejEmpty = document.getElementById('proofHistoryRejectedEmpty');
    
    if (!modal || !grid || !empty || !rejGrid || !rejEmpty) return;

    const proofs = (proofsByTx && transactionNumber && proofsByTx[transactionNumber]) ? proofsByTx[transactionNumber] : [];
    const rejected = (Array.isArray(proofs) ? proofs : []).filter((p) => String(p?.status || 'pending').toLowerCase() === 'rejected');
    const considered = (Array.isArray(proofs) ? proofs : []).filter((p) => String(p?.status || 'pending').toLowerCase() !== 'rejected');
    const agg = (txAggByNumber && transactionNumber && txAggByNumber[transactionNumber]) ? txAggByNumber[transactionNumber] : null;
    
    const pendingCount = considered.filter((p) => String(p?.status || 'pending').toLowerCase() === 'pending').length;
    
    grid.innerHTML = '';
    rejGrid.innerHTML = '';
    
    if (title) title.textContent = transactionNumber ? `Transacci√≥n #${transactionNumber}` : '';
    if (summary) {
      if (agg) {
        summary.textContent = `Total: $${Number(agg.totalPrice || 0).toLocaleString()} ‚Ä¢ Registrado: $${Number(agg.creditedTotal || 0).toLocaleString()} ‚Ä¢ Pendiente: $${Number(agg.saldoPendiente || 0).toLocaleString()} ‚Ä¢ Comprobantes pendientes: ${pendingCount}`;
      } else {
        summary.textContent = `Comprobantes pendientes: ${pendingCount}`;
      }
    }

    if (!Array.isArray(proofs) || proofs.length === 0) {
      empty.classList.remove('hidden');
      rejEmpty.classList.remove('hidden');
    } else {
      empty.classList.add('hidden');

      // Normal proofs grid
      const sorted = [...considered].sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));
      sorted.forEach((p) => {
        const card = document.createElement('a');
        card.href = p.url;
        card.target = '_blank';
        card.rel = 'noopener noreferrer';
        card.className = 'relative block bg-white/90 border border-slate-200 rounded-xl overflow-hidden hover:bg-white transition';

        const isPending = String(p?.status || 'pending').toLowerCase() === 'pending';

        const img = document.createElement('img');
        img.src = p.url;
        img.alt = 'Comprobante';
        img.className = 'w-full h-28 object-cover';

        const badge = document.createElement('div');
        badge.className = 'absolute top-2 right-2 w-10 h-10 rounded-full flex items-center justify-center bg-white/90 border border-slate-200 backdrop-blur-sm shadow-lg';
        badge.innerHTML = isPending
          ? '<span class="text-2xl leading-none text-amber-700 font-black">‚è≥</span>'
          : '<span class="text-2xl leading-none text-emerald-700 font-black">‚úì</span>';

        const rejectBtn = document.createElement('button');
        rejectBtn.type = 'button';
        rejectBtn.className = 'absolute top-2 left-2 px-2 h-8 rounded-xl bg-white/90 border border-rose-200 text-rose-700 text-xs font-black hover:bg-rose-50 backdrop-blur-sm shadow-lg';
        rejectBtn.textContent = 'Rechazar';
        rejectBtn.addEventListener('click', async (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          const proofId = Number(p?.id ?? 0);
          if (!Number.isFinite(proofId) || proofId <= 0) return;
          const reason = prompt('Motivo del rechazo (opcional):', '') || '';
          if (!confirm('¬øConfirmas rechazar este comprobante?')) return;

          try {
            const resp = await fetch('/api/admin/reject-proof', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ proofId, reason }),
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
              alert(data?.error || 'Error rechazando comprobante');
              return;
            }
            // Reload data
            loadPendingActions(currentMode);
            openProofHistory(transactionNumber); // Refresh modal
          } catch (e) {
            console.error(e);
            alert('Error rechazando comprobante');
          }
        });

        card.appendChild(img);
        card.appendChild(badge);
        if (isPending) card.appendChild(rejectBtn);
        grid.appendChild(card);
      });

      // Rejected proofs grid
      if (rejected.length > 0) {
        const rejectedSorted = [...rejected].sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));
        rejectedSorted.forEach((p) => {
          const card = document.createElement('a');
          card.href = p.url;
          card.target = '_blank';
          card.rel = 'noopener noreferrer';
          card.className = 'relative block bg-white/90 border border-slate-200 rounded-xl overflow-hidden hover:bg-white transition opacity-60';

          const img = document.createElement('img');
          img.src = p.url;
          img.alt = 'Comprobante rechazado';
          img.className = 'w-full h-28 object-cover';

          const badge = document.createElement('div');
          badge.className = 'absolute top-2 right-2 w-10 h-10 rounded-full flex items-center justify-center bg-white/90 border border-slate-200 backdrop-blur-sm shadow-lg';
          badge.innerHTML = '<span class="text-2xl leading-none text-rose-700 font-black">‚úï</span>';

          card.appendChild(img);
          card.appendChild(badge);
          rejGrid.appendChild(card);
        });
        rejEmpty.classList.add('hidden');
      } else {
        rejEmpty.classList.remove('hidden');
      }
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeProofHistory() {
    const modal = document.getElementById('proofHistoryModal');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
  }

  // Admin Abono Modal Context
  let adminAbonoCtx = { tx: '', suggestedAmount: 0, proofId: 0 };

  function setAdminAbonoStatus(msg) {
    const el = document.getElementById('adminAbonoStatus');
    if (el) el.textContent = msg || '';
  }

  function closeAdminAbono() {
    const modal = document.getElementById('adminAbonoModal');
    if (modal) modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    adminAbonoCtx = { tx: '', suggestedAmount: 0, proofId: 0 };
    setAdminAbonoStatus('');
  }

  function openAdminAbono(txNum, item) {
    const modal = document.getElementById('adminAbonoModal');
    if (!modal) return;

    adminAbonoCtx.tx = String(txNum || '').trim();
    adminAbonoCtx.suggestedAmount = 0;
    adminAbonoCtx.proofId = 0;

    const title = document.getElementById('adminAbonoTitle');
    const subtitle = document.getElementById('adminAbonoSubtitle');
    const img = document.getElementById('adminAbonoProofImg');
    const link = document.getElementById('adminAbonoProofLink');
    const empty = document.getElementById('adminAbonoProofEmpty');
    const meta = document.getElementById('adminAbonoProofMeta');
    const amtEl = document.getElementById('adminAbonoProofAmount');
    const input = document.getElementById('adminAbonoAmountInput');

    const tx = adminAbonoCtx.tx;
    if (title) title.textContent = tx ? `Transacci√≥n #${tx}` : '';

    // Pull proof (prefer pending proof)
    const proofs = (proofsByTx && tx && proofsByTx[tx]) ? proofsByTx[tx] : [];
    const pendingProofs = (Array.isArray(proofs) ? proofs : [])
      .filter((p) => String(p?.status || 'pending').toLowerCase() !== 'rejected')
      .sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));
    const proof = pendingProofs.length ? pendingProofs[0] : ((Array.isArray(proofs) && proofs.length) ? proofs[0] : null);
    adminAbonoCtx.proofId = proof?.id != null ? Number(proof.id) : 0;

    const totalPrice = Number(item?.totalPrice ?? 0) || 0;
    const credited = Number(item?.creditedTotal ?? 0) || 0;
    const saldo = Number(item?.saldoPendiente ?? 0) || 0;
    const userName = item?.usuarioNombre ? String(item.usuarioNombre) : '';
    const eventName = item?.eventName ? String(item.eventName) : '';
    if (subtitle) {
      const who = userName ? `${userName}${eventName ? ` ‚Ä¢ ${eventName}` : ''}` : (eventName || '');
      subtitle.textContent = `${who}${who ? ' ‚Ä¢ ' : ''}Total: $${totalPrice.toLocaleString()} ‚Ä¢ Registrado: $${credited.toLocaleString()} ‚Ä¢ Saldo: $${saldo.toLocaleString()}`;
    }

    // Proof image + meta
    const proofUrl = proof && proof.url ? String(proof.url) : '';
    if (proofUrl && img && link && empty) {
      img.src = proofUrl;
      link.href = proofUrl;
      link.classList.remove('hidden');
      img.classList.remove('hidden');
      empty.classList.add('hidden');
    } else {
      if (img) img.classList.add('hidden');
      if (link) link.classList.add('hidden');
      if (empty) empty.classList.remove('hidden');
    }

    const kind = proof ? String(proof.kind || '').toUpperCase() : '';
    const createdAt = proof ? new Date(proof.createdAt).toLocaleString('es-CO') : '';
    const amt = proof && proof.amount != null ? Number(proof.amount) : null;

    if (meta) meta.textContent = `${kind || 'COMPROBANTE'}${createdAt ? ` ‚Ä¢ ${createdAt}` : ''}`;
    if (amtEl) amtEl.textContent = amt != null && Number.isFinite(amt) && amt > 0 ? `$${amt.toLocaleString()}` : '';

    // Suggested amount: for ABONO proof, use amount; else leave empty.
    if (kind === 'ABONO' && amt != null && Number.isFinite(amt) && amt > 0) {
      adminAbonoCtx.suggestedAmount = Math.trunc(amt);
    }

    if (input) {
      input.value = adminAbonoCtx.suggestedAmount ? ('$ ' + adminAbonoCtx.suggestedAmount.toLocaleString('es-CO')) : '';
    }

    setAdminAbonoStatus('');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    setTimeout(() => {
      try { document.getElementById('adminAbonoAmountInput')?.focus(); } catch {}
    }, 0);
  }

  // Admin Pago Modal Context
  let adminPagoCtx = { tx: '', numbers: [], proofId: 0 };

  function setAdminPagoStatus(msg) {
    const el = document.getElementById('adminPagoStatus');
    if (el) el.textContent = msg || '';
  }

  function closeAdminPago() {
    const modal = document.getElementById('adminPagoModal');
    if (modal) modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    adminPagoCtx = { tx: '', numbers: [], proofId: 0 };
    setAdminPagoStatus('');
  }

  function openAdminPago(txNum, item) {
    const modal = document.getElementById('adminPagoModal');
    if (!modal) return;

    adminPagoCtx.tx = String(txNum || '').trim();
    adminPagoCtx.numbers = item?.numbers || [];
    adminPagoCtx.proofId = 0;

    const title = document.getElementById('adminPagoTitle');
    const subtitle = document.getElementById('adminPagoSubtitle');
    const img = document.getElementById('adminPagoProofImg');
    const link = document.getElementById('adminPagoProofLink');
    const empty = document.getElementById('adminPagoProofEmpty');
    const meta = document.getElementById('adminPagoProofMeta');
    const amtEl = document.getElementById('adminPagoProofAmount');

    const tx = adminPagoCtx.tx;
    if (title) title.textContent = tx ? `Transacci√≥n #${tx}` : '';

    const totalPrice = Number(item?.totalPrice ?? 0) || 0;
    const credited = Number(item?.creditedTotal ?? 0) || 0;
    const saldo = Number(item?.saldoPendiente ?? 0) || 0;
    const userName = item?.usuarioNombre ? String(item.usuarioNombre) : '';
    const eventName = item?.eventName ? String(item.eventName) : '';
    if (subtitle) {
      const who = userName ? `${userName}${eventName ? ` ‚Ä¢ ${eventName}` : ''}` : (eventName || '');
      subtitle.textContent = `${who}${who ? ' ‚Ä¢ ' : ''}Total: $${totalPrice.toLocaleString()} ‚Ä¢ Registrado: $${credited.toLocaleString()} ‚Ä¢ Saldo: $${saldo.toLocaleString()}`;
    }

    // Load proof (prefer pending proof)
    const proofs = (proofsByTx && tx && proofsByTx[tx]) ? proofsByTx[tx] : [];
    const pendingProofs = (Array.isArray(proofs) ? proofs : [])
      .filter((p) => String(p?.status || 'pending').toLowerCase() !== 'rejected')
      .sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));
    const proof = pendingProofs.length ? pendingProofs[0] : ((Array.isArray(proofs) && proofs.length) ? proofs[0] : null);
    adminPagoCtx.proofId = proof?.id != null ? Number(proof.id) : 0;

    // Proof image + meta
    const proofUrl = proof && proof.url ? String(proof.url) : '';
    if (proofUrl && img && link && empty) {
      img.src = proofUrl;
      link.href = proofUrl;
      link.classList.remove('hidden');
      img.classList.remove('hidden');
      empty.classList.add('hidden');
    } else {
      if (img) img.classList.add('hidden');
      if (link) link.classList.add('hidden');
      if (empty) empty.classList.remove('hidden');
    }

    const kind = proof ? String(proof.kind || '').toUpperCase() : '';
    const createdAt = proof ? new Date(proof.createdAt).toLocaleString('es-CO') : '';
    const amt = proof && proof.amount != null ? Number(proof.amount) : null;

    if (meta) meta.textContent = `${kind || 'COMPROBANTE'}${createdAt ? ` ‚Ä¢ ${createdAt}` : ''}`;
    if (amtEl) amtEl.textContent = amt != null && Number.isFinite(amt) && amt > 0 ? `$${amt.toLocaleString()}` : '';

    setAdminPagoStatus('');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  // Format currency helper
  function formatCurrency(val) {
    if (val === null || val === undefined || isNaN(val)) return '-';
    return Number(val).toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
  }

  // Include existing renderTransactionCard function (enhanced with lupita)
  function renderTransactionCard(tx) {
    const urgency = tx?.urgency || {};
    const proofAnalysis = tx?.proofAnalysis || {};
    const proofStats = tx?.proofStats || {};
    const promo = tx?.promo || {};
    
    // Determine urgency styles
    const getUrgencyStyles = (urgency) => {
      if (urgency.urgencyScore >= 1000) {
        return { border: 'border-red-500', bg: 'bg-red-50' };
      } else if (urgency.urgencyScore >= 500) {
        return { border: 'border-orange-500', bg: 'bg-orange-50' };
      } else if (urgency.urgencyScore >= 100) {
        return { border: 'border-amber-500', bg: 'bg-amber-50' };
      }
      return { border: 'border-gray-200', bg: 'bg-white' };
    };
    
    const urgencyStyles = getUrgencyStyles(urgency);
    
    // Check for active reservations
    const hasActiveReservation = tx?.numbers?.some((n: any) => 
      String(n?.estado || '').toLowerCase() === 'reservado' && n?.reservedAt
    );
    
    // Format time remaining
    const formatTimeRemaining = (timeToExpiry) => {
      if (!timeToExpiry) return '';
      const minutes = Math.floor(timeToExpiry / (1000 * 60));
      if (minutes < 60) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      return `${hours}h ${remainingMinutes}m`;
    };
    
    // Generate proof button HTML (lupita)
    const getProofButtonHtml = (txNum) => {
      const proofs = tx?.proofs || [];
      const pendingCount = proofs.filter((p: any) => 
        String(p?.status || 'pending').toLowerCase() === 'pending'
      ).length;
      
      if (pendingCount === 0) {
        return `
          <button type="button" class="proof-history-btn inline-flex items-center justify-center px-3 h-9 rounded-xl border border-emerald-200 bg-emerald-50 hover:bg-emerald-100 transition" data-tx="${txNum}" title="Comprobantes al d√≠a">
            <span class="text-emerald-700">üîç</span>
            <span class="ml-2 text-xs text-emerald-700 font-bold">‚úì</span>
          </button>
        `;
      }
      return `
        <button type="button" class="proof-history-btn inline-flex items-center justify-center px-3 h-9 rounded-xl border border-rose-200 bg-rose-50 hover:bg-rose-100 transition" data-tx="${txNum}" title="Comprobantes pendientes: ${pendingCount}">
          <span class="text-rose-700">üîç</span>
          <span class="ml-2 text-xs text-rose-700/90 font-bold">${pendingCount}</span>
        </button>
      `;
    };
    
    // Generate countdown HTML
    const getCountdownHtml = () => {
      if (!hasActiveReservation) return '';
      
      const reservedNumbers = tx?.numbers?.filter((n: any) => 
        String(n?.estado || '').toLowerCase() === 'reservado' && n?.reservedAt
      ) || [];
      
      if (reservedNumbers.length === 0) return '';
      
      // Find earliest expiry
      const now = Date.now();
      const RESERVATION_TTL_MS = 5 * 60 * 1000; // 5 minutes
      let earliestExpiry = null;
      
      reservedNumbers.forEach((n: any) => {
        if (n.reservedAt) {
          const expiryTime = Date.parse(String(n.reservedAt)) + RESERVATION_TTL_MS;
          if (!earliestExpiry || expiryTime < earliestExpiry) {
            earliestExpiry = expiryTime;
          }
        }
      });
      
      if (!earliestExpiry) return '';
      
      const expiresAt = new Date(earliestExpiry).toISOString();
      return `<span class="countdown-timer text-xs font-mono text-red-600" data-expires-at="${expiresAt}" data-prefix="‚è∞ ">Cargando...</span>`;
    };
    
    const countdownHtml = getCountdownHtml();
    
    return `
      <div class="${urgencyStyles.bg} border ${urgencyStyles.border} rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-medium text-gray-900">#${tx.transactionNumber}</h3>
            <p class="text-sm text-gray-500">${tx.usuarioNombre}</p>
          </div>
          <div class="flex items-center space-x-2">
            <!-- Proof button (lupita) -->
            ${getProofButtonHtml(tx.transactionNumber)}
            
            <!-- Urgency badges -->
            ${urgency.urgencyScore >= 1000 ? '<span class="badge badge-danger">üî¥ CR√çTICO</span>' : ''}
            ${urgency.urgencyScore >= 500 && urgency.urgencyScore < 1000 ? '<span class="badge badge-warning">üü† URGENTE</span>' : ''}
            ${urgency.urgencyScore >= 100 && urgency.urgencyScore < 500 ? '<span class="badge badge-info">üü° Atenci√≥n</span>' : ''}
          </div>
        </div>
        
        <!-- Countdown timer -->
        ${countdownHtml ? `
          <div class="mt-2 p-2 bg-red-50 rounded text-xs">
            <div class="flex items-center justify-between">
              <span class="text-red-600">‚è∞ Reserva expira en:</span>
              ${countdownHtml}
            </div>
          </div>
        ` : ''}
        
        <!-- Proof information -->
        <div class="mt-3 p-2 bg-gray-50 rounded text-xs">
          <div class="flex items-center justify-between">
            <span class="text-gray-600">üìé Comprobantes:</span>
            <span class="font-medium">
              ${proofStats.pending || 0} pendientes / ${proofStats.validated || 0} validados
            </span>
          </div>
        </div>
        
        <!-- Promo grace period -->
        ${promo.active ? `
          <div class="mt-2 p-2 bg-green-50 rounded text-xs">
            <div class="flex items-center justify-between">
              <span class="text-green-600">üéÅ Per√≠odo gracia promo:</span>
              <span class="font-medium text-green-800">
                ${formatTimeRemaining(urgency.timeToExpiry) || 'Expirando...'}
              </span>
            </div>
          </div>
        ` : ''}
        
        <div class="mt-4">
          <div class="flex justify-between text-sm">
            <span class="text-gray-500">Total:</span>
            <span class="font-medium">$${Number(tx.totalPrice || 0).toLocaleString()}</span>
          </div>
          <div class="flex justify-between text-sm mt-1">
            <span class="text-gray-500">Pagado:</span>
            <span class="font-medium">$${Number(tx.creditedTotal || 0).toLocaleString()}</span>
          </div>
          <div class="flex justify-between text-sm mt-1">
            <span class="text-gray-500">Pendiente:</span>
            <span class="font-medium text-orange-600">$${Number(tx.saldoPendiente || 0).toLocaleString()}</span>
          </div>
        </div>
        
        <div class="mt-4 flex flex-wrap gap-2">
          ${proofAnalysis.suggestedAction === 'validate_payment' ? `
            <button class="btn-primary text-sm">‚úÖ Validar Pago</button>
          ` : ''}
          ${proofAnalysis.suggestedAction === 'validate_abono' ? `
            <button class="btn-primary text-sm">‚úÖ Validar Abono</button>
          ` : ''}
          <button class="btn-secondary text-sm admin-pay" data-tx="${tx.transactionNumber}">
            ÔøΩ Pagar
          </button>
          <button class="btn-secondary text-sm admin-abono" data-tx="${tx.transactionNumber}">
            üí∞ Abonar
          </button>
        </div>
      </div>
    `;
  }
</script>
