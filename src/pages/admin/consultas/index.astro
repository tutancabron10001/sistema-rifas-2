---
import "../../../styles/global.css";
import { db } from '../../../db/client';
import { campaigns, events } from '../../../db/schema';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import StatCard from '../../../components/admin/StatCard.astro';
import DataTable from '../../../components/admin/DataTable.astro';
import Modal from '../../../components/admin/Modal.astro';

// Verificar autenticaci√≥n
if (!Astro.cookies.has("admin_session")) {
  return Astro.redirect("/admin/login");
}

const campaignList = await db.select().from(campaigns).orderBy(campaigns.createdAt);
const eventList = await db.select().from(events).orderBy(events.createdAt);

// Get current page from URL
const url = Astro.url;
const urlParams = new URLSearchParams(url.search);
const mode = urlParams.get('mode') || 'admin';
const currentPage = mode === 'admin' ? 'consultas-admin' : 
                   mode === 'pago' ? 'consultas-pago' : 
                   mode === 'pagos' ? 'consultas-pagos' : 
                   mode === 'estados' ? 'consultas-estados' : 'consultas-admin';
---

<AdminLayout title="Consultas" currentPage={currentPage}>
  <!-- Page Header -->
  <div class="bg-white shadow-sm border-b border-gray-200">
    <div class="px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div>
          <nav class="flex" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
              <li>
                <a href="/admin" class="text-gray-400 hover:text-gray-500">
                  <svg class="flex-shrink-0 h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                  </svg>
                </a>
              </li>
              <li>
                <div class="flex items-center">
                  <svg class="flex-shrink-0 h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  <span class="ml-2 text-sm font-medium text-gray-500">Consultas</span>
                </div>
              </li>
            </ol>
          </nav>
          <h1 class="mt-2 text-2xl font-bold text-gray-900" id="pageTitle">üìã Consultas Administrativas</h1>
          <p class="mt-1 text-sm text-gray-500" id="pageDescription">Gestiona transacciones pendientes y comprobantes por validar</p>
        </div>
        <div class="flex items-center space-x-3">
          <button class="btn-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nueva Transacci√≥n
          </button>
          <button class="btn-secondary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Exportar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="px-4 sm:px-6 lg:px-8 py-8">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <StatCard 
        title="Transacciones Pendientes" 
        value="24" 
        icon="pending-icon" 
        color="yellow"
        trend={{ value: "12% vs mes anterior", direction: "up" }}
      />
      <StatCard 
        title="Comprobantes por Validar" 
        value="47" 
        icon="document-icon" 
        color="red"
        trend={{ value: "8% vs mes anterior", direction: "up" }}
      />
      <StatCard 
        title="Monto por Procesar" 
        value="$2,450,000" 
        icon="money-icon" 
        color="green"
        trend={{ value: "5% vs mes anterior", direction: "down" }}
      />
      <StatCard 
        title="Transacciones Urgentes" 
        value="8" 
        icon="alert-icon" 
        color="red"
        trend={{ value: "3 nuevas hoy", direction: "up" }}
      />
    </div>

    <!-- Actions Section -->
    <div class="bg-white rounded-lg shadow mb-8">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-medium text-gray-900">Acciones Sugeridas</h2>
        <p class="mt-1 text-sm text-gray-500">Usa la üîç para ver comprobantes ‚Ä¢ Pagar/Abonar al final</p>
      </div>
      <div class="p-6">
        <div id="pendingActionsList" class="space-y-4">
          <!-- Dynamic content will be loaded here -->
          <div class="text-center py-8 text-gray-500">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <p class="mt-2">Cargando acciones pendientes...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-medium text-gray-900">Transacciones Recientes</h2>
          <div class="flex items-center space-x-3">
            <input type="text" 
                   placeholder="Buscar transacci√≥n..." 
                   class="block w-64 px-3 py-2 border border-gray-300 rounded-md text-sm leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            <select class="block px-3 py-2 border border-gray-300 rounded-md text-sm leading-5 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
              <option>Todos los estados</option>
              <option>Pendiente</option>
              <option>Validado</option>
              <option>Rechazado</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="transactionsTableContainer">
        <!-- Table will be dynamically loaded here -->
        <div class="p-6 text-center text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <p class="mt-2">Cargando transacciones...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Proof History Modal -->
  <Modal id="proofHistoryModal" title="Hist√≥rico de Comprobantes" size="xl">
    <div class="grid grid-cols-2 gap-4">
      <!-- Proof cards will be loaded here -->
    </div>
  </Modal>

  <!-- Admin Abono Modal -->
  <Modal id="adminAbonoModal" title="Registrar Abono" size="lg">
    <form id="adminAbonoForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Monto del Abono</label>
        <input type="number" 
               name="amount" 
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Comprobante</label>
        <input type="file" 
               name="proof" 
               accept="image/*"
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" 
                onclick="closeModal('adminAbonoModal')"
                class="btn-secondary">
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          Registrar Abono
        </button>
      </div>
    </form>
  </Modal>

  <!-- Admin Pago Modal -->
  <Modal id="adminPagoModal" title="Registrar Pago" size="lg">
    <form id="adminPagoForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Monto del Pago</label>
        <input type="number" 
               name="amount" 
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Comprobante</label>
        <input type="file" 
               name="proof" 
               accept="image/*"
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
      </div>
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" 
                onclick="closeModal('adminPagoModal')"
                class="btn-secondary">
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          Registrar Pago
        </button>
      </div>
    </form>
  </Modal>

</AdminLayout>

<script>
  // Global variables
  let currentMode = 'admin';
  let pendingData = [];
  let currentPage = 1;
  const itemsPerPage = 10;

  // Get URL parameters
  function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // Update page content based on mode
  function updatePageContent(mode) {
    const pageTitle = document.getElementById('pageTitle');
    const pageDescription = document.getElementById('pageDescription');
    
    const pageConfig = {
      'admin': {
        title: '‚úÖ Pendientes del Administrador',
        description: 'Resumen de transacciones con comprobantes pendientes y acciones para registrar pagos/abonos.'
      },
      'pago': {
        title: 'üí≥ Pendientes de Pago',
        description: 'Transacciones que requieren confirmaci√≥n de pago por parte de los usuarios.'
      },
      'pagos': {
        title: 'üí∞ Pagos',
        description: 'Historial de pagos completados y confirmados en el sistema.'
      },
      'estados': {
        title: 'üìä Estados Financieros',
        description: 'Resumen financiero general del sistema de rifas.'
      }
    };
    
    const config = pageConfig[mode] || pageConfig['admin'];
    pageTitle.textContent = config.title;
    pageDescription.textContent = config.description;
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Get mode from URL parameter
    const urlMode = getUrlParameter('mode') || 'admin';
    currentMode = urlMode;
    
    // Update page content
    updatePageContent(currentMode);
    
    // Load data
    loadPendingActions(currentMode);
  });

  // Setup event listeners
  function setupEventListeners() {
    // No need for tab listeners since they're in sidebar now
  }

  // Load pending actions (existing function)
  async function loadPendingActions(mode) {
    try {
      const response = await fetch(`/api/admin/pending-actions?mode=${mode}`);
      const data = await response.json();
      
      if (data.success) {
        pendingData = data.items || [];
        renderPendingActions(pendingData);
        renderTransactionsTable(pendingData);
        updateStatistics(data);
      } else {
        console.error('Error loading pending actions:', data.error);
      }
    } catch (error) {
      console.error('Error:', error);
    }
  }

  // Render pending actions
  function renderPendingActions(items) {
    const container = document.getElementById('pendingActionsList');
    
    if (!items || items.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="mt-2">No hay acciones pendientes</p>
        </div>
      `;
      return;
    }

    // Use existing renderTransactionCard logic but with new styling
    container.innerHTML = items.map(item => renderTransactionCard(item)).join('');
  }

  // Render transactions table
  function renderTransactionsTable(items) {
    const container = document.getElementById('transactionsTableContainer');
    
    if (!items || items.length === 0) {
      container.innerHTML = `
        <div class="p-6 text-center text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <p class="mt-2">No hay transacciones disponibles</p>
        </div>
      `;
      return;
    }

    const tableHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Transacci√≥n
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Participante
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Evento
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Total
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Pagado
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Pendiente
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Acciones
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            ${items.map(item => `
              <tr class="hover:bg-gray-50 transition-colors duration-150">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  #${item.transactionNumber || '‚Äî'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  ${item.usuarioNombre || 'Usuario'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  ${item.eventName || 'Evento'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                  $${Number(item.totalPrice || 0).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                  $${Number(item.creditedTotal || 0).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                  $${Number(item.saldoPendiente || 0).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <div class="flex items-center justify-end space-x-2">
                    <button onclick="viewTransaction('${item.transactionNumber}')" 
                            class="text-indigo-600 hover:text-indigo-900 transition-colors duration-150"
                            title="Ver detalles">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </button>
                    <button onclick="validateTransaction('${item.transactionNumber}')" 
                            class="text-green-600 hover:text-green-900 transition-colors duration-150"
                            title="Validar">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;

    container.innerHTML = tableHTML;
  }

  // Update statistics
  function updateStatistics(data) {
    const stats = data.statistics || {};
    
    // Update the stat cards if they exist
    const statCards = document.querySelectorAll('.stat-card');
    if (statCards.length >= 4) {
      statCards[0].querySelector('.text-2xl').textContent = stats.pendingTransactions || '0';
      statCards[1].querySelector('.text-2xl').textContent = stats.pendingProofs || '0';
      statCards[2].querySelector('.text-2xl').textContent = `$${Number(stats.pendingAmount || 0).toLocaleString()}`;
      statCards[3].querySelector('.text-2xl').textContent = stats.urgentTransactions || '0';
    }
  }

  // Action handlers
  function viewTransaction(txNumber) {
    console.log('View transaction:', txNumber);
    openModal('proofHistoryModal');
  }

  function validateTransaction(txNumber) {
    console.log('Validate transaction:', txNumber);
    // Implement validation logic
  }

  // Include existing renderTransactionCard function (simplified)
  function renderTransactionCard(tx) {
    const urgency = tx?.urgency || {};
    const proofAnalysis = tx?.proofAnalysis || {};
    
    // Determine urgency styles
    const getUrgencyStyles = (urgency) => {
      if (urgency.urgencyScore >= 1000) {
        return { border: 'border-red-500', bg: 'bg-red-50' };
      } else if (urgency.urgencyScore >= 500) {
        return { border: 'border-orange-500', bg: 'bg-orange-50' };
      } else if (urgency.urgencyScore >= 100) {
        return { border: 'border-amber-500', bg: 'bg-amber-50' };
      }
      return { border: 'border-gray-200', bg: 'bg-white' };
    };
    
    const urgencyStyles = getUrgencyStyles(urgency);
    
    return `
      <div class="${urgencyStyles.bg} border ${urgencyStyles.border} rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-medium text-gray-900">#${tx.transactionNumber}</h3>
            <p class="text-sm text-gray-500">${tx.usuarioNombre}</p>
          </div>
          <div class="flex items-center space-x-2">
            ${urgency.urgencyScore >= 1000 ? '<span class="badge badge-danger">üî¥ CR√çTICO</span>' : ''}
            ${urgency.urgencyScore >= 500 && urgency.urgencyScore < 1000 ? '<span class="badge badge-warning">üü† URGENTE</span>' : ''}
            ${urgency.urgencyScore >= 100 && urgency.urgencyScore < 500 ? '<span class="badge badge-info">üü° Atenci√≥n</span>' : ''}
          </div>
        </div>
        <div class="mt-4">
          <div class="flex justify-between text-sm">
            <span class="text-gray-500">Total:</span>
            <span class="font-medium">$${Number(tx.totalPrice || 0).toLocaleString()}</span>
          </div>
          <div class="flex justify-between text-sm mt-1">
            <span class="text-gray-500">Pagado:</span>
            <span class="font-medium">$${Number(tx.creditedTotal || 0).toLocaleString()}</span>
          </div>
        </div>
        <div class="mt-4 flex space-x-2">
          ${proofAnalysis.suggestedAction === 'validate_payment' ? `
            <button class="btn-primary text-sm">‚úÖ Validar Pago</button>
          ` : ''}
          ${proofAnalysis.suggestedAction === 'validate_abono' ? `
            <button class="btn-primary text-sm">‚úÖ Validar Abono</button>
          ` : ''}
          <button class="btn-secondary text-sm">üí≥ Pagar</button>
          <button class="btn-secondary text-sm">üí∞ Abonar</button>
        </div>
      </div>
    `;
  }
</script>
