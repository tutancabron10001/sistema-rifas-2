---
import "../../styles/global.css";
import { db } from '../../db/client';
import { campaigns, events } from '../../db/schema';

console.log('DEBUG - Env vars:');
console.log('TURSO_CONNECTION_URL:', process.env.TURSO_CONNECTION_URL ? '‚úì Set' : '‚úó Missing');
console.log('TURSO_AUTH_TOKEN:', process.env.TURSO_AUTH_TOKEN ? '‚úì Set' : '‚úó Missing');

let list: any[] = [];
const eventsByCampaign = new Map<number, any>();

try {
  list = await db.select().from(campaigns).orderBy(campaigns.createdAt);
  const eventRows = await db.select().from(events);
  for (const ev of eventRows) {
    if (!eventsByCampaign.has(ev.campaignId)) {
      eventsByCampaign.set(ev.campaignId, ev);
    }
  }
} catch (error) {
  console.error('ERROR fetching DB:', error);
  throw error;
}
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eventos ‚Äî Sistema de Rifas</title>
    <style>
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .event-card {
        animation: fadeIn 0.6s ease-out;
      }

      .nav-button {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .nav-button:hover {
        transform: scale(1.1);
      }

      .nav-button:active {
        transform: scale(0.95);
      }

      .price-badge {
        backdrop-filter: blur(10px);
        animation: fadeIn 0.8s ease-out 0.2s both;
      }

      /* Modal animation - solo el contenedor interno */
      @keyframes slideUp {
        from { 
          opacity: 0;
          transform: translateY(100%);
        }
        to { 
          opacity: 1;
          transform: translateY(0);
        }
      }
      .modal-content.show {
        animation: slideUp 0.4s ease-out;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-rose-50 via-sky-50 to-white text-slate-900 overflow-x-hidden">
    <!-- Animated background elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute top-1/4 -left-48 w-96 h-96 bg-rose-200/50 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-1/4 -right-48 w-96 h-96 bg-sky-200/45 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <!-- Header -->
    <header class="absolute top-0 left-0 right-0 z-10 p-6">
      <div class="flex items-center justify-between max-w-7xl mx-auto">
        <a href="/usuario" class="group flex items-center gap-2 text-rose-700 hover:text-rose-900 transition-all duration-300">
          <svg class="w-6 h-6 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="font-medium">Volver</span>
        </a>
        <div class="text-center">
          <h1 class="text-3xl md:text-4xl font-black bg-gradient-to-r from-rose-700 via-fuchsia-700 to-sky-700 bg-clip-text text-transparent">
            Eventos Disponibles
          </h1>
          <p class="text-base text-slate-600 mt-1">Descubre oportunidades incre√≠bles</p>
        </div>
        <div class="w-24"></div>
      </div>
    </header>

    {list.length === 0 ? (
      <main class="min-h-screen flex items-center justify-center">
        <div class="text-center">
          <svg class="w-24 h-24 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
          <p class="text-xl text-slate-700">A√∫n no hay eventos disponibles</p>
          <p class="text-slate-500 mt-2">Vuelve pronto para ver nuevas oportunidades</p>
        </div>
      </main>
    ) : (
      <main class="min-h-screen pt-32 pb-12 px-4">
        <div id="carousel" class="max-w-7xl mx-auto">
          {list.map((c, index) => {
            const evento = eventsByCampaign.get(c.id);
            const fechaRifa = evento ? new Date(evento.raffleDate).toLocaleDateString('es-ES', { 
              day: 'numeric', 
              month: 'long', 
              year: 'numeric' 
            }) : null;
            const promoTotal = c.promoPrice ? c.promoPrice * 3 : null;
            
            return (
              <div 
                class="event-card hidden"
                data-index={index}
                id={`event-${index}`}
              >
                <div class="grid md:grid-cols-2 gap-8 items-center">
                  <!-- Image Section -->
                  <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-pink-600 via-rose-500 to-pink-600 rounded-3xl blur-2xl opacity-40 group-hover:opacity-70 transition-opacity duration-500 animate-pulse"></div>
                    
                    <div class="relative bg-gradient-to-br from-rose-200/70 to-sky-200/70 p-1 rounded-3xl backdrop-blur-sm">
                      <div class="relative bg-white/80 p-3 rounded-3xl border border-slate-200">
                        <div class="relative rounded-2xl overflow-hidden shadow-2xl border border-rose-200 transform group-hover:scale-[1.02] transition-all duration-500">
                          {c.imageUrl ? (
                            <img src={c.imageUrl} alt={c.name} class="w-full h-[400px] md:h-[500px] object-cover" />
                          ) : (
                            <div class="w-full h-[400px] md:h-[500px] bg-gradient-to-br from-rose-50 to-sky-50 flex items-center justify-center">
                              <svg class="w-32 h-32 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                              </svg>
                            </div>
                          )}
                          <div class="absolute top-0 left-0 w-16 h-16 border-t-2 border-l-2 border-pink-400/50"></div>
                          <div class="absolute top-0 right-0 w-16 h-16 border-t-2 border-r-2 border-pink-400/50"></div>
                          <div class="absolute bottom-0 left-0 w-16 h-16 border-b-2 border-l-2 border-pink-400/50"></div>
                          <div class="absolute bottom-0 right-0 w-16 h-16 border-b-2 border-r-2 border-pink-400/50"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Info Section -->
                  <div class="space-y-6">
                    <div>
                      <h2 class="text-4xl md:text-5xl font-black mb-4 bg-gradient-to-r from-rose-700 via-fuchsia-700 to-sky-700 bg-clip-text text-transparent leading-tight">
                        {c.name}
                      </h2>
                      {c.description ? (
                        <p class="text-lg text-slate-600 leading-relaxed">{c.description}</p>
                      ) : (
                        <p class="text-slate-500 italic">Sin descripci√≥n</p>
                      )}
                    </div>

                    <!-- Pricing Cards -->
                    <div class="space-y-4">
                      <div class="price-badge bg-white/80 backdrop-blur-xl rounded-2xl p-6 border border-slate-200 shadow-xl hover:border-rose-200 transition-all duration-300">
                        <div class="flex items-center justify-between">
                          <div>
                            <p class="text-sm text-slate-600 uppercase tracking-wider font-semibold mb-1">Precio de Boleta</p>
                            <p class="text-4xl font-black text-slate-900">${c.price.toLocaleString()}</p>
                          </div>
                          <svg class="w-12 h-12 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                      </div>

                      {promoTotal && (
                        <div class="price-badge bg-gradient-to-r from-rose-50 to-fuchsia-50 backdrop-blur-xl rounded-2xl p-6 border border-rose-200 shadow-xl hover:shadow-2xl hover:shadow-rose-500/10 hover:scale-[1.02] transition-all duration-300">
                          <div class="flex items-center justify-between">
                            <div>
                              <p class="text-sm text-rose-700 uppercase tracking-wider font-bold mb-1 flex items-center gap-2">
                                <span class="animate-pulse">üî•</span>
                                Promoci√≥n Especial
                              </p>
                              <p class="text-xl text-slate-700 mb-1">3 boletas por</p>
                              <p class="text-4xl font-black text-transparent bg-gradient-to-r from-rose-700 to-fuchsia-700 bg-clip-text">
                                ${promoTotal.toLocaleString()}
                              </p>
                            </div>
                            <svg class="w-12 h-12 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                            </svg>
                          </div>
                        </div>
                      )}

                      {fechaRifa && (
                        <div class="price-badge bg-white/80 backdrop-blur-xl rounded-2xl p-4 border border-slate-200">
                          <div class="flex items-center gap-3">
                            <svg class="w-8 h-8 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <div>
                              <p class="text-xs text-slate-600 uppercase tracking-wider">Fecha de Rifa</p>
                              <p class="text-lg font-bold text-slate-900">{fechaRifa}</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    <!-- CTA Buttons -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <button 
                        class="participate-btn w-full bg-rose-600 hover:bg-rose-500 text-white font-black py-4 px-8 rounded-2xl shadow-sm hover:shadow-md active:scale-95 transition-all duration-200 text-lg border border-rose-500/20 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2"
                        data-event-id={evento?.id}
                        data-campaign-id={c.id}
                        data-campaign-name={c.name}
                        data-event-name={evento?.name || ''}
                        data-price={c.price}
                        data-promo-price={c.promoPrice}
                        data-numbers-mode={c.numbersMode}
                      >
                        Participar Ahora
                      </button>
                      <button
                        class="payments-btn w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 px-8 rounded-2xl shadow-sm hover:shadow-md active:scale-95 transition-all duration-200 text-lg border border-emerald-500/20 focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:ring-offset-2"
                        data-event-id={evento?.id}
                        data-campaign-id={c.id}
                        data-campaign-name={c.name}
                        data-event-name={evento?.name || ''}
                      >
                        Mis pagos/abonos
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <!-- Navigation -->
        {list.length > 1 && (
          <div class="flex items-center justify-center gap-8 mt-12 relative z-10">
            <button 
              id="prevBtn"
              class="nav-button bg-white/80 hover:bg-white backdrop-blur-xl rounded-full p-4 shadow-lg border border-rose-200 hover:border-rose-300"
              aria-label="Evento anterior"
            >
              <svg class="w-8 h-8 text-rose-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
              </svg>
            </button>

            <div id="indicators" class="flex gap-3">
              {list.map((_, index) => (
                <button
                  class="indicator w-3 h-3 rounded-full transition-all duration-300"
                  data-index={index}
                  aria-label={`Ir al evento ${index + 1}`}
                ></button>
              ))}
            </div>

            <button 
              id="nextBtn"
              class="nav-button bg-white/80 hover:bg-white backdrop-blur-xl rounded-full p-4 shadow-lg border border-rose-200 hover:border-rose-300"
              aria-label="Siguiente evento"
            >
              <svg class="w-8 h-8 text-rose-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        )}
      </main>
    )}

    <!-- Participants Modal -->
    <div id="participantsModal" class="hidden fixed inset-0 app-overlay z-50 flex items-center justify-center p-2 md:p-4">
      <div class="app-modal w-full max-w-[96vw] max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-rose-50 px-4 md:px-8 py-3 md:py-4 flex items-center justify-between border-b border-rose-200">
          <div>
            <h2 class="text-lg md:text-2xl font-black text-slate-900">Participar en Evento</h2>
            <p id="modalEventTitle" class="text-slate-600 text-xs md:text-sm mt-1"></p>
          </div>
          <button onclick="closeParticipantsForm()" class="text-slate-600 hover:text-slate-900 text-xl md:text-2xl font-bold transition-colors">‚úï</button>
        </div>

        <!-- Modal Body -->
        <div class="px-4 md:px-8 py-4 md:py-6 space-y-4 md:space-y-6">
          <!-- Step 1: C√©dula -->
          <div id="cedulaStep" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 uppercase mb-2">C√©dula de Identidad *</label>
              <div class="flex flex-col sm:flex-row gap-2">
                <input 
                  type="text" 
                  id="cedulaInput" 
                  placeholder="Ej: 1234567890"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  autocomplete="off"
                  class="app-input w-full sm:flex-1 min-w-0"
                />
                <button onclick="searchUsuario()" class="w-full sm:w-auto sm:shrink-0 bg-rose-600 hover:bg-rose-500 text-white font-bold px-6 py-3 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-rose-500/20 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2">
                  Buscar
                </button>
              </div>
            </div>
          </div>

          <!-- Step 1.5: Bienvenida (solo si el usuario existe) -->
          <div id="welcomeStep" class="hidden space-y-4">
            <div class="app-surface p-3 md:p-4">
              <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1">
                <span class="text-base md:text-lg font-black text-slate-900">¬°Bienvenido(a)!</span>
                <span id="welcomeUserName" class="text-base md:text-lg font-black text-slate-900"></span>
                <span id="welcomeUserEmail" class="text-sm text-slate-600 break-all"></span>
              </div>
              <!-- Keep IDs for JS (hidden per request) -->
              <div class="hidden">
                <span id="welcomeCampaignName"></span>
                <span id="welcomeEventName"></span>
              </div>
            </div>

            <div class="app-surface-muted p-4 md:p-5">
              <div id="welcomeTxStatus" class="text-xs text-slate-600"></div>
              <div id="welcomeTxList" class="mt-2 -mx-4 px-4 flex gap-3 overflow-x-auto overscroll-x-contain snap-x snap-mandatory scroll-smooth pb-2 min-h-[160px]">
                <div id="welcomeGraceHero" class="hidden snap-start shrink-0 w-full bg-gradient-to-br from-amber-50 to-yellow-50 border border-amber-200 rounded-2xl p-4"></div>
              </div>
              <div class="mt-2 text-[11px] text-slate-500 md:hidden">Desliza para ver tus estados ‚Üí</div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 pt-2">
              <button
                type="button"
                onclick="welcomeEditDatos()"
                class="flex-1 bg-white hover:bg-slate-50 text-slate-800 border border-slate-200 font-bold py-3 px-4 rounded-lg transition-colors"
              >
                Editar mis datos
              </button>
              <button
                type="button"
                onclick="welcomeContinue()"
                class="flex-1 text-center bg-rose-600 hover:bg-rose-500 text-white font-bold py-3 px-4 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-rose-500/20 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2"
              >
                Seguir al evento
              </button>
            </div>

            <button
              type="button"
              onclick="backToSearch()"
              class="w-full text-sm font-semibold text-slate-700 hover:text-slate-900 bg-white hover:bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 transition"
            >
              Cambiar c√©dula
            </button>
          </div>

          <!-- Step 2: Formulario de Datos -->
          <form id="participantForm" onsubmit="handleFormSubmit(event)" class="hidden space-y-4">
            <input type="hidden" id="usuarioId" value="">
            <input type="hidden" id="cedula" value="">

            <div class="grid md:grid-cols-2 gap-4">
              <!-- Primer Nombre -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Primer Nombre *</label>
                <input 
                  type="text" 
                  id="primerNombre" 
                  required
                  class="app-input w-full"
                />
              </div>

              <!-- Segundo Nombre -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Segundo Nombre</label>
                <input 
                  type="text" 
                  id="segundoNombre"
                  class="app-input w-full"
                />
              </div>

              <!-- Primer Apellido -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Primer Apellido *</label>
                <input 
                  type="text" 
                  id="primerApellido" 
                  required
                  class="app-input w-full"
                />
              </div>

              <!-- Segundo Apellido -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Segundo Apellido *</label>
                <input 
                  type="text" 
                  id="segundoApellido" 
                  required
                  class="app-input w-full"
                />
              </div>

              <!-- Fecha de Nacimiento -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Fecha de Nacimiento</label>
                <input 
                  type="date" 
                  id="fechaNacimiento"
                  max={new Date().toISOString().split('T')[0]}
                  class="app-input w-full"
                />
              </div>

              <!-- Departamento -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Departamento</label>
                <select
                  id="departamento"
                  class="app-input w-full"
                >
                  <option value="">Seleccionar</option>
                  <option>Antioquia</option>
                  <option>Atl√°ntico</option>
                  <option>Bogot√° D.C.</option>
                  <option>Bol√≠var</option>
                  <option>Boyac√°</option>
                  <option>Caldas</option>
                  <option>Caquet√°</option>
                  <option>Cauca</option>
                  <option>Cesar</option>
                  <option>C√≥rdoba</option>
                  <option>Cundinamarca</option>
                  <option>Choc√≥</option>
                  <option>Huila</option>
                  <option>La Guajira</option>
                  <option>Magdalena</option>
                  <option>Meta</option>
                  <option>Nari√±o</option>
                  <option>Norte de Santander</option>
                  <option>Quind√≠o</option>
                  <option>Risaralda</option>
                  <option>Santander</option>
                  <option>Sucre</option>
                  <option>Tolima</option>
                  <option>Valle del Cauca</option>
                  <option>Arauca</option>
                  <option>Casanare</option>
                  <option>Putumayo</option>
                  <option>San Andr√©s</option>
                  <option>Amazonas</option>
                  <option>Guain√≠a</option>
                  <option>Guaviare</option>
                  <option>Vaup√©s</option>
                  <option>Vichada</option>
                </select>
              </div>

              <!-- Ciudad -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Ciudad</label>
                <input 
                  type="text" 
                  id="ciudad"
                  placeholder="Nombre de la ciudad"
                  class="app-input w-full"
                />
              </div>

              <!-- Correo -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Correo Electr√≥nico</label>
                <input 
                  type="email" 
                  id="correoElectronico"
                  class="app-input w-full"
                />
              </div>

              <!-- Tel√©fono -->
              <div class="md:col-span-2">
                <label class="block text-sm font-semibold text-slate-700 uppercase mb-1">Tel√©fono (+57)</label>
                <input 
                  type="tel" 
                  id="telefono"
                  placeholder="+57 3001234567"
                  class="app-input w-full"
                />
              </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-3 pt-4">
              <button 
                type="button" 
                onclick="backToSearch()" 
                class="flex-1 bg-white hover:bg-slate-50 text-slate-800 border border-slate-200 font-bold py-3 px-4 rounded-lg transition-colors"
              >
                Atr√°s
              </button>
              <button 
                type="submit" 
                class="flex-1 bg-rose-600 hover:bg-rose-500 text-white font-bold py-3 px-4 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-rose-500/20 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2"
              >
                Continuar
              </button>
            </div>
          </form>

          <!-- Step 3: Seleccionar N√∫meros -->
          <div id="numbersStep" class="hidden">
            <!-- 2-second promo toast (used during number selection) -->
            <div id="promoToast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-[10000] max-w-[92vw] md:max-w-xl px-4 py-2 rounded-xl bg-white/95 border border-slate-200 text-slate-900 text-sm font-semibold backdrop-blur-md shadow-2xl"></div>

            <div class="md:grid md:grid-cols-2 md:gap-6">
              <!-- LEFT: selection UI -->
              <div class="space-y-6">
                <div class="hidden md:block app-surface p-4">
                  <h3 class="text-lg font-bold text-slate-700 mb-2">Evento Seleccionado</h3>
                  <p class="text-slate-700 text-sm"><span class="font-semibold">Campa√±a:</span> <span id="numEventsCampaign"></span></p>
                  <p class="text-slate-700 text-sm"><span class="font-semibold">Evento:</span> <span id="numEventsName"></span></p>
                  <p class="text-slate-700 text-sm"><span class="font-semibold">Participante:</span> <span id="numEventsParticipant"></span></p>
                </div>

                <!-- Search Number -->
                <div class="mb-4">
                  <button
                    id="searchToggleBtn"
                    type="button"
                    onclick="onSearchButtonClick()"
                    class="w-full sm:w-auto bg-sky-600 hover:bg-sky-500 text-white font-bold px-6 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-sky-500/20 focus:outline-none focus:ring-2 focus:ring-sky-300 focus:ring-offset-2"
                  >
                    üîé Buscar n√∫mero
                  </button>

                  <div id="searchPanel" class="mt-3 hidden">
                    <label class="block text-sm font-semibold text-slate-700 uppercase mb-2">Buscar N√∫mero</label>
                    <input 
                      type="text" 
                      id="searchNumber"
                      placeholder="Ej: 0007"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      autocomplete="off"
                      class="app-input w-full"
                    />
                    <div id="searchResult" class="mt-2 hidden"></div>
                  </div>
                </div>

                <!-- Numbers Grid -->
                <div class="mb-6">
                  <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-2">
                    <label class="text-sm font-semibold text-slate-700 uppercase">N√∫meros Disponibles (400 aleatorios)</label>
                    <div class="flex w-full md:w-auto gap-2">
                      <!-- Mobile: inline summary button (never overlays grid/buttons) -->
                      <button 
                        id="summaryFloatingBtn" 
                        class="hidden md:hidden flex-1 bg-rose-600 hover:bg-rose-500 text-white font-bold px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-rose-500/20 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2 flex items-center justify-center gap-2"
                        type="button"
                      >
                        <span>üí∞ Ver resumen</span>
                        <span id="summaryCount" class="bg-white/20 px-2 py-0.5 rounded-full text-xs font-black">0</span>
                      </button>

                      <button onclick="refreshNumbers()" type="button" class="flex-1 md:flex-none bg-sky-600 hover:bg-sky-500 text-white font-bold px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-sky-500/20 focus:outline-none focus:ring-2 focus:ring-sky-300 focus:ring-offset-2 text-sm">
                        üîÑ Actualizar
                      </button>
                    </div>
                  </div>
                  <div id="numbersGrid" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-12 gap-1 max-h-[400px] md:max-h-[500px] overflow-y-auto p-2 md:p-3 bg-white/70 border border-slate-200 rounded-lg">
                    <!-- Numbers will be populated here -->
                  </div>
                </div>

              </div>

              <!-- RIGHT: summary (desktop inline) + mobile bottom sheet -->
              <div class="min-w-0">
                <div id="selectedNumbersSection" style="display: none;" class="fixed inset-0 z-[9999] bg-slate-900/25 backdrop-blur-sm flex items-end justify-center md:static md:z-0 md:bg-transparent md:backdrop-blur-none md:block">
                  <div class="modal-content w-full max-h-[90vh] overflow-y-auto bg-white/95 backdrop-blur-xl p-4 rounded-t-3xl border-t border-slate-200 shadow-2xl shadow-rose-500/10 md:rounded-3xl md:border md:border-slate-200 md:max-h-[calc(90vh-6rem)] md:sticky md:top-6">
                    <div class="flex items-center justify-between mb-3 md:mb-4">
                      <p id="summaryTitle" class="text-slate-900 font-black text-lg md:text-2xl">üí∞ Resumen de Compra</p>
                      <button id="summaryCloseBtn" type="button" class="text-rose-600 hover:text-rose-700 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>

                    <div id="summaryMainView">
                      <div class="md:grid md:grid-cols-2 md:gap-6">
                        <div class="min-w-0">
                          <!-- Selected Numbers -->
                          <div class="mb-4 md:mb-5">
                            <p class="text-slate-700 text-sm uppercase mb-2 font-bold tracking-wide">N√∫meros Seleccionados</p>
                            <div id="selectedNumbersList" class="flex flex-wrap gap-1.5 md:gap-2 max-h-24 md:max-h-[55vh] overflow-y-auto pb-2"></div>
                          </div>

                          <!-- Transaction breakdown (logical grouping during promo grace) -->
                          <div id="txBreakdownSection" class="hidden mb-4 md:mb-5 bg-rose-50 p-3 md:p-4 rounded-xl md:rounded-2xl border border-rose-200">
                            <p class="text-slate-700 text-sm uppercase mb-2 font-bold tracking-wide">Resumen por transacci√≥n</p>
                            <div id="txBreakdownList" class="space-y-1 text-sm text-slate-700"></div>
                          </div>
                        </div>

                        <div class="min-w-0 md:border-l md:border-slate-200 md:pl-6">
                          <!-- Details Grid -->
                          <div class="space-y-2 mb-4 md:mb-5 border-t md:border-t-0 border-slate-200 pt-3 md:pt-0">
                            <div class="flex justify-between text-base">
                              <span class="text-slate-700">Cantidad:</span>
                              <span id="totalQuantity" class="font-black text-slate-900">0</span>
                            </div>
                            <div class="flex justify-between text-base">
                              <span class="text-slate-700">Promociones:</span>
                              <span id="totalPromos" class="font-black text-amber-700">0</span>
                            </div>
                            <div class="flex justify-between text-base">
                              <span class="text-slate-700">Normal:</span>
                              <span class="font-black text-slate-900">$<span id="normalPrice">0</span></span>
                            </div>
                            <div class="flex justify-between text-base">
                              <span class="text-slate-700">Promo:</span>
                              <span class="font-black text-amber-700">$<span id="promoPrice">0</span></span>
                            </div>
                          </div>

                          <!-- Total -->
                          <div class="bg-gradient-to-r from-rose-50 to-fuchsia-50 p-4 rounded-2xl border border-rose-200 mb-4">
                            <p class="text-slate-700 text-sm uppercase mb-2 font-bold tracking-wide">Total a pagar</p>
                            <p id="totalPrice" class="font-black text-3xl md:text-4xl text-rose-700">$0</p>
                          </div>

                          <!-- Checkout options: Reserva / Pago / Abono -->
                          <div class="bg-white/70 p-4 rounded-2xl border border-slate-200 mb-4">
                            <div id="promoBanner" class="hidden mb-3 rounded-xl border border-amber-200 bg-amber-50 p-3">
                              <div class="text-sm font-black text-amber-800">Promoci√≥n activa</div>
                              <div id="promoBannerText" class="text-sm text-amber-700/80 mt-1"></div>
                            </div>

                            <p class="text-slate-700 text-sm uppercase mb-2 font-bold tracking-wide">¬øQu√© vas a registrar?</p>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                              <label class="min-w-0 flex items-start md:items-center gap-2 bg-white border border-slate-200 rounded-lg px-2.5 py-2">
                                <input id="checkoutReserva" type="radio" name="checkoutAction" value="reserva" class="accent-pink-500" checked />
                                <span class="min-w-0 leading-tight">
                                  <span class="block text-sm font-medium text-slate-800">Reserva</span>
                                  <span class="block text-xs text-slate-500 md:hidden">Sin comprobante</span>
                                </span>
                              </label>
                              <label class="min-w-0 flex items-start md:items-center gap-2 bg-white border border-slate-200 rounded-lg px-2.5 py-2">
                                <input id="checkoutPago" type="radio" name="checkoutAction" value="pago" class="accent-pink-500" />
                                <span class="min-w-0 leading-tight">
                                  <span class="block text-sm font-medium text-slate-800">Pago</span>
                                  <span class="block text-xs text-slate-500 md:hidden">Completo + comprobante</span>
                                </span>
                              </label>
                              <label class="min-w-0 flex items-start md:items-center gap-2 bg-white border border-slate-200 rounded-lg px-2.5 py-2">
                                <input id="checkoutAbono" type="radio" name="checkoutAction" value="abono" class="accent-pink-500" />
                                <span class="min-w-0 leading-tight">
                                  <span class="block text-sm font-medium text-slate-800">Abono</span>
                                  <span class="block text-xs text-slate-500 md:hidden">Parcial + comprobante</span>
                                </span>
                              </label>
                            </div>

                            <div id="proofSection" class="hidden space-y-3">
                              <!-- Abono profesional: monto global + detalle de distribuci√≥n -->
                              <div id="abonoGlobalRow" class="hidden">
                                <label class="block text-sm text-slate-700 mb-1">Monto del abono (COP)</label>
                                <input
                                  id="abonoGlobalAmount"
                                  type="number"
                                  inputmode="numeric"
                                  min="0"
                                  step="1000"
                                  placeholder="Ej: 20000"
                                  class="app-input w-full"
                                />
                                <div id="abonoGlobalHint" class="text-sm text-slate-500 mt-1"></div>
                                <button
                                  id="abonoDetailBtn"
                                  type="button"
                                  class="mt-2 w-full bg-white hover:bg-slate-50 border border-slate-200 text-slate-800 font-semibold py-2 rounded-lg"
                                >
                                  Ver detalle de abono
                                </button>

                                <div id="abonoRecap" class="hidden mt-2 bg-rose-50 border border-rose-200 rounded-xl p-3">
                                  <div class="text-sm text-slate-800 font-semibold">Detalle confirmado</div>
                                  <div id="abonoRecapList" class="mt-2 space-y-1 text-sm text-slate-700"></div>
                                </div>
                              </div>

                              <!-- Legacy single-tx input (kept for compatibility; hidden when using abono global) -->
                              <div id="proofAmountRow" class="hidden">
                                <label class="block text-sm text-slate-700 mb-1">Monto de abono (COP)</label>
                                <input
                                  id="proofAmount"
                                  type="number"
                                  inputmode="numeric"
                                  min="0"
                                  step="1000"
                                  placeholder="Ej: 10000"
                                  class="app-input w-full"
                                />
                                <div id="proofAmountHint" class="text-sm text-slate-500 mt-1"></div>
                              </div>

                              <div>
                                <label class="block text-sm text-slate-700 mb-1">Imagen del comprobante</label>
                                <input
                                  id="proofFile"
                                  type="file"
                                  accept="image/*"
                                  class="w-full text-sm text-slate-700 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-rose-600 file:text-white hover:file:bg-rose-500"
                                />
                              </div>

                              <div id="checkoutMessage" class="hidden text-sm rounded-lg p-2 border"></div>
                            </div>
                          </div>

                          <!-- Action Buttons -->
                          <div class="flex md:flex-col gap-2 md:gap-3">
                            <button 
                              type="button" 
                              onclick="backToForm()" 
                              class="flex-1 md:w-full bg-white hover:bg-slate-50 text-slate-800 border border-slate-200 font-bold py-2 px-3 md:px-4 rounded-lg transition-colors text-sm"
                            >
                              Atr√°s
                            </button>
                            <button 
                              type="button" 
                              onclick="onConfirmCheckout()" 
                              class="selectNumberBtn flex-1 md:w-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-200 disabled:text-slate-400 disabled:border-slate-200 disabled:cursor-not-allowed text-white font-bold py-2 px-3 md:px-4 rounded-lg border border-emerald-500/30 transition-colors duration-200 text-sm"
                              disabled
                            >
                              Confirmar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Abono detail view (2nd step) -->
                    <div id="abonoDetailView" class="hidden">
                      <div class="bg-white/80 border border-slate-200 rounded-2xl p-4 space-y-3">
                        <div class="text-slate-900 font-bold">Detalle de abono</div>
                        <div class="text-sm text-slate-600">Aqu√≠ confirmas c√≥mo se distribuye el abono por operaci√≥n (transacci√≥n) y los n√∫meros involucrados.</div>

                        <div class="bg-rose-50 border border-rose-200 rounded-xl p-3">
                          <div class="flex items-center justify-between">
                            <div class="text-sm text-slate-700 font-semibold">Abono m√≠nimo global</div>
                            <div id="abonoDetailGlobalMin" class="text-sm text-rose-700 font-black">$0</div>
                          </div>
                          <div class="flex items-center justify-between mt-1">
                            <div class="text-sm text-slate-700 font-semibold">Abono que vas a registrar</div>
                            <div id="abonoDetailGlobalAmount" class="text-sm text-rose-700 font-black">$0</div>
                          </div>
                          <div class="flex items-center justify-between mt-1">
                            <div class="text-sm text-slate-700 font-semibold">Excedente</div>
                            <div id="abonoDetailExcess" class="text-sm font-black text-amber-700">$0</div>
                          </div>
                          <div id="abonoDetailRemaining" class="text-xs text-slate-500 mt-2"></div>
                          <div class="mt-2 flex gap-2">
                            <select id="abonoExcessTarget" class="app-input flex-1 text-sm">
                            </select>
                            <button id="abonoApplyExcessBtn" type="button" class="px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-500 border border-rose-500/20 text-sm text-white font-semibold shadow-sm hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-rose-300 focus:ring-offset-2">Asignar excedente</button>
                          </div>
                          <div class="text-xs text-slate-500 mt-2">Si el abono es mayor al m√≠nimo global, asigna el excedente a una operaci√≥n.</div>
                        </div>

                        <div id="abonoDetailList" class="space-y-2"></div>

                        <div class="flex gap-2 pt-2">
                          <button id="abonoDetailBackBtn" type="button" class="flex-1 bg-white hover:bg-slate-50 text-slate-800 border border-slate-200 font-bold py-2 rounded-lg">Volver</button>
                          <button id="abonoDetailConfirmBtn" type="button" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-emerald-500/20 focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:ring-offset-2">Confirmar detalle</button>
                        </div>
                        <div id="abonoDetailError" class="hidden text-sm rounded-lg p-2 border bg-red-900/30 border-red-500/30 text-red-200"></div>
                      </div>
                    </div>

                    <!-- Checkout success view -->
                    <div id="checkoutSuccessView" class="hidden">
                      <div class="bg-white/80 border border-slate-200 rounded-2xl p-4 space-y-3">
                        <div class="text-slate-900 font-black text-lg">‚úÖ Operaci√≥n registrada</div>
                        <div id="checkoutSuccessSubtitle" class="text-sm text-slate-600"></div>

                        <div id="checkoutSuccessGrace" class="hidden bg-amber-50 border border-amber-200 rounded-xl p-3">
                          <div class="text-sm font-black text-amber-800">‚≠ê Ventana para completar promoci√≥n</div>
                          <div id="checkoutSuccessGraceText" class="text-sm text-amber-700 mt-1"></div>
                        </div>

                        <div id="checkoutSuccessReservation" class="hidden bg-amber-50 border border-amber-200 rounded-xl p-3">
                          <div class="text-sm font-black text-amber-800">‚è≥ Reserva activa</div>
                          <div class="text-sm text-amber-700 mt-1">Tienes tiempo para abonar o pagar antes de que estos n√∫meros vuelvan a estar disponibles.</div>
                          <div class="text-sm text-amber-700 mt-1">Tiempo restante: <span id="checkoutSuccessReservationCountdown" class="font-black text-amber-900" data-checkout-reservation-expires="">‚è≥ ‚Äî</span></div>
                        </div>

                        <div>
                          <div class="text-sm text-slate-700 uppercase mb-2 font-bold tracking-wide">N√∫meros reservados</div>
                          <div id="checkoutSuccessNumbers" class="flex flex-wrap gap-1.5"></div>
                        </div>

                        <div id="checkoutSuccessProof" class="hidden">
                          <div class="text-sm text-slate-700 uppercase mb-2 font-bold tracking-wide">Comprobante</div>
                          <a id="checkoutSuccessProofLink" href="#" target="_blank" rel="noopener noreferrer" class="block">
                            <img id="checkoutSuccessProofImg" src="" alt="Comprobante" class="w-full max-h-56 object-cover rounded-xl border border-slate-200" />
                          </a>
                          <div class="text-xs text-slate-500 mt-1">Toca la imagen para verla en tama√±o completo.</div>
                        </div>

                        <div>
                          <div class="text-sm text-slate-700 uppercase mb-2 font-bold tracking-wide">Transacciones creadas</div>
                          <div id="checkoutSuccessTransactions" class="space-y-2"></div>
                        </div>

                        <div id="checkoutSuccessNotes" class="hidden bg-slate-50 border border-slate-200 rounded-xl p-3">
                          <div class="text-sm text-slate-600 font-semibold">Notas</div>
                          <div id="checkoutSuccessNotesList" class="mt-2 space-y-1 text-sm text-slate-700"></div>
                        </div>

                        <button type="button" class="w-full bg-white hover:bg-slate-50 text-slate-800 border border-slate-200 font-bold py-2 rounded-lg" id="checkoutSuccessClose">Cerrar</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading/Message -->
          <div id="formMessage" class="hidden p-4 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800"></div>
        </div>
      </div>
    </div>

    <!-- Payments/Abonos Modal -->
    <div id="paymentsModal" class="hidden fixed inset-0 app-overlay z-50 flex items-center justify-center p-2 md:p-4">
      <div class="app-modal max-w-5xl w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-emerald-50 px-4 md:px-8 py-3 md:py-4 flex items-center justify-between border-b border-emerald-200">
          <div>
            <h2 class="text-lg md:text-2xl font-black text-slate-900">Mis pagos y abonos</h2>
            <p id="paymentsEventTitle" class="text-slate-600 text-xs md:text-sm mt-1"></p>
          </div>
          <button id="paymentsCloseBtn" class="text-slate-600 hover:text-slate-900 text-xl md:text-2xl font-bold transition-colors">‚úï</button>
        </div>

        <div class="px-4 md:px-8 py-4 md:py-6 space-y-4">
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-semibold text-slate-700 uppercase mb-2">C√©dula de Identidad *</label>
              <div class="flex flex-col sm:flex-row gap-2">
                <input
                  type="text"
                  id="paymentsCedulaInput"
                  placeholder="Ej: 1234567890"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  autocomplete="off"
                  class="app-input w-full sm:flex-1 min-w-0"
                />
                <button id="paymentsSearchBtn" class="w-full sm:w-auto sm:shrink-0 bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-6 py-3 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-emerald-500/20 focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:ring-offset-2">
                  Buscar
                </button>
              </div>
              <p id="paymentsUserName" class="text-xs text-slate-600 mt-2 hidden"></p>
            </div>

            <div id="paymentsMessage" class="hidden text-xs rounded-lg p-3 border"></div>
          </div>

          <div id="pendingTxList" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <script>
      let currentIndex = 0;
      const cards = document.querySelectorAll('.event-card');
      const indicators = document.querySelectorAll('.indicator');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      // Modal state
      let currentEvent = null;
      let selectedNumbers = []; // Array for multiple selection
      let availableNumbers = [];
      let ocupadosSet = new Set(); // N√∫meros reservados/vendidos para mostrar tachados

      // Checkout action chosen by user
      let checkoutAction: 'reserva' | 'pago' | 'abono' = 'reserva';

      // Abono flow (2-step): resumen -> detalle -> resumen (final confirm)
      let abonoDetailConfirmed = false;
      let lastAbonoGlobalMin: number | null = null;
      let abonoGlobalWasAutoSet = false;
      let abonoAllocationsFinal: number[] | null = null;
      let abonoGlobalAmountFinal: number | null = null;

      function isPromoMinKind(kind: 'grace' | 'promo' | 'normal', label: string) {
        return kind === 'promo' || (kind === 'grace' && /complet\w*\s+promo/i.test(String(label || '')));
      }

      function computeMinForOperation(opts: {
        kind: 'grace' | 'promo' | 'normal';
        label: string;
        cantidad: number;
      }) {
        const qty = Math.max(1, Number(opts.cantidad || 0) || 0);
        if (isPromoMinKind(opts.kind, opts.label)) return 20000;
        return 10000 * qty;
      }

      function computeTxPlanWithNumbers(pricing: any) {
        const nums = [...selectedNumbers].sort();
        const plan: Array<any> = [];
        let cursor = 0;

        (pricing.breakdown || []).forEach((b: any, idx: number) => {
          const cantidad = Number(b.cantidad ?? 0) || 0;
          const slice = nums.slice(cursor, cursor + Math.max(0, cantidad));
          cursor += Math.max(0, cantidad);

          const label = String(b.label || '');
          const isGraceCompletion = b.kind === 'grace' && /complet\w*\s+promo/i.test(label);

          // For grace transactions, the real transaction size includes existing tickets.
          // We only show newly selected numbers in detail, but compute min using total tx size.
          const effectiveQty = b.kind === 'grace' && !isGraceCompletion
            ? Math.max(1, (Number(promoExistingQty ?? 0) || 0) + Math.max(0, cantidad))
            : isGraceCompletion
              ? Math.max(1, (Number(promoTargetQty || 0) || 0) || ((Number(promoExistingQty || 0) || 0) + Math.max(0, cantidad)))
            : Math.max(1, cantidad);

          const min = computeMinForOperation({ kind: b.kind, label, cantidad: effectiveQty });

          // If completing a promo pack, previous abonos/pagos in the existing grace transaction count.
          // So the minimum for THIS new abono is what's missing to reach the promo minimum.
          const priorCredited = isGraceCompletion ? (Number(promoGraceCreditedTotal ?? 0) || 0) : 0;
          const minAdditional = isGraceCompletion && isPromoMinKind(b.kind, label)
            ? Math.max(0, 20000 - priorCredited)
            : min;

          const numbersForUI = isGraceCompletion
            ? uniqSortedNumbers([...(promoExistingNumbers || []), ...slice])
            : slice;

          plan.push({
            idx,
            label,
            kind: b.kind,
            cantidad,
            effectiveQty,
            unit: Number(b.unit ?? 0) || 0,
            total: Number(b.total ?? 0) || 0,
            numbers: numbersForUI,
            min: minAdditional,
            priorCredited,
          });
        });

        const globalMin = plan.reduce((s, p) => s + (Number(p.min ?? 0) || 0), 0);
        return { plan, globalMin };
      }

      // Promo window state (server-driven)
      let promoActive = false;
      let promoRequiredAdditional = 2;
      let promoExpiresAt: string | null = null;
      let promoExistingQty = 0;
      let promoPackSize = 3;
      let promoTargetQty = 0;
      let promoTransactionNumber: string | null = null;
      let promoExistingNumbers: string[] = [];
      let promoGraceCreditedTotal = 0;
      let promoMsRemaining = 0;
      let promoTickTimer: any = null;

      // Promo micro-messages (2s) during selection
      let promoToastTimer: any = null;
      let lastPromoRemainingToComplete: number | null = null;
      let lastPromoToastSelectionCount: number | null = null;

      function uniqSortedNumbers(nums: Array<any>) {
        const out = Array.from(new Set((nums || []).map((n) => String(n)).filter(Boolean)));
        out.sort();
        return out;
      }

      function computeAdjustedUnitForGraceCompletionUI(opts: {
        promoUnit: number;
        packSize: number;
        existingQty: number;
        normalUnit: number;
        missing: number;
      }) {
        const promoTotal = (Number(opts.promoUnit || 0) || 0) * (Number(opts.packSize || 0) || 0);
        const existingTotal = (Number(opts.existingQty || 0) || 0) * (Number(opts.normalUnit || 0) || 0);
        const missing = Math.max(1, Number(opts.missing || 0) || 1);
        const raw = (promoTotal - existingTotal) / missing;
        if (!Number.isFinite(raw)) return 0;
        return Math.max(0, Math.round(raw));
      }

      function computeSelectionPricing() {
        const quantity = selectedNumbers.length;
        const normalUnitPrice = currentEvent?.price || 0;
        const promoUnitPrice = currentEvent?.promoPrice || normalUnitPrice;

        const breakdown: Array<{ label: string; cantidad: number; unit: number; total: number; kind: 'grace' | 'promo' | 'normal'; numbersAll?: string[] }> = [];

        if (promoActive && promoRequiredAdditional > 0 && promoMsRemaining > 0 && promoEligibleForEvent() && quantity > 0) {
          // Nueva l√≥gica: solo unir a gracia si completa la promo
          const willCompletePromo = quantity >= promoRequiredAdditional;
          
          if (willCompletePromo) {
            // S√≠ completa: unir a gracia
            const graceCount = promoRequiredAdditional;
            const remainingAfterGrace = Math.max(0, quantity - graceCount);
            const targetQty = Math.max(1, (Number(promoTargetQty || 0) || 0) || ((Number(promoExistingQty || 0) || 0) + (Number(promoRequiredAdditional || 0) || 0)));
            const unit = promoUnitPrice;
            const graceTotalFull = targetQty * promoUnitPrice;
            
            // IMPORTANTE: Restar lo que ya est√° acreditado en la transacci√≥n
            const alreadyCredited = Number(promoGraceCreditedTotal || 0) || 0;
            const graceTotal = Math.max(0, graceTotalFull - alreadyCredited);

            const graceNewNumbers = selectedNumbers.slice(0, graceCount);
            const numbersAll = uniqSortedNumbers([...(promoExistingNumbers || []), ...graceNewNumbers]);

            breakdown.push({
              label: `Completando promo: ${targetQty} boleta(s)`,
              cantidad: graceCount,
              unit,
              total: graceTotal,
              kind: 'grace',
              numbersAll,
            });

            // Remaining: promos of 3 as separate tx + leftovers as 1 tx normal
            const promoChunks = Math.floor(remainingAfterGrace / promoPackSize);
            const normalLeft = remainingAfterGrace % promoPackSize;

            for (let i = 0; i < promoChunks; i++) {
              breakdown.push({
                label: `Promo: ${promoPackSize} boletas`,
                cantidad: promoPackSize,
                unit: promoUnitPrice,
                total: promoPackSize * promoUnitPrice,
                kind: 'promo',
              });
            }

            if (normalLeft > 0) {
              breakdown.push({
                label: `Normal: ${normalLeft} boleta(s)`,
                cantidad: normalLeft,
                unit: normalUnitPrice,
                total: normalLeft * normalUnitPrice,
                kind: 'normal',
              });
            }

            const promoSets = 1 + promoChunks;
            const promoTotal = breakdown
              .filter((b) => b.kind === 'promo' || b.kind === 'grace')
              .reduce((s, b) => s + b.total, 0);
            const normalTotal = breakdown.filter((b) => b.kind === 'normal').reduce((s, b) => s + b.total, 0);
            const total = promoTotal + normalTotal;

            return {
              quantity,
              promoSets,
              remainingNormal: normalLeft,
              normalTotal,
              promoTotal,
              total,
              normalUnitPrice,
              promoUnitPrice,
              breakdown,
            };
          } else {
            // NO completa: crear transacci√≥n individual separada (no unir a gracia)
            const promoChunksNoGrace = Math.floor(quantity / promoPackSize);
            const normalLeftNoGrace = quantity % promoPackSize;

            for (let i = 0; i < promoChunksNoGrace; i++) {
              breakdown.push({
                label: `Promo: ${promoPackSize} boletas`,
                cantidad: promoPackSize,
                unit: promoUnitPrice,
                total: promoPackSize * promoUnitPrice,
                kind: 'promo',
              });
            }

            if (normalLeftNoGrace > 0) {
              breakdown.push({
                label: `Normal: ${normalLeftNoGrace} boleta(s)`,
                cantidad: normalLeftNoGrace,
                unit: normalUnitPrice,
                total: normalLeftNoGrace * normalUnitPrice,
                kind: 'normal',
              });
            }

            const promoSetsNoGrace = promoChunksNoGrace;
            const promoTotalNoGrace = breakdown.filter((b) => b.kind === 'promo').reduce((s, b) => s + b.total, 0);
            const normalTotalNoGrace = breakdown.filter((b) => b.kind === 'normal').reduce((s, b) => s + b.total, 0);
            const totalNoGrace = promoTotalNoGrace + normalTotalNoGrace;

            return {
              quantity,
              promoSets: promoSetsNoGrace,
              remainingNormal: normalLeftNoGrace,
              normalTotal: normalTotalNoGrace,
              promoTotal: promoTotalNoGrace,
              total: totalNoGrace,
              normalUnitPrice,
              promoUnitPrice,
              breakdown,
            };
          }
        }

        // Sin gracia: si hay promo disponible, dividir igual (bloques de promo + sobrantes normales)
        if (promoEligibleForEvent() && quantity > 0) {
          const promoChunks = Math.floor(quantity / promoPackSize);
          const normalLeft = quantity % promoPackSize;

          for (let i = 0; i < promoChunks; i++) {
            breakdown.push({
              label: `Promo: ${promoPackSize} boletas`,
              cantidad: promoPackSize,
              unit: promoUnitPrice,
              total: promoPackSize * promoUnitPrice,
              kind: 'promo',
            });
          }

          if (normalLeft > 0) {
            breakdown.push({
              label: `Normal: ${normalLeft} boleta(s)`,
              cantidad: normalLeft,
              unit: normalUnitPrice,
              total: normalLeft * normalUnitPrice,
              kind: 'normal',
            });
          }

          const promoSets = promoChunks;
          const promoTotal = promoChunks * promoPackSize * promoUnitPrice;
          const normalTotal = normalLeft * normalUnitPrice;
          const total = promoTotal + normalTotal;

          return {
            quantity,
            promoSets,
            remainingNormal: normalLeft,
            normalTotal,
            promoTotal,
            total,
            normalUnitPrice,
            promoUnitPrice,
            breakdown,
          };
        }

        // Sin promo: todo normal
        return {
          quantity,
          promoSets: 0,
          remainingNormal: quantity,
          normalTotal: quantity * normalUnitPrice,
          promoTotal: 0,
          total: quantity * normalUnitPrice,
          normalUnitPrice,
          promoUnitPrice,
          breakdown: [],
        };
      }

      function promoEligibleForEvent() {
        const normalUnitPrice = currentEvent?.price || 0;
        const promoUnitPrice = currentEvent?.promoPrice;
        return Number(normalUnitPrice || 0) > 20000 && promoUnitPrice != null;
      }

      function renderTxBreakdown(breakdown: Array<{ label: string; cantidad: number; unit: number; total: number; kind: 'grace' | 'promo' | 'normal'; numbersAll?: string[] }>) {
        const section = document.getElementById('txBreakdownSection');
        const list = document.getElementById('txBreakdownList');
        if (!section || !list) return;

        if (breakdown.length === 0) {
          section.classList.add('hidden');
          list.innerHTML = '';
          return;
        }

        section.classList.remove('hidden');
        list.innerHTML = '';
        breakdown.forEach((b, idx) => {
          const row = document.createElement('div');
          const totalFmt = (b.total || 0).toLocaleString('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          });
          row.className = 'flex items-start justify-between gap-2';
          const numbersAll = Array.isArray((b as any)?.numbersAll) ? (b as any).numbersAll : null;
          
          // Si es una gracia completando promo, diferenciar n√∫meros ya pagos vs. nuevos
          let numsLine = '';
          if (b.kind === 'grace' && numbersAll && numbersAll.length > 0) {
            const existingNumbers = Array.isArray(promoExistingNumbers) ? promoExistingNumbers : [];
            const newNumbers = numbersAll.filter((n: string) => !existingNumbers.includes(n));
            const existingInThisBreakdown = numbersAll.filter((n: string) => existingNumbers.includes(n));
            
            let parts = [];
            if (existingInThisBreakdown.length > 0) {
              parts.push(`<span class="text-emerald-700 font-semibold">‚úì Asegurados (ya pagados): ${existingInThisBreakdown.join(', ')}</span>`);
            }
            if (newNumbers.length > 0) {
              parts.push(`<span class="text-rose-700">+ Nuevos: ${newNumbers.join(', ')}</span>`);
            }
            numsLine = `<div class="text-[11px] mt-1 space-y-0.5 break-words">${parts.join('<br>')}</div>`;
          } else if (numbersAll && numbersAll.length > 0) {
            numsLine = `<div class="text-[11px] text-slate-600 mt-0.5 break-words">N√∫meros: ${numbersAll.join(', ')}</div>`;
          }
          
          row.innerHTML = `
            <div class="min-w-0">
              <div class="text-slate-700 font-semibold">${idx + 1}. ${b.label}</div>
              ${numsLine}
            </div>
            <div class="font-bold text-slate-900 whitespace-nowrap">${totalFmt}</div>
          `;
          list.appendChild(row);
        });
      }

      function formatCountdown(ms: number) {
        const s = Math.max(0, Math.floor(ms / 1000));
        const m = Math.floor(s / 60);
        const r = s % 60;
        return `${String(m).padStart(2, '0')}:${String(r).padStart(2, '0')}`;
      }

      function setPromoBanner(visible: boolean, text: string) {
        const banner = document.getElementById('promoBanner');
        const bannerText = document.getElementById('promoBannerText');
        if (!banner || !bannerText) return;
        if (!visible) {
          banner.classList.add('hidden');
          bannerText.textContent = '';
          return;
        }
        banner.classList.remove('hidden');
        bannerText.textContent = text;
      }

      function promoGraceActive() {
        return Boolean(promoActive && promoRequiredAdditional > 0 && promoMsRemaining > 0);
      }

      function showPromoToast(message: string) {
        const el = document.getElementById('promoToast');
        if (!el) return;
        el.textContent = message;
        el.classList.remove('hidden');
        if (promoToastTimer) clearTimeout(promoToastTimer);
        promoToastTimer = setTimeout(() => {
          el.classList.add('hidden');
          el.textContent = '';
        }, 2000);
      }

      function applyPromoUIRules() {
        const checkoutReserva = document.getElementById('checkoutReserva') as HTMLInputElement | null;
        const checkoutPago = document.getElementById('checkoutPago') as HTMLInputElement | null;
        const checkoutAbono = document.getElementById('checkoutAbono') as HTMLInputElement | null;

        if (promoGraceActive()) {
          // Durante gracia: permitir Reserva/Pago/Abono.
          // Abono ahora se discrimina por transacci√≥n con una sola imagen.
          if (checkoutAbono) checkoutAbono.disabled = false;
          if (checkoutPago) checkoutPago.disabled = false;
          if (checkoutReserva) checkoutReserva.disabled = false;
        } else {
          if (checkoutPago) checkoutPago.disabled = false;
          // Se habilita/deshabilita din√°micamente seg√∫n la selecci√≥n (ver updateSelectionSummary)
        }
      }

      function startPromoCountdown() {
        if (promoTickTimer) clearInterval(promoTickTimer);
        promoTickTimer = setInterval(() => {
          // Si ya no hay gracia (promo completada o vencida), no mostrar ni seguir contando.
          if (!promoGraceActive()) {
            setPromoBanner(false, '');
            applyPromoUIRules();
            updateSelectionSummary();
            if (promoTickTimer) {
              clearInterval(promoTickTimer);
              promoTickTimer = null;
            }
            return;
          }

          promoMsRemaining = Math.max(0, promoMsRemaining - 1000);
          if (promoMsRemaining <= 0) {
            promoActive = false;
            promoExpiresAt = null;
            setPromoBanner(false, '');
            applyPromoUIRules();
            updateSelectionSummary();
            return;
          }
          setPromoBanner(
            true,
            `‚≠ê Promoci√≥n activa: puedes seleccionar todas las boletas que quieras. Las primeras ${promoRequiredAdditional} completar√°n tu promo. Tiempo restante: ${formatCountdown(promoMsRemaining)}`
          );
        }, 1000);
      }

      async function refreshPromoStatus() {
        try {
          const cedula = (document.getElementById('cedula') as HTMLInputElement | null)?.value?.trim() || '';
          const eventId = currentEvent?.eventId ? String(currentEvent.eventId) : '';
          if (!cedula || !eventId) return;

          const qs = new URLSearchParams({ eventId, cedula });
          const res = await fetch(`/api/promo-status?${qs.toString()}`, { headers: { 'cache-control': 'no-store' } });
          const data = await res.json();
          if (!res.ok) return;

          promoActive = Boolean(data?.active);
          promoRequiredAdditional = Number(data?.requiredAdditional ?? 2) || 2;
          promoExpiresAt = data?.expiresAt ? String(data.expiresAt) : null;
          promoMsRemaining = Number(data?.msRemaining ?? 0) || 0;
          promoExistingQty = Number(data?.existingQty ?? 0) || 0;
          promoPackSize = Number(data?.packSize ?? 3) || 3;
          promoTargetQty = Number(data?.targetQty ?? 0) || 0;
          promoTransactionNumber = data?.transactionNumber ? String(data.transactionNumber) : null;
          promoExistingNumbers = Array.isArray(data?.existingNumbers) ? data.existingNumbers.map((n: any) => String(n)).sort() : [];
          promoGraceCreditedTotal = Number(data?.creditedTotal ?? 0) || 0;

          if (promoGraceActive()) {
            setPromoBanner(
              true,
              `‚≠ê Promoci√≥n activa: puedes seleccionar todas las boletas que quieras. Las primeras ${promoRequiredAdditional} completar√°n tu promo. Tiempo restante: ${formatCountdown(promoMsRemaining)}`
            );
            applyPromoUIRules();
            startPromoCountdown();
          } else {
            // Promo completada (requiredAdditional=0) o sin gracia: no mostrar per√≠odo de gracia.
            setPromoBanner(false, '');
            applyPromoUIRules();
            if (promoTickTimer) {
              clearInterval(promoTickTimer);
              promoTickTimer = null;
            }
          }

          updateSelectionSummary();
        } catch (e) {
          // ignore: promo-status is best-effort UI guidance
        }
      }

      // Summary (mobile): don't rely on inline onclick (Astro scripts are module-scoped)
      const summaryBtn = document.getElementById('summaryFloatingBtn');
      const summarySectionEl = document.getElementById('selectedNumbersSection');
      const summaryCloseBtn = document.getElementById('summaryCloseBtn');

      summaryBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        toggleSummary();
      });

      summaryCloseBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        hideSummary();
      });

      // Tap on the dark backdrop closes the summary
      summarySectionEl?.addEventListener('click', (e) => {
        if (e.target === summarySectionEl) hideSummary();
      });

      function showCard(index: number) {
        cards.forEach((card, i) => {
          if (i === index) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });

        indicators.forEach((indicator, i) => {
          if (i === index) {
            indicator.classList.add('bg-pink-400', 'w-8', 'shadow-lg', 'shadow-pink-500/50');
            indicator.classList.remove('bg-pink-500/30');
          } else {
            indicator.classList.add('bg-pink-500/30');
            indicator.classList.remove('bg-pink-400', 'w-8', 'shadow-lg', 'shadow-pink-500/50');
          }
        });

        currentIndex = index;
      }

      function nextCard() {
        const next = (currentIndex + 1) % cards.length;
        showCard(next);
      }

      function prevCard() {
        const prev = (currentIndex - 1 + cards.length) % cards.length;
        showCard(prev);
      }

      prevBtn?.addEventListener('click', prevCard);
      nextBtn?.addEventListener('click', nextCard);

      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => showCard(index));
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') prevCard();
        if (e.key === 'ArrowRight') nextCard();
      });

      if (cards.length > 0) {
        showCard(0);
      }

      let autoPlay = setInterval(nextCard, 8000);
      
      document.addEventListener('click', () => {
        clearInterval(autoPlay);
        autoPlay = setInterval(nextCard, 8000);
      });

      // Add event listeners to participate buttons
      document.querySelectorAll('.participate-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const eventData = {
            eventId: this.getAttribute('data-event-id'),
            campaignId: this.getAttribute('data-campaign-id'),
            campaignName: this.getAttribute('data-campaign-name'),
            eventName: this.getAttribute('data-event-name'),
            price: parseFloat(this.getAttribute('data-price')),
            promoPrice: this.getAttribute('data-promo-price') ? parseFloat(this.getAttribute('data-promo-price')) : null,
            numbersMode: this.getAttribute('data-numbers-mode')
          };
          openParticipantsForm(eventData);
        });
      });

      // Add event listeners to payments buttons
      document.querySelectorAll('.payments-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const eventData = {
            eventId: this.getAttribute('data-event-id'),
            campaignId: this.getAttribute('data-campaign-id'),
            campaignName: this.getAttribute('data-campaign-name'),
            eventName: this.getAttribute('data-event-name'),
          };
          openPaymentsModal(eventData);
        });
      });

      // Modal functions
      let ignoreNextPopstate = false;
      let participantsModalPushed = false;
      let paymentsModalPushed = false;

      function openParticipantsForm(eventData) {
        // Always start from a clean modal state
        resetModal();
        currentEvent = eventData;
        const modal = document.getElementById('participantsModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          
          // Set event title
          document.getElementById('modalEventTitle').textContent = eventData.campaignName;
        }

        // Mobile UX: allow Android/iOS browser back button to close the modal
        try {
          if (typeof window !== 'undefined' && typeof history !== 'undefined' && !participantsModalPushed) {
            history.pushState({ ...(history.state || {}), participantsModalOpen: true }, '');
            participantsModalPushed = true;
          }
        } catch {
          // ignore
        }
      }

      function closeParticipantsForm(opts: { fromPopstate?: boolean } = {}) {
        const modal = document.getElementById('participantsModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
          resetModal();
        }

        // If the modal pushed a history entry, remove it when closing via UI.
        try {
          if (!opts.fromPopstate && typeof window !== 'undefined' && typeof history !== 'undefined') {
            if ((history.state as any)?.participantsModalOpen) {
              ignoreNextPopstate = true;
              history.back();
            }
          }
        } catch {
          // ignore
        } finally {
          participantsModalPushed = false;
        }
      }

      // Payments modal state
      let paymentsEvent: any = null;

      function openPaymentsModal(eventData: any) {
        paymentsEvent = eventData;
        const modal = document.getElementById('paymentsModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          const title = document.getElementById('paymentsEventTitle');
          if (title) {
            const parts = [eventData?.campaignName, eventData?.eventName].filter(Boolean);
            title.textContent = parts.length ? parts.join(' ‚Äî ') : '';
          }
        }
        resetPaymentsModal();

        // Browser back button closes this modal too
        try {
          if (typeof window !== 'undefined' && typeof history !== 'undefined' && !paymentsModalPushed) {
            history.pushState({ ...(history.state || {}), paymentsModalOpen: true }, '');
            paymentsModalPushed = true;
          }
        } catch {
          // ignore
        }
      }

      function closePaymentsModal(opts: { fromPopstate?: boolean } = {}) {
        const modal = document.getElementById('paymentsModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
        resetPaymentsModal();

        try {
          if (!opts.fromPopstate && typeof window !== 'undefined' && typeof history !== 'undefined') {
            if ((history.state as any)?.paymentsModalOpen) {
              ignoreNextPopstate = true;
              history.back();
            }
          }
        } catch {
          // ignore
        } finally {
          paymentsModalPushed = false;
        }
      }

      function resetPaymentsModal() {
        const cedulaEl = document.getElementById('paymentsCedulaInput') as HTMLInputElement | null;
        const listEl = document.getElementById('pendingTxList');
        const msgEl = document.getElementById('paymentsMessage');
        const userEl = document.getElementById('paymentsUserName');

        if (cedulaEl) cedulaEl.value = '';
        if (listEl) listEl.innerHTML = '';
        if (msgEl) {
          msgEl.classList.add('hidden');
          msgEl.textContent = '';
          msgEl.className = 'hidden text-xs rounded-lg p-3 border';
        }
        if (userEl) {
          userEl.classList.add('hidden');
          userEl.textContent = '';
        }
      }

      function setPaymentsMessage(kind: 'info' | 'error' | 'success', text: string) {
        const el = document.getElementById('paymentsMessage');
        if (!el) return;
        el.classList.remove('hidden');
        el.textContent = text;
        if (kind === 'error') {
          el.className = 'text-xs rounded-lg p-3 border bg-red-50 border-red-200 text-red-800';
        } else if (kind === 'success') {
          el.className = 'text-xs rounded-lg p-3 border bg-emerald-50 border-emerald-200 text-emerald-800';
        } else {
          el.className = 'text-xs rounded-lg p-3 border bg-slate-50 border-slate-200 text-slate-700';
        }
      }

      function formatCOP(value: number) {
        const n = Number(value || 0) || 0;
        return n.toLocaleString('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
      }

      async function fetchPendingTransactions(cedula: string) {
        const eid = paymentsEvent?.eventId ? String(paymentsEvent.eventId) : '';
        const qs = new URLSearchParams({ cedula });
        if (eid) qs.set('eventId', eid);
        const res = await fetch(`/api/pending-transactions?${qs.toString()}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Error consultando transacciones');
        return data;
      }

      function renderPendingTransactions(payload: any, cedula: string) {
        const listEl = document.getElementById('pendingTxList');
        const userEl = document.getElementById('paymentsUserName');
        if (!listEl) return;
        listEl.innerHTML = '';

        const userName = payload?.usuario?.nombre;
        const userEmail = payload?.usuario?.correo;
        if (userEl) {
          userEl.classList.remove('hidden');
          userEl.textContent = userName
            ? `Usuario: ${userName}${userEmail ? ` ‚Äî ${userEmail}` : ''}`
            : `C√©dula: ${cedula}${userEmail ? ` ‚Äî ${userEmail}` : ''}`;
        }

        const txs = Array.isArray(payload?.transactions) ? payload.transactions : [];
        if (txs.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'bg-white/80 border border-slate-200 rounded-xl p-4 text-slate-600';
          empty.textContent = 'No tienes transacciones pendientes en este evento.';
          listEl.appendChild(empty);
          return;
        }

        txs.forEach((tx: any) => {
          const card = document.createElement('div');
          card.className = 'bg-white/80 border border-emerald-200 rounded-2xl p-4 space-y-3';

          const header = document.createElement('div');
          header.className = 'flex flex-col md:flex-row md:items-center md:justify-between gap-2';
          const left = document.createElement('div');
          left.innerHTML = `
            <div class="text-slate-900 font-bold">Transacci√≥n #${tx.transactionNumber}</div>
            <div class="text-xs text-slate-600">${tx.campaignName ?? ''}${tx.eventName ? ` ‚Äî ${tx.eventName}` : ''}</div>
          `;
          const right = document.createElement('div');
          right.className = 'text-xs text-slate-700';
          const paidTotal = Number(tx.paidTotal ?? 0) || 0;
          const creditedTotal = Number(tx.creditedTotal ?? ((Number(tx.totalAbonado ?? 0) || 0) + paidTotal)) || 0;
          const totalPrice = Number(tx.totalPrice ?? 0) || 0;
          const saldoPendiente = Math.max(0, Number(tx.saldoPendiente ?? (totalPrice - creditedTotal)) || 0);
          const hasPromo = Boolean(tx.hasPromo);
          const promoUnit = Number(tx.promoUnitPrice ?? 0) || 0;
          right.innerHTML = `
            <div>Total a pagar: <span class="font-bold text-slate-900">${formatCOP(totalPrice)}</span></div>
            <div>Abonado: <span class="font-bold text-slate-900">${formatCOP(creditedTotal)}</span></div>
            <div>Saldo por pagar: <span class="font-black text-emerald-700">${formatCOP(saldoPendiente)}</span></div>
            ${hasPromo && promoUnit > 0 ? `<div class="text-[11px] text-emerald-700/80">Promo: ${formatCOP(promoUnit)} c/u</div>` : ''}
            <div class="text-[11px] text-slate-500">Detalle ‚Äî Abonos: ${formatCOP(Number(tx.totalAbonado ?? 0) || 0)} ‚Ä¢ Pagos: ${formatCOP(paidTotal)}</div>
          `;
          header.appendChild(left);
          header.appendChild(right);
          card.appendChild(header);

          if (Array.isArray(tx.numeros) && tx.numeros.length > 0) {
            const nums = document.createElement('div');
            nums.className = 'flex flex-wrap gap-2';
            tx.numeros.slice(0, 30).forEach((n: string) => {
              const chip = document.createElement('span');
              chip.className = 'bg-emerald-50 border border-emerald-200 text-emerald-800 px-3 py-1 rounded-full text-xs font-bold';
              chip.textContent = n;
              nums.appendChild(chip);
            });
            if (tx.numeros.length > 30) {
              const more = document.createElement('span');
              more.className = 'text-xs text-slate-500';
              more.textContent = `+${tx.numeros.length - 30} m√°s`;
              nums.appendChild(more);
            }
            card.appendChild(nums);
          }

          // Proof gallery
          if (Array.isArray(tx.proofs) && tx.proofs.length > 0) {
            const galleryWrap = document.createElement('div');
            galleryWrap.className = 'space-y-2';
            const label = document.createElement('div');
            label.className = 'text-xs text-slate-600';
            label.textContent = 'Comprobantes enviados:';
            const gallery = document.createElement('div');
            gallery.className = 'flex gap-2 overflow-x-auto pb-1';

            tx.proofs.forEach((p: any) => {
              const a = document.createElement('a');
              a.href = p.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.className = 'shrink-0';

              const img = document.createElement('img');
              img.src = p.url;
              img.alt = 'Comprobante';
              img.className = 'w-16 h-16 rounded-lg object-cover border border-slate-200';
              a.appendChild(img);

              const meta = document.createElement('div');
              meta.className = 'text-[10px] text-slate-500 mt-1 text-center';
              const amt = p.amount != null ? ` ${formatCOP(p.amount)}` : '';
              meta.textContent = `${String(p.kind || '').toUpperCase()}${amt}`;

              const box = document.createElement('div');
              box.className = 'w-20';
              box.appendChild(a);
              box.appendChild(meta);
              gallery.appendChild(box);
            });

            galleryWrap.appendChild(label);
            galleryWrap.appendChild(gallery);
            card.appendChild(galleryWrap);
          }

          // Action form
          const form = document.createElement('form');
          form.className = 'bg-slate-50 border border-slate-200 rounded-xl p-3 space-y-3';
          form.innerHTML = `
            <div class="text-xs text-slate-600">Registrar un nuevo movimiento (sube tu comprobante)</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-3 py-2">
                <input type="radio" name="kind-${tx.transactionNumber}" value="abono" class="accent-emerald-500" checked />
                <span class="text-sm text-slate-800">Abono</span>
              </label>
              <label class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-3 py-2">
                <input type="radio" name="kind-${tx.transactionNumber}" value="pago" class="accent-emerald-500" />
                <span class="text-sm text-slate-800">Pago del saldo</span>
              </label>
            </div>
            <div class="grid md:grid-cols-2 gap-2">
              <div class="space-y-1" data-amount-row>
                <label class="block text-xs text-slate-600">Monto del abono</label>
                <input type="number" min="1" step="1" inputmode="numeric" placeholder="M√≠nimo: ${formatCOP(tx.minAbono)}" class="app-input w-full" data-amount />
                <div class="text-[11px] text-slate-500">Saldo: ${formatCOP(tx.saldoPendiente)} ‚Äî M√≠nimo: ${formatCOP(tx.minAbono)}</div>
              </div>
              <div class="space-y-1">
                <label class="block text-xs text-slate-600">Comprobante (imagen)</label>
                <input type="file" accept="image/*" class="w-full text-xs text-slate-700" data-file />
                <img class="hidden mt-2 w-full max-w-[220px] rounded-lg border border-slate-200" data-preview />
              </div>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-emerald-500/20 focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:ring-offset-2">Enviar</button>
              <button type="button" class="px-4 py-2 rounded-lg bg-white hover:bg-slate-50 text-slate-800 border border-slate-200" data-refresh>Actualizar</button>
            </div>
            <div class="hidden text-xs rounded-lg p-2 border" data-status></div>
          `;

          const statusEl = form.querySelector('[data-status]') as HTMLDivElement | null;
          const amountRow = form.querySelector('[data-amount-row]') as HTMLDivElement | null;
          const amountEl = form.querySelector('[data-amount]') as HTMLInputElement | null;
          const fileEl = form.querySelector('[data-file]') as HTMLInputElement | null;
          const previewEl = form.querySelector('[data-preview]') as HTMLImageElement | null;
          const refreshBtn = form.querySelector('[data-refresh]') as HTMLButtonElement | null;
          const kindInputs = Array.from(form.querySelectorAll(`input[name="kind-${tx.transactionNumber}"]`)) as HTMLInputElement[];

          const setStatus = (kind: 'info' | 'error' | 'success', text: string) => {
            if (!statusEl) return;
            statusEl.classList.remove('hidden');
            statusEl.textContent = text;
            if (kind === 'error') statusEl.className = 'text-xs rounded-lg p-2 border bg-red-50 border-red-200 text-red-800';
            else if (kind === 'success') statusEl.className = 'text-xs rounded-lg p-2 border bg-emerald-50 border-emerald-200 text-emerald-800';
            else statusEl.className = 'text-xs rounded-lg p-2 border bg-slate-50 border-slate-200 text-slate-700';
          };

          const getKind = () => (kindInputs.find((i) => i.checked)?.value === 'pago' ? 'pago' : 'abono');

          const syncKindUI = () => {
            const k = getKind();
            if (k === 'pago') {
              amountRow?.classList.add('hidden');
              if (amountEl) amountEl.value = '';
            } else {
              amountRow?.classList.remove('hidden');
            }
          };

          kindInputs.forEach((i) => i.addEventListener('change', syncKindUI));
          syncKindUI();

          fileEl?.addEventListener('change', () => {
            const f = fileEl.files?.[0];
            if (!f || !previewEl) return;
            const url = URL.createObjectURL(f);
            previewEl.src = url;
            previewEl.classList.remove('hidden');
          });

          refreshBtn?.addEventListener('click', async () => {
            try {
              setStatus('info', 'Actualizando...');
              const payload2 = await fetchPendingTransactions(cedula);
              renderPendingTransactions(payload2, cedula);
            } catch (e) {
              setStatus('error', String((e as any)?.message || e));
            }
          });

          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const k = getKind();
            const f = fileEl?.files?.[0];
            if (!f) {
              setStatus('error', 'Adjunta la imagen del comprobante.');
              return;
            }
            if (tx.saldoPendiente <= 0) {
              setStatus('error', 'Esta transacci√≥n ya no tiene saldo pendiente.');
              return;
            }
            if (k === 'abono') {
              const raw = String(amountEl?.value || '').trim();
              const v = raw ? Number(raw) : NaN;
              if (!Number.isFinite(v) || v <= 0) {
                setStatus('error', 'Ingresa un monto v√°lido.');
                return;
              }
              if (v < tx.minAbono) {
                setStatus('error', `Abono m√≠nimo: ${formatCOP(tx.minAbono)}`);
                return;
              }
              if (v > tx.saldoPendiente) {
                setStatus('error', `El abono no puede superar el saldo: ${formatCOP(tx.saldoPendiente)}`);
                return;
              }
            }

            const fd = new FormData();
            fd.set('transactionNumber', tx.transactionNumber);
            fd.set('cedula', cedula);
            fd.set('kind', k);
            if (k === 'abono') fd.set('amount', String(amountEl?.value || '').trim());
            fd.set('file', f);

            try {
              setStatus('info', 'Enviando comprobante...');
              const res = await fetch('/api/upload-transaction-proof', { method: 'POST', body: fd });
              const out = await res.json();
              if (!res.ok) throw new Error(out?.error || 'Error subiendo comprobante');
              setStatus('success', 'Listo. Comprobante enviado.');

              // Refresh list
              const payload2 = await fetchPendingTransactions(cedula);
              renderPendingTransactions(payload2, cedula);
            } catch (err) {
              setStatus('error', String((err as any)?.message || err));
            }
          });

          card.appendChild(form);
          listEl.appendChild(card);
        });
      }

      async function paymentsSearch() {
        const cedula = (document.getElementById('paymentsCedulaInput') as HTMLInputElement | null)?.value.trim() || '';
        if (!cedula) {
          setPaymentsMessage('error', 'Ingresa una c√©dula.');
          return;
        }
        try {
          setPaymentsMessage('info', 'Buscando transacciones pendientes...');
          const payload = await fetchPendingTransactions(cedula);
          setPaymentsMessage('success', 'Listo.');
          renderPendingTransactions(payload, cedula);
        } catch (e) {
          setPaymentsMessage('error', String((e as any)?.message || e));
        }
      }

      function resetNumbersStepTransientUI() {
        // Hide and stop promo toast so it doesn't persist across sessions/step re-entry
        const toast = document.getElementById('promoToast');
        if (toast) {
          toast.classList.add('hidden');
          toast.textContent = '';
        }
        if (promoToastTimer) {
          clearTimeout(promoToastTimer);
          promoToastTimer = null;
        }
        lastPromoRemainingToComplete = null;
        lastPromoToastSelectionCount = null;

        // Clear summary UI immediately (prevents a brief flash of old chips/messages)
        const listDiv = document.getElementById('selectedNumbersList');
        if (listDiv) listDiv.innerHTML = '';
        const txList = document.getElementById('txBreakdownList');
        if (txList) txList.innerHTML = '';
        document.getElementById('txBreakdownSection')?.classList.add('hidden');

        const qtyEl = document.getElementById('totalQuantity');
        const promosEl = document.getElementById('totalPromos');
        const normalEl = document.getElementById('normalPrice');
        const promoEl = document.getElementById('promoPrice');
        const totalEl = document.getElementById('totalPrice');
        if (qtyEl) qtyEl.textContent = '0';
        if (promosEl) promosEl.textContent = '0';
        if (normalEl) normalEl.textContent = '0';
        if (promoEl) promoEl.textContent = '0';
        if (totalEl) totalEl.textContent = '$0';

        const banner = document.getElementById('promoBanner');
        const bannerText = document.getElementById('promoBannerText');
        banner?.classList.add('hidden');
        if (bannerText) bannerText.textContent = '';

        const summaryCount = document.getElementById('summaryCount');
        if (summaryCount) summaryCount.textContent = '0';

        document.querySelectorAll('.selectNumberBtn').forEach((btn) => {
          const b = btn as HTMLButtonElement;
          b.disabled = true;
          b.textContent = 'Confirmar';
        });

        const grid = document.getElementById('numbersGrid');
        if (grid) grid.innerHTML = '';
      }

      function resetModal() {
        document.getElementById('cedulaInput').value = '';
        document.getElementById('welcomeStep').classList.add('hidden');
        document.getElementById('participantForm').classList.add('hidden');
        document.getElementById('numbersStep').classList.add('hidden');
        document.getElementById('cedulaStep').classList.remove('hidden');
        document.getElementById('formMessage').classList.add('hidden');
        document.getElementById('usuarioId').value = '';

        const txList = document.getElementById('welcomeTxList');
        const txStatus = document.getElementById('welcomeTxStatus');
        stopWelcomeGraceCountdown();
        if (txList) {
          const existingHero = document.getElementById('welcomeGraceHero');
          // Keep (or recreate) the hero container so renderWelcomeTransactions can rely on it.
          if (existingHero && existingHero.parentElement === txList) {
            Array.from(txList.children).forEach((child) => {
              if (child === existingHero) return;
              child.remove();
            });
            existingHero.classList.add('hidden');
            existingHero.innerHTML = '';
          } else {
            txList.innerHTML = '';
            const hero = document.createElement('div');
            hero.id = 'welcomeGraceHero';
            hero.className = 'hidden snap-start shrink-0 w-full bg-gradient-to-br from-yellow-900/30 to-amber-900/20 border border-yellow-500/20 rounded-2xl p-4';
            txList.appendChild(hero);
          }
        }
        if (txStatus) txStatus.textContent = '';
        selectedNumbers = [];
        availableNumbers = [];
        checkoutAction = 'reserva';
        const summarySection = document.getElementById('selectedNumbersSection');
        const summaryBtn = document.getElementById('summaryFloatingBtn');
        if (summarySection) summarySection.style.display = 'none';
        summaryBtn?.classList.add('hidden');
        document.getElementById('selectedNumbersList').innerHTML = '';
        resetNumbersStepTransientUI();
        resetSummaryPanelView();
        resetCheckoutUI();
        document.querySelectorAll('.selectNumberBtn').forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Confirmar';
        });
      }

      function backToSearch() {
        document.getElementById('welcomeStep').classList.add('hidden');
        document.getElementById('participantForm').classList.add('hidden');
        document.getElementById('numbersStep').classList.add('hidden');
        document.getElementById('cedulaStep').classList.remove('hidden');
      }

      function backToForm() {
        document.getElementById('numbersStep').classList.add('hidden');
        document.getElementById('participantForm').classList.remove('hidden');
        selectedNumbers = [];
        availableNumbers = [];
        const summarySection = document.getElementById('selectedNumbersSection');
        if (summarySection) summarySection.style.display = 'none';
        resetNumbersStepTransientUI();
        resetSummaryPanelView();
        resetCheckoutUI();
        document.querySelectorAll('.selectNumberBtn').forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Confirmar';
        });
      }

      function resetSummaryPanelView() {
        const title = document.getElementById('summaryTitle');
        const summary = document.getElementById('summaryMainView');
        const detail = document.getElementById('abonoDetailView');
        const success = document.getElementById('checkoutSuccessView');
        if (title) title.textContent = 'üí∞ Resumen de Compra';
        success?.classList.add('hidden');
        detail?.classList.add('hidden');
        summary?.classList.remove('hidden');
        // Stop any previous reservation countdown that could keep updating UI.
        stopCheckoutSuccessCountdown();
      }

      function showSummary() {
        const el = document.getElementById('selectedNumbersSection');
        const modalContent = el?.querySelector('.modal-content');
        if (!el) return;
        // Desktop: summary is inline, no overlay.
        if (typeof window !== 'undefined' && window.innerWidth >= 768) {
          el.style.display = 'block';
          return;
        }
        el.style.display = 'flex';
        modalContent?.classList.add('show');
      }

      function resetCheckoutUI() {
        checkoutAction = 'reserva';
        const reserva = document.getElementById('checkoutReserva') as HTMLInputElement | null;
        const pago = document.getElementById('checkoutPago') as HTMLInputElement | null;
        const abono = document.getElementById('checkoutAbono') as HTMLInputElement | null;
        if (reserva) reserva.checked = true;
        if (pago) pago.checked = false;
        if (abono) abono.checked = false;

        const proofSection = document.getElementById('proofSection');
        const proofAmountRow = document.getElementById('proofAmountRow');
        const abonoGlobalRow = document.getElementById('abonoGlobalRow');
        const proofAmount = document.getElementById('proofAmount') as HTMLInputElement | null;
        const abonoGlobalAmount = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
        const proofFile = document.getElementById('proofFile') as HTMLInputElement | null;
        const checkoutMsg = document.getElementById('checkoutMessage');
        const proofAmountHint = document.getElementById('proofAmountHint');
        const abonoGlobalHint = document.getElementById('abonoGlobalHint');

        hideAbonoDetailView();
        resetAbonoDetailState();

        proofSection?.classList.add('hidden');
        proofAmountRow?.classList.add('hidden');
        abonoGlobalRow?.classList.add('hidden');
        if (proofAmount) proofAmount.value = '';
        if (abonoGlobalAmount) abonoGlobalAmount.value = '';
        if (proofFile) proofFile.value = '';
        if (checkoutMsg) {
          checkoutMsg.classList.add('hidden');
          checkoutMsg.textContent = '';
          checkoutMsg.className = 'hidden text-xs rounded-lg p-2 border';
        }
        if (proofAmountHint) proofAmountHint.textContent = '';
        if (abonoGlobalHint) abonoGlobalHint.textContent = '';
      }

      function setCheckoutAction(action: 'reserva' | 'pago' | 'abono') {
        checkoutAction = action;
        const proofSection = document.getElementById('proofSection');
        const proofAmountRow = document.getElementById('proofAmountRow');
        const abonoSplitRow = document.getElementById('abonoSplitRow');
        const proofAmountHint = document.getElementById('proofAmountHint');
        const abonoGlobalRow = document.getElementById('abonoGlobalRow');
        const abonoGlobalHint = document.getElementById('abonoGlobalHint');

        // any change resets abono detail confirmation
        resetAbonoDetailState();

        if (action === 'reserva') {
          proofSection?.classList.add('hidden');
          proofAmountRow?.classList.add('hidden');
          abonoGlobalRow?.classList.add('hidden');
          abonoSplitRow?.classList.add('hidden');
          return;
        }

        proofSection?.classList.remove('hidden');

        if (action === 'abono') {
          // Flujo profesional: monto global + detalle
          abonoGlobalRow?.classList.remove('hidden');
          proofAmountRow?.classList.add('hidden');
          abonoSplitRow?.classList.add('hidden');
          if (proofAmountHint) proofAmountHint.textContent = '';
          if (abonoGlobalHint) abonoGlobalHint.textContent = '';

          // Presetear el m√≠nimo SOLO al entrar a Abono (para no bloquear que el usuario borre y escriba otro valor)
          const abonoGlobalAmount = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
          const raw = String(abonoGlobalAmount?.value || '').trim();
          if (!raw) {
            const pricing = computeSelectionPricing();
            const { globalMin } = computeTxPlanWithNumbers(pricing);
            if (abonoGlobalAmount) {
              abonoGlobalAmount.value = String(globalMin);
              abonoGlobalWasAutoSet = true;
              lastAbonoGlobalMin = globalMin;
            }
          }

          // Refrescar el resumen inmediatamente (para que muestre m√≠nimo/detalle desde la primera vez)
          updateSelectionSummary();
        } else {
          proofAmountRow?.classList.add('hidden');
          abonoGlobalRow?.classList.add('hidden');
          abonoSplitRow?.classList.add('hidden');
          if (proofAmountHint) proofAmountHint.textContent = '';
          if (abonoGlobalHint) abonoGlobalHint.textContent = '';
          const proofAmount = document.getElementById('proofAmount') as HTMLInputElement | null;
          if (proofAmount) proofAmount.value = '';
          const abonoGlobalAmount = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
          if (abonoGlobalAmount) abonoGlobalAmount.value = '';

          // Refrescar para ocultar controles de abono inmediatamente
          updateSelectionSummary();
        }
      }

      function formatCOPShort(value: number) {
        return (Number(value || 0) || 0).toLocaleString('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
      }

      function renderAbonoAllocations(breakdown: Array<{ label: string; cantidad: number; unit: number; total: number; kind: 'grace' | 'promo' | 'normal' }>) {
        const row = document.getElementById('abonoSplitRow');
        const list = document.getElementById('abonoSplitList');
        const hint = document.getElementById('abonoSplitHint');
        if (!row || !list || !hint) return;

        list.innerHTML = '';

        breakdown.forEach((b, idx) => {
          const isPromoTx = b.kind === 'promo' || (b.kind === 'grace' && /completar\s+promo/i.test(b.label));
                const min = isPromoTx ? 20000 : 10000 * Math.max(1, Number(b.cantidad || 0) || 0);

          const wrap = document.createElement('div');
          wrap.className = 'bg-black/20 bg-white/80 border border-slate-200 rounded-lg p-3';
          wrap.innerHTML = `
            <div class="flex items-start justify-between gap-2">
              <div class="text-xs text-slate-800 font-semibold">${idx + 1}. ${b.label}</div>
              <div class="text-xs text-slate-500">Total: ${formatCOPShort(b.total)}</div>
            </div>
            <div class="mt-2">
              <input
                type="number"
                inputmode="numeric"
                min="0"
                step="1000"
                placeholder="Abono para esta transacci√≥n (m√≠n: ${formatCOPShort(min)})"
                class="app-input w-full"
                data-abono-idx="${idx}"
                data-abono-min="${min}"
              />
              <div class="text-[11px] text-slate-500 mt-1">M√≠nimo: ${formatCOPShort(min)}${b.total > 0 ? ` ‚Äî M√°ximo: ${formatCOPShort(b.total)}` : ''}</div>
            </div>
          `;
          list.appendChild(wrap);
        });

        hint.textContent = 'Puedes dejar en 0 las transacciones que no vas a abonar. Se valida en el servidor.';
      }

      function setAbonoDetailError(message: string | null) {
        const el = document.getElementById('abonoDetailError');
        if (!el) return;
        if (!message) {
          el.classList.add('hidden');
          el.textContent = '';
          return;
        }
        el.classList.remove('hidden');
        el.textContent = message;
      }

      function resetAbonoDetailState() {
        abonoDetailConfirmed = false;
        abonoAllocationsFinal = null;
        abonoGlobalAmountFinal = null;

        const recap = document.getElementById('abonoRecap');
        const recapList = document.getElementById('abonoRecapList');
        recap?.classList.add('hidden');
        if (recapList) recapList.innerHTML = '';

        // Reset confirm button label(s)
        document.querySelectorAll('.selectNumberBtn').forEach((b) => {
          const btn = b as HTMLButtonElement;
          btn.textContent = 'Confirmar';
        });
      }

      function showAbonoDetailView() {
        const title = document.getElementById('summaryTitle');
        const summary = document.getElementById('summaryMainView');
        const detail = document.getElementById('abonoDetailView');
        if (title) title.textContent = 'Detalle de abono';
        summary?.classList.add('hidden');
        detail?.classList.remove('hidden');
      }

      function hideAbonoDetailView() {
        const title = document.getElementById('summaryTitle');
        const summary = document.getElementById('summaryMainView');
        const detail = document.getElementById('abonoDetailView');
        if (title) title.textContent = 'üí∞ Resumen de Compra';
        detail?.classList.add('hidden');
        summary?.classList.remove('hidden');
      }

      function renderAbonoDetailFromCurrentSelection(opts?: { mode?: 'default' | 'target'; targetIdx?: number }) {
        const pricing = computeSelectionPricing();
        const { plan, globalMin } = computeTxPlanWithNumbers(pricing);

        const globalMaxAllowed = plan.reduce((s: number, p: any) => {
          const t = Number(p?.total ?? 0) || 0;
          return s + (t > 0 ? t : 0);
        }, 0);

        const globalAmountInput = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
        const raw = String(globalAmountInput?.value || '').trim();
        const globalAmount = raw ? Number(raw) : NaN;
        let safeGlobalAmount = Number.isFinite(globalAmount) ? globalAmount : globalMin;
        if (globalMaxAllowed > 0) {
          safeGlobalAmount = Math.min(safeGlobalAmount, globalMaxAllowed);
          if (globalAmountInput) {
            const isFocused = typeof document !== 'undefined' && document.activeElement === globalAmountInput;
            if (!isFocused) globalAmountInput.value = String(Math.trunc(safeGlobalAmount));
          }
        }

        const minEl = document.getElementById('abonoDetailGlobalMin');
        const amtEl = document.getElementById('abonoDetailGlobalAmount');
        const excEl = document.getElementById('abonoDetailExcess');
        const remEl = document.getElementById('abonoDetailRemaining');
        const listEl = document.getElementById('abonoDetailList');
        const targetSel = document.getElementById('abonoExcessTarget') as HTMLSelectElement | null;

        if (minEl) minEl.textContent = formatCOPShort(globalMin);
        if (amtEl) amtEl.textContent = formatCOPShort(safeGlobalAmount);
        if (excEl) excEl.textContent = formatCOPShort(Math.max(0, safeGlobalAmount - globalMin));

        if (!listEl) return;
        listEl.innerHTML = '';
        setAbonoDetailError(null);

        const mode = opts?.mode ?? 'default';
        const defaultTargetIdx = plan.length > 0 ? plan[0].idx : 0;
        const preferredTargetIdx = Number.isFinite(Number(opts?.targetIdx)) ? Number(opts?.targetIdx) : defaultTargetIdx;

        // Populate target selector
        if (targetSel) {
          targetSel.innerHTML = '';
          plan.forEach((p: any) => {
            const opt = document.createElement('option');
            opt.value = String(p.idx);
            opt.textContent = `${p.idx + 1}. ${p.label}`;
            targetSel.appendChild(opt);
          });
          targetSel.value = String(preferredTargetIdx);
        }

        // Allocations:
        // - mode=default: auto-complete any operation that can be fully covered, then put leftover into first
        // - mode=target: fill selected target to max first, then spill to others
        let remaining = Math.max(0, safeGlobalAmount - globalMin);

        const allocationsByIdx = new Map<number, number>();
        plan.forEach((p: any) => {
          allocationsByIdx.set(Number(p.idx), Number(p.min ?? 0) || 0);
        });

        if (mode === 'default') {
          const completables = plan
            .map((p: any) => {
              const idx = Number(p.idx);
              const min = Number(p.min ?? 0) || 0;
              const total = Number(p.total ?? 0) || 0;
              const need = total > 0 ? Math.max(0, total - min) : 0;
              return { idx, need, total, min };
            })
            .filter((x: any) => x.need > 0)
            .sort((a: any, b: any) => a.need - b.need);

          for (const c of completables) {
            if (remaining + 0.0001 >= c.need) {
              allocationsByIdx.set(c.idx, (allocationsByIdx.get(c.idx) ?? c.min) + c.need);
              remaining -= c.need;
            }
          }
        }

        const addExtra = (idx: number, amount: number) => {
          const p = plan.find((x: any) => Number(x.idx) === idx);
          if (!p) return amount;
          const total = Number(p.total ?? 0) || 0;
          if (!(total > 0)) {
            allocationsByIdx.set(idx, (allocationsByIdx.get(idx) ?? 0) + amount);
            return 0;
          }
          const current = Number(allocationsByIdx.get(idx) ?? 0) || 0;
          const cap = Math.max(0, total - current);
          const used = Math.min(cap, amount);
          allocationsByIdx.set(idx, current + used);
          return amount - used;
        };

        // Put leftover into preferred target; if capped, spread to others.
        if (remaining > 0) remaining = addExtra(preferredTargetIdx, remaining);
        if (remaining > 0) {
          for (const p of plan) {
            if (remaining <= 0) break;
            const idx = Number(p.idx);
            if (idx === preferredTargetIdx) continue;
            remaining = addExtra(idx, remaining);
          }
        }

        plan.forEach((p: any) => {
          const row = document.createElement('div');
          row.className = 'bg-black/20 bg-white/80 border border-slate-200 rounded-xl p-3 space-y-2';

          const header = document.createElement('div');
          header.className = 'flex items-start justify-between gap-2';
          header.innerHTML = `
            <div class="text-xs text-slate-800 font-semibold">${p.idx + 1}. ${p.label}</div>
            <div class="text-[11px] text-slate-500">M√≠n: ${formatCOPShort(p.min)}${p.total > 0 ? ` ‚Äî Total: ${formatCOPShort(p.total)}` : ''}</div>
          `;

          const numsWrap = document.createElement('div');
          numsWrap.className = 'flex flex-wrap gap-1';
          if (Array.isArray(p.numbers) && p.numbers.length > 0) {
            p.numbers.forEach((n: string) => {
              const chip = document.createElement('span');
              chip.className = 'bg-rose-50 border border-rose-200 text-rose-800 px-2 py-0.5 rounded-full text-[11px] font-bold';
              chip.textContent = n;
              numsWrap.appendChild(chip);
            });
          } else {
            const none = document.createElement('div');
            none.className = 'text-[11px] text-slate-500';
            none.textContent = 'N√∫meros seleccionados: ‚Äî';
            numsWrap.appendChild(none);
          }

          const input = document.createElement('input');
          input.type = 'number';
          input.inputMode = 'numeric';
          input.min = String(p.min);
          input.step = '1000';
          input.className = 'app-input w-full';
          input.setAttribute('data-abono-idx', String(p.idx));
          input.setAttribute('data-abono-min', String(p.min));
          if (p.total > 0) input.setAttribute('data-abono-max', String(p.total));

          const paidBadge = document.createElement('div');
          paidBadge.className = 'hidden text-[11px] font-black text-emerald-200 text-emerald-700';
          paidBadge.textContent = '‚úì Quedar√≠a paga (pendiente de confirmaci√≥n)';

          const initial = allocationsByIdx.get(Number(p.idx)) ?? p.min;
          input.value = String(initial);

          const note = document.createElement('div');
          note.className = 'text-[11px] text-slate-500';
          const extraNote = p.kind === 'grace' && Number(p.effectiveQty || 0) > Number(p.cantidad || 0)
            ? ` (incluye transacci√≥n previa: ${p.effectiveQty} boleta(s))`
            : '';
          const prior = Number(p?.priorCredited ?? 0) || 0;
          const priorNote = prior > 0 && isPromoMinKind(p.kind, String(p.label || ''))
            ? ` ‚Äî Ya abonado: ${formatCOPShort(prior)}`
            : '';
          note.textContent = `M√≠nimo a abonar: ${formatCOPShort(p.min)}${extraNote}${priorNote}${p.total > 0 ? ` ‚Äî M√°ximo: ${formatCOPShort(p.total)}` : ''}`;

          row.appendChild(header);
          row.appendChild(numsWrap);
          row.appendChild(input);
          row.appendChild(paidBadge);
          row.appendChild(note);
          listEl.appendChild(row);
        });

        const syncRemaining = () => {
          const inputs = Array.from(document.querySelectorAll('#abonoDetailList [data-abono-idx]')) as HTMLInputElement[];
          const sum = inputs.reduce((s, el) => {
            const v = Number(String(el.value || '').trim());
            return s + (Number.isFinite(v) ? v : 0);
          }, 0);

            // Keep excedente label in sync (based on global min)
            const excEl2 = document.getElementById('abonoDetailExcess');
            if (excEl2) excEl2.textContent = formatCOPShort(Math.max(0, safeGlobalAmount - globalMin));

          // Update per-row preapproval badge
            let allFull = true;
          inputs.forEach((el) => {
            const wrap = el.closest('.bg-black/20') as HTMLElement | null;
            const badge = wrap?.querySelector('.text-emerald-200') as HTMLElement | null;
            const maxAttr = el.getAttribute('data-abono-max');
            const max = maxAttr ? (Number(maxAttr) || 0) : 0;
            const v = Number(String(el.value || '').trim());
            const isFull = max > 0 && Number.isFinite(v) && Math.abs(v - max) <= 0.0001;
            if (badge) badge.classList.toggle('hidden', !isFull);
            if (max > 0 && !isFull) allFull = false;
          });

          const delta = sum - safeGlobalAmount;
          if (remEl) {
            if (safeGlobalAmount < globalMin) {
              remEl.textContent = `‚ùå El abono global debe ser al menos ${formatCOPShort(globalMin)}.`;
              remEl.className = 'text-[11px] text-red-700 mt-2';
            } else if (globalMaxAllowed > 0 && safeGlobalAmount >= globalMaxAllowed - 0.0001) {
              if (allFull && Math.abs(delta) <= 0.0001) {
                  remEl.textContent = `‚úì Este abono cubre el total. Quedar√≠a todo pago (pendiente de confirmaci√≥n).`;
                remEl.className = 'text-[11px] text-emerald-700 mt-2';
              } else {
                remEl.textContent = `‚ÑπÔ∏è M√°ximo global permitido: ${formatCOPShort(globalMaxAllowed)}.`;
                remEl.className = 'text-[11px] text-slate-600 mt-2';
              }
            } else if (Math.abs(delta) > 0.0001) {
              remEl.textContent = `‚ö†Ô∏è Debe sumar exactamente ${formatCOPShort(safeGlobalAmount)}. Diferencia: ${formatCOPShort(delta)}.`;
              remEl.className = 'text-[11px] text-amber-700 mt-2';
            } else {
              remEl.textContent = `‚úì Distribuci√≥n lista. Excedente asignado: ${formatCOPShort(Math.max(0, safeGlobalAmount - globalMin))}.`;
              remEl.className = 'text-[11px] text-emerald-700 mt-2';
            }
          }

          const confirmBtn = document.getElementById('abonoDetailConfirmBtn') as HTMLButtonElement | null;
          const ok = safeGlobalAmount >= globalMin && Math.abs(delta) <= 0.0001;
          if (confirmBtn) confirmBtn.disabled = !ok;
        };

        // Attach listeners
        Array.from(document.querySelectorAll('#abonoDetailList [data-abono-idx]')).forEach((el) => {
          el.addEventListener('input', () => {
            const inp = el as HTMLInputElement;
            const min = Number(inp.getAttribute('data-abono-min') || '0') || 0;
            const maxAttr = inp.getAttribute('data-abono-max');
            const max = maxAttr ? (Number(maxAttr) || 0) : 0;
            const v = Number(String(inp.value || '').trim());
            if (Number.isFinite(v) && v > 0 && v < min) {
              inp.value = String(min);
            }
            if (max > 0 && Number.isFinite(v) && v > max) {
              inp.value = String(max);
            }
            syncRemaining();
          });
        });

        syncRemaining();
      }

      function openAbonoDetail() {
        const pricing = computeSelectionPricing();
        const multipleTx = (pricing.breakdown || []).length > 1;
        if (!multipleTx) {
          // For single tx we don't force detail, but we can still show it.
        }

        const globalAmountInput = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
        const raw = String(globalAmountInput?.value || '').trim();
        if (!raw) {
          // default to global min
          const { globalMin } = computeTxPlanWithNumbers(pricing);
          if (globalAmountInput) globalAmountInput.value = String(globalMin);
        }

        showAbonoDetailView();
        renderAbonoDetailFromCurrentSelection();
      }

      function applyAbonoExcessToTarget() {
        const pricing = computeSelectionPricing();
        const { plan, globalMin } = computeTxPlanWithNumbers(pricing);

        const globalMaxAllowed = plan.reduce((s: number, p: any) => {
          const t = Number(p?.total ?? 0) || 0;
          return s + (t > 0 ? t : 0);
        }, 0);

        const globalAmountInput = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
        let globalAmount = Number(String(globalAmountInput?.value || '').trim());
        if (!Number.isFinite(globalAmount) || globalAmount < globalMin) {
          setAbonoDetailError(`El abono global m√≠nimo es ${formatCOPShort(globalMin)}.`);
          return;
        }

        // Clamp to global max so we never end up with leftover that cannot be assigned.
        if (globalMaxAllowed > 0 && globalAmount > globalMaxAllowed) {
          globalAmount = globalMaxAllowed;
          if (globalAmountInput) globalAmountInput.value = String(Math.trunc(globalMaxAllowed));
        }

        const targetSel = document.getElementById('abonoExcessTarget') as HTMLSelectElement | null;
        const targetIdx = targetSel ? Number(targetSel.value) : (plan.length ? plan[0].idx : 0);
        if (!Number.isFinite(targetIdx)) return;

        setAbonoDetailError(null);

        // Re-render with a target-first distribution (fills target up to max, then spills).
        renderAbonoDetailFromCurrentSelection({ mode: 'target', targetIdx });
      }

      function onConfirmCheckout() {
        if (checkoutAction === 'abono') {
          const pricing = computeSelectionPricing();
          const { globalMin } = computeTxPlanWithNumbers(pricing);
          const globalAmountInput = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
          const globalAmount = Number(String(globalAmountInput?.value || '').trim());
          if (!Number.isFinite(globalAmount) || globalAmount <= 0) {
            alert('Ingresa un monto de abono v√°lido.');
            showSummary();
            return;
          }
          if (globalAmount < globalMin) {
            alert(`El abono m√≠nimo para esta operaci√≥n es ${formatCOPShort(globalMin)}.`);
            showSummary();
            return;
          }

          const multipleTx = (pricing.breakdown || []).length > 1;
          if (multipleTx && !abonoDetailConfirmed) {
            openAbonoDetail();
            return;
          }
        }

        // Default behavior: submit
        selectNumbers();
      }

      function confirmAbonoDetail() {
        const pricing = computeSelectionPricing();
        const { plan, globalMin } = computeTxPlanWithNumbers(pricing);
        const globalAmountInput = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
        const globalAmount = Number(String(globalAmountInput?.value || '').trim());

        if (!Number.isFinite(globalAmount) || globalAmount <= 0) {
          setAbonoDetailError('Ingresa un monto global v√°lido.');
          return;
        }
        if (globalAmount < globalMin) {
          setAbonoDetailError(`El abono global m√≠nimo es ${formatCOPShort(globalMin)}.`);
          return;
        }

        const inputs = Array.from(document.querySelectorAll('#abonoDetailList [data-abono-idx]')) as HTMLInputElement[];
        const allocations: number[] = new Array(plan.length).fill(0);
        let sum = 0;

        for (const el of inputs) {
          const idx = Number(el.getAttribute('data-abono-idx') || '');
          if (!Number.isFinite(idx) || idx < 0) continue;
          const v = Number(String(el.value || '').trim());
          const min = Number(el.getAttribute('data-abono-min') || '0') || 0;
          const maxAttr = el.getAttribute('data-abono-max');
          const max = maxAttr ? (Number(maxAttr) || 0) : 0;

          if (!Number.isFinite(v) || v < min) {
            setAbonoDetailError(`Cada operaci√≥n debe tener m√≠nimo ${formatCOPShort(min)}.`);
            return;
          }
          if (max > 0 && v > max + 0.0001) {
            setAbonoDetailError(`Una operaci√≥n excede su total (${formatCOPShort(max)}).`);
            return;
          }

          allocations[idx] = Math.trunc(v);
          sum += Math.trunc(v);
        }

        if (Math.abs(sum - globalAmount) > 0.0001) {
          setAbonoDetailError(`La suma de la distribuci√≥n (${formatCOPShort(sum)}) debe ser igual al abono global (${formatCOPShort(globalAmount)}).`);
          return;
        }

        abonoDetailConfirmed = true;
        abonoAllocationsFinal = allocations;
        abonoGlobalAmountFinal = Math.trunc(globalAmount);

        // Render recap back in resumen
        const recap = document.getElementById('abonoRecap');
        const recapList = document.getElementById('abonoRecapList');
        if (recapList) {
          recapList.innerHTML = '';
          plan.forEach((p: any) => {
            const line = document.createElement('div');
            line.className = 'flex items-start justify-between gap-2';
            const left = document.createElement('div');
            left.className = 'text-xs text-slate-700';
            left.textContent = `${p.idx + 1}. ${p.label}`;
            const right = document.createElement('div');
            right.className = 'text-xs text-slate-900 font-semibold';
            right.textContent = formatCOPShort(allocations[p.idx] || 0);
            line.appendChild(left);
            line.appendChild(right);
            recapList.appendChild(line);
          });
        }
        recap?.classList.remove('hidden');

        // Update main confirm button label
        document.querySelectorAll('.selectNumberBtn').forEach((b) => {
          const btn = b as HTMLButtonElement;
          btn.textContent = 'Confirmar abono';
        });

        hideAbonoDetailView();
      }

      async function searchUsuario() {
        const cedula = document.getElementById('cedulaInput').value.trim();
        if (!cedula) {
          alert('Por favor ingresa una c√©dula');
          return;
        }

        try {
          const response = await fetch(`/api/search-usuario?cedula=${encodeURIComponent(cedula)}`);
          const data = await response.json();

          if (data.exists) {
            document.getElementById('usuarioId').value = data.usuario.id;
            document.getElementById('cedula').value = data.usuario.cedula;
            document.getElementById('primerNombre').value = data.usuario.primerNombre || '';
            document.getElementById('segundoNombre').value = data.usuario.segundoNombre || '';
            document.getElementById('primerApellido').value = data.usuario.primerApellido || '';
            document.getElementById('segundoApellido').value = data.usuario.segundoApellido || '';
            document.getElementById('fechaNacimiento').value = data.usuario.fechaNacimiento || '';
            document.getElementById('departamento').value = data.usuario.departamento || '';
            document.getElementById('ciudad').value = data.usuario.ciudad || '';
            document.getElementById('correoElectronico').value = data.usuario.correoElectronico || '';
            document.getElementById('telefono').value = data.usuario.telefono || '';

            // Mostrar bienvenida antes de pasar a selecci√≥n de n√∫meros
            showWelcomeStep({
              nombre: `${data.usuario.primerNombre || ''} ${data.usuario.segundoNombre || ''} ${data.usuario.primerApellido || ''} ${data.usuario.segundoApellido || ''}`.replace(/\s+/g, ' ').trim(),
              correo: data.usuario.correoElectronico || '',
            });
            void welcomeLoadTransactions(cedula);
          } else {
            document.getElementById('usuarioId').value = '';
            document.getElementById('cedula').value = cedula;
            document.getElementById('primerNombre').value = '';
            document.getElementById('segundoNombre').value = '';
            document.getElementById('primerApellido').value = '';
            document.getElementById('segundoApellido').value = '';
            document.getElementById('fechaNacimiento').value = '';
            document.getElementById('departamento').value = '';
            document.getElementById('ciudad').value = '';
            document.getElementById('correoElectronico').value = '';
            document.getElementById('telefono').value = '';

            document.getElementById('welcomeStep').classList.add('hidden');
            document.getElementById('cedulaStep').classList.add('hidden');
            document.getElementById('participantForm').classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error searching usuario:', error);
          alert('Error al buscar usuario');
        }
      }

      function showWelcomeStep(user: { nombre?: string; correo?: string } = {}) {
        const cedulaStep = document.getElementById('cedulaStep');
        const welcome = document.getElementById('welcomeStep');
        const form = document.getElementById('participantForm');
        const numbers = document.getElementById('numbersStep');

        cedulaStep?.classList.add('hidden');
        form?.classList.add('hidden');
        numbers?.classList.add('hidden');
        welcome?.classList.remove('hidden');

        const nameEl = document.getElementById('welcomeUserName');
        const emailEl = document.getElementById('welcomeUserEmail');
        const campEl = document.getElementById('welcomeCampaignName');
        const eventEl = document.getElementById('welcomeEventName');

        if (nameEl) nameEl.textContent = user?.nombre ? user.nombre : 'Usuario';
        if (emailEl) emailEl.textContent = user?.correo ? `‚Ä¢ ${user.correo}` : '';
        if (campEl) campEl.textContent = String(currentEvent?.campaignName || '');
        if (eventEl) eventEl.textContent = String(currentEvent?.eventName || '');
      }

      function welcomeEditDatos() {
        stopWelcomeGraceCountdown();
        document.getElementById('cedulaStep')?.classList.add('hidden');
        document.getElementById('welcomeStep')?.classList.add('hidden');
        document.getElementById('numbersStep')?.classList.add('hidden');
        document.getElementById('participantForm')?.classList.remove('hidden');
        // Make the transition obvious
        const form = document.getElementById('participantForm');
        form?.scrollIntoView?.({ behavior: 'smooth', block: 'start' });
        const first = document.getElementById('primerNombre') as HTMLInputElement | null;
        first?.focus?.();
      }

      async function welcomeContinue() {
        stopWelcomeGraceCountdown();
        document.getElementById('cedulaStep')?.classList.add('hidden');
        document.getElementById('participantForm')?.classList.add('hidden');
        document.getElementById('welcomeStep')?.classList.add('hidden');
        await showNumbersStep();
        // Make the transition obvious
        const grid = document.getElementById('numbersGrid');
        grid?.scrollIntoView?.({ behavior: 'smooth', block: 'start' });
        const btn = document.getElementById('searchToggleBtn') as HTMLButtonElement | null;
        btn?.focus?.();
      }

      function setWelcomeTxStatus(text: string) {
        const el = document.getElementById('welcomeTxStatus');
        if (el) el.textContent = text;
      }

      let welcomeGraceTickTimer: any = null;
      function stopWelcomeGraceCountdown() {
        if (welcomeGraceTickTimer) {
          clearInterval(welcomeGraceTickTimer);
          welcomeGraceTickTimer = null;
        }
      }

      function startWelcomeGraceCountdown() {
        stopWelcomeGraceCountdown();
        welcomeGraceTickTimer = setInterval(() => {
          const els = Array.from(
            document.querySelectorAll('[data-welcome-grace-expires], [data-welcome-reservation-expires]')
          ) as HTMLElement[];
          if (!els.length) return;
          const now = Date.now();
          els.forEach((el) => {
            const isReservation = el.hasAttribute('data-welcome-reservation-expires');
            const iso = String(
              el.getAttribute(isReservation ? 'data-welcome-reservation-expires' : 'data-welcome-grace-expires') || ''
            ).trim();
            const ms = iso ? Math.max(0, Date.parse(iso) - now) : 0;
            if (ms <= 0) {
              el.textContent = isReservation ? 'Reserva expirada' : 'Gracia finalizada';
              const card = el.closest(isReservation ? '[data-welcome-reservation-card]' : '[data-welcome-grace-card]') as HTMLElement | null;
              card?.classList.add('opacity-60');
              return;
            }
            el.textContent = `‚è≥ ${formatCountdown(ms)}`;
          });
        }, 1000);
      }

      // Checkout success countdown (reservation TTL)
      let checkoutSuccessTickTimer: any = null;
      function stopCheckoutSuccessCountdown() {
        if (checkoutSuccessTickTimer) {
          clearInterval(checkoutSuccessTickTimer);
          checkoutSuccessTickTimer = null;
        }
      }

      function startCheckoutSuccessCountdown() {
        stopCheckoutSuccessCountdown();
        checkoutSuccessTickTimer = setInterval(() => {
          const el = document.querySelector('[data-checkout-reservation-expires]') as HTMLElement | null;
          if (!el) return;
          const iso = String(el.getAttribute('data-checkout-reservation-expires') || '').trim();
          if (!iso) return;
          const ms = Math.max(0, Date.parse(iso) - Date.now());
          if (ms <= 0) {
            el.textContent = 'Reserva expirada';
            return;
          }
          el.textContent = `‚è≥ ${formatCountdown(ms)}`;
        }, 1000);
      }

      function showCheckoutSuccess(result: any, opts: { checkoutAction: 'reserva' | 'pago' | 'abono'; totalPrice: number }) {
        const title = document.getElementById('summaryTitle');
        const summary = document.getElementById('summaryMainView');
        const detail = document.getElementById('abonoDetailView');
        const success = document.getElementById('checkoutSuccessView');
        const subtitle = document.getElementById('checkoutSuccessSubtitle');
        const numsWrap = document.getElementById('checkoutSuccessNumbers');
        const txWrap = document.getElementById('checkoutSuccessTransactions');
        const proofWrap = document.getElementById('checkoutSuccessProof');
        const proofImg = document.getElementById('checkoutSuccessProofImg') as HTMLImageElement | null;
        const proofLink = document.getElementById('checkoutSuccessProofLink') as HTMLAnchorElement | null;
        const notesWrap = document.getElementById('checkoutSuccessNotes');
        const notesList = document.getElementById('checkoutSuccessNotesList');
        const graceWrap = document.getElementById('checkoutSuccessGrace');
        const graceText = document.getElementById('checkoutSuccessGraceText');
        const reservWrap = document.getElementById('checkoutSuccessReservation');
        const reservCountdown = document.getElementById('checkoutSuccessReservationCountdown');

        if (title) title.textContent = '‚úÖ Confirmaci√≥n';
        summary?.classList.add('hidden');
        detail?.classList.add('hidden');
        success?.classList.remove('hidden');
        showSummary();

        // Subtitle
        const count = Array.isArray(result?.reservedNumbers) ? result.reservedNumbers.length : 0;
        const kindLabel = opts.checkoutAction === 'reserva' ? 'Reserva' : opts.checkoutAction === 'pago' ? 'Pago' : 'Abono';
        const totalFmt = formatCOP(Number(result?.totalPrice ?? opts.totalPrice ?? 0) || 0);
        const primaryTx = String(result?.transactionNumber || '').trim();
        if (subtitle) {
          subtitle.textContent = `${kindLabel} registrada${primaryTx ? ` ‚Äî Operaci√≥n #${primaryTx}` : ''}. Total: ${totalFmt}.`;
        }

        // Promo grace notice
        const promoMsg = result?.promoSuggestion?.message ? String(result.promoSuggestion.message) : '';
        if (graceWrap && graceText) {
          if (promoMsg) {
            graceWrap.classList.remove('hidden');
            graceText.textContent = promoMsg;
          } else {
            graceWrap.classList.add('hidden');
            graceText.textContent = '';
          }
        }

        // Reservation TTL notice (only for plain reservations)
        stopCheckoutSuccessCountdown();
        if (reservWrap && reservCountdown) {
          const exp = result?.reservationExpiresAt ? String(result.reservationExpiresAt) : '';
          if (opts.checkoutAction === 'reserva' && exp) {
            reservWrap.classList.remove('hidden');
            reservCountdown.setAttribute('data-checkout-reservation-expires', exp);
            reservCountdown.textContent = `‚è≥ ${formatCountdown(Math.max(0, Date.parse(exp) - Date.now()))}`;
            startCheckoutSuccessCountdown();
          } else {
            reservWrap.classList.add('hidden');
            reservCountdown.setAttribute('data-checkout-reservation-expires', '');
            reservCountdown.textContent = '‚è≥ ‚Äî';
          }
        }

        // Numbers chips
        if (numsWrap) {
          numsWrap.innerHTML = '';
          const nums = Array.isArray(result?.reservedNumbers) ? result.reservedNumbers : [];
          nums.forEach((n: string) => {
            const chip = document.createElement('span');
            chip.className = 'bg-rose-50 border border-rose-200 text-rose-800 px-2 py-0.5 rounded-full text-[11px] font-black';
            chip.textContent = String(n);
            numsWrap.appendChild(chip);
          });
          if (!nums.length) {
            const empty = document.createElement('div');
            empty.className = 'text-xs text-slate-500';
            empty.textContent = '‚Äî';
            numsWrap.appendChild(empty);
          }
        }

        // Proof
        const proofUrl = result?.proofUrl ? String(result.proofUrl) : '';
        if (proofWrap && proofImg && proofLink) {
          if (proofUrl) {
            proofWrap.classList.remove('hidden');
            proofImg.src = proofUrl;
            proofLink.href = proofUrl;
          } else {
            proofWrap.classList.add('hidden');
            proofImg.src = '';
            proofLink.href = '#';
          }
        }

        // Transactions created cards
        if (txWrap) {
          txWrap.innerHTML = '';
          const txs = Array.isArray(result?.transactionsCreated) ? result.transactionsCreated : [];
          const abonos = Array.isArray(result?.abonoByTransaction) ? result.abonoByTransaction : [];
          const abonoByTx = new Map<string, any>(abonos.map((a: any) => [String(a.transactionNumber), a]));

          txs.forEach((tx: any) => {
            const card = document.createElement('div');
            card.className = 'bg-white/80 border border-slate-200 rounded-xl p-3';
            const txNum = String(tx?.transactionNumber || '').trim();
            const txTotal = Number(tx?.precioTotal ?? 0) || 0;
            const txTotalFmt = formatCOP(txTotal);
            const qty = Number(tx?.cantidad ?? 0) || 0;
            const promos = Number(tx?.promociones ?? 0) || 0;
            const nums = Array.isArray(tx?.reservedNumbers) ? tx.reservedNumbers : [];

            const header = document.createElement('div');
            header.className = 'flex items-start justify-between gap-2';
            header.innerHTML = `
              <div>
                <div class="text-sm text-slate-900 font-black">#${txNum || '‚Äî'}</div>
                <div class="text-[11px] text-slate-600">Boletas: ${qty}${promos ? ` ‚Äî Promo: ${promos}` : ''}</div>
              </div>
              <div class="text-xs text-rose-700 font-black">${txTotalFmt}</div>
            `;

            const numsRow = document.createElement('div');
            numsRow.className = 'mt-2 flex flex-wrap gap-1';
            nums.slice(0, 30).forEach((n: string) => {
              const chip = document.createElement('span');
              chip.className = 'bg-slate-50 border border-slate-200 text-slate-700 px-2 py-0.5 rounded-full text-[11px] font-bold';
              chip.textContent = String(n);
              numsRow.appendChild(chip);
            });
            if (nums.length > 30) {
              const more = document.createElement('span');
              more.className = 'text-[11px] text-slate-500';
              more.textContent = `+${nums.length - 30} m√°s`;
              numsRow.appendChild(more);
            }

            const movement = document.createElement('div');
            movement.className = 'mt-2 text-xs';
            if (opts.checkoutAction === 'abono') {
              const a = abonoByTx.get(txNum);
              if (a) {
                const amt = formatCOP(Number(a.amount ?? 0) || 0);
                const min = formatCOP(Number(a.minAdditional ?? 0) || 0);
                const prev = formatCOP(Number(a.creditedPrev ?? 0) || 0);
                movement.innerHTML = `
                  <div class="text-emerald-700 font-bold">Abono registrado: ${amt}${a.isPrepaid ? ' ‚Äî ‚úì Quedar√≠a paga (pendiente)' : ''}</div>
                  <div class="text-slate-600 text-[11px]">M√≠nimo a abonar: ${min}${Number(a.creditedPrev ?? 0) > 0 ? ` ‚Äî Cr√©dito previo: ${prev}` : ''}</div>
                `;
              } else {
                movement.innerHTML = `<div class="text-slate-600">Abono: ‚Äî</div>`;
              }
            } else if (opts.checkoutAction === 'pago') {
              movement.innerHTML = `<div class="text-emerald-700 font-bold">Pago total registrado (pendiente de validaci√≥n)</div>`;
            } else {
              movement.innerHTML = `<div class="text-amber-700 font-bold">Reserva (sin comprobante)</div>`;
            }

            card.appendChild(header);
            if (nums.length) card.appendChild(numsRow);
            card.appendChild(movement);
            txWrap.appendChild(card);
          });

          if (!txs.length) {
            const empty = document.createElement('div');
            empty.className = 'text-xs text-slate-500';
            empty.textContent = '‚Äî';
            txWrap.appendChild(empty);
          }
        }

        // Notes
        const notes = Array.isArray(result?.uxNotifications) ? result.uxNotifications.filter(Boolean) : [];
        if (notesWrap && notesList) {
          notesList.innerHTML = '';
          if (notes.length) {
            notesWrap.classList.remove('hidden');
            notes.forEach((t: string) => {
              const row = document.createElement('div');
              row.textContent = String(t);
              notesList.appendChild(row);
            });
          } else {
            notesWrap.classList.add('hidden');
          }
        }

        // Close button
        const closeBtn = document.getElementById('checkoutSuccessClose');
        closeBtn?.addEventListener('click', () => {
          stopCheckoutSuccessCountdown();
          // UX: after confirming, return to the events screen
          closeParticipantsForm();
        }, { once: true });
      }

      async function fetchWelcomeTransactions(cedula: string) {
        const eid = currentEvent?.eventId ? String(currentEvent.eventId) : '';
        const qs = new URLSearchParams({ cedula, view: 'welcome' });
        if (eid) qs.set('eventId', eid);
        const res = await fetch(`/api/pending-transactions?${qs.toString()}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Error consultando transacciones');
        return data;
      }

      function renderWelcomeTransactions(payload: any, cedula: string) {
        const listEl = document.getElementById('welcomeTxList');
        if (!listEl) return;
        const hero = document.getElementById('welcomeGraceHero');

        // Preserve the hero element inside the carousel; clear only other cards.
        Array.from(listEl.children).forEach((child) => {
          if (hero && child === hero) return;
          child.remove();
        });
        // Reset scroll to the first story.
        try {
          (listEl as HTMLElement).scrollLeft = 0;
        } catch {
          // ignore
        }

        if (hero) {
          hero.classList.add('hidden');
          hero.innerHTML = '';
        }
        stopWelcomeGraceCountdown();

        const txsRaw = Array.isArray(payload?.transactions) ? payload.transactions : [];
        const paidNumsRaw = Array.isArray(payload?.paidNumbers) ? payload.paidNumbers : [];
        const paidNums = paidNumsRaw
          .map((n: any) => String(n ?? '').trim())
          .filter(Boolean)
          .sort();
        const now = Date.now();

        const packSize = Number(promoPackSize || 0) || 3;

        const promoTxs = txsRaw
          .map((tx: any) => {
            const promoExpiresAt = tx?.promoExpiresAt ? String(tx.promoExpiresAt) : null;
            const msRemaining = promoExpiresAt ? Math.max(0, Date.parse(promoExpiresAt) - now) : 0;
            return { ...tx, promoExpiresAt, msRemaining };
          })
          .filter((tx: any) => Number(tx?.msRemaining ?? 0) > 0)
          // If the user already completed the pack (e.g. the last number was paid and ended up as estado='pago'),
          // don't keep showing the ‚Äúte falta(n) X‚Äù story during the same session.
          .filter((tx: any) => {
            const qty = Math.max(0, Number(tx?.cantidad ?? 0) || 0);
            const missing = qty > 0 ? ((packSize - (qty % packSize)) % packSize) : (packSize - 1);
            return missing > 0;
          });

        const reservationTxs = txsRaw
          .map((tx: any) => {
            const reservationExpiresAt = tx?.reservationExpiresAt ? String(tx.reservationExpiresAt) : null;
            const reservationMsRemaining = reservationExpiresAt
              ? Math.max(0, Date.parse(reservationExpiresAt) - now)
              : Math.max(0, Number(tx?.reservationMsRemaining ?? 0) || 0);
            return { ...tx, reservationExpiresAt, reservationMsRemaining };
          })
          .filter((tx: any) => Boolean(tx?.isReservedOnly) && Number(tx?.reservationMsRemaining ?? 0) > 0);

        if (promoTxs.length === 0 && reservationTxs.length === 0 && paidNums.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'snap-start shrink-0 w-full bg-white/80 border border-slate-200 rounded-2xl p-4 text-slate-600';
          empty.textContent = 'No tienes reservas activas en este evento.';
          listEl.appendChild(empty);
          return;
        }

        // Paid numbers story (participating numbers already paid)
        if (paidNums.length) {
          const card = document.createElement('div');
          card.className = 'snap-start shrink-0 w-full bg-emerald-50 border border-emerald-200 rounded-2xl p-4';

          const title = document.createElement('div');
          title.className = 'text-slate-900 font-black text-base';
          title.textContent = 'üéüÔ∏è Tus n√∫meros pagos en este evento';

          const meta = document.createElement('div');
          meta.className = 'mt-1 text-sm text-slate-700';
          meta.innerHTML = `Tienes <span class="font-black text-emerald-700">${paidNums.length}</span> n√∫mero(s) participando.`;

          const chips = document.createElement('div');
          chips.className = 'mt-3 flex flex-wrap gap-1';
          paidNums.slice(0, 48).forEach((n: string) => {
            const chip = document.createElement('span');
            chip.className = 'bg-emerald-50 border border-emerald-200 text-emerald-800 px-2 py-0.5 rounded-full text-[11px] font-black';
            chip.textContent = n;
            chips.appendChild(chip);
          });
          if (paidNums.length > 48) {
            const more = document.createElement('span');
            more.className = 'text-[11px] text-slate-600 ml-1 self-center';
            more.textContent = `+${paidNums.length - 48} m√°s`;
            chips.appendChild(more);
          }

          const note = document.createElement('div');
          note.className = 'mt-2 text-xs text-slate-700';
          note.textContent = 'Estos ya est√°n registrados para participar en la rifa.';

          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(chips);
          card.appendChild(note);
          listEl.appendChild(card);
        }

        // Hero for promo grace (if present)
        if (promoTxs.length && hero) {
          const primary = promoTxs[0];
          const qty = Math.max(0, Number(primary?.cantidad ?? 0) || 0);
          const missing = qty > 0 ? ((packSize - (qty % packSize)) % packSize) : (packSize - 1);
          const numsPrimary = Array.isArray(primary?.numeros) ? primary.numeros : [];
          const expiresIso = primary?.promoExpiresAt ? String(primary.promoExpiresAt) : '';
          const heroCountdown = expiresIso ? formatCountdown(Math.max(0, Date.parse(expiresIso) - now)) : '';

          hero.classList.remove('hidden');
          const title = document.createElement('div');
          title.className = 'text-slate-900 font-black text-base';
          title.textContent = '‚≠ê ¬°A un paso de tu promoci√≥n!';

          const subtitle = document.createElement('div');
          subtitle.className = 'mt-1 text-slate-700 text-sm';
          subtitle.innerHTML = `Tienes <span class="font-black text-amber-800">${qty}</span> boleta(s) en ventana promo. Te falta(n) <span class="font-black text-amber-800">${missing}</span> para quedar en promoci√≥n.`;

          const time = document.createElement('div');
          time.className = 'mt-2 text-xs text-slate-600';
          time.innerHTML = `Tiempo restante: <span class="font-black text-amber-800" data-welcome-grace-expires="${expiresIso}">‚è≥ ${heroCountdown}</span>`;

          const numsWrap = document.createElement('div');
          numsWrap.className = 'mt-3';
          const numsLabel = document.createElement('div');
          numsLabel.className = 'text-xs text-slate-700 font-semibold';
          numsLabel.textContent = 'N√∫meros que ya adquiriste:';
          numsWrap.appendChild(numsLabel);

          const chips = document.createElement('div');
          chips.className = 'mt-2 flex flex-wrap gap-1';
          if (numsPrimary.length) {
            numsPrimary.forEach((n: string) => {
              const chip = document.createElement('span');
              chip.className = 'bg-amber-50 border border-amber-200 text-amber-800 px-2 py-0.5 rounded-full text-[11px] font-black';
              chip.textContent = String(n);
              chips.appendChild(chip);
            });
          } else {
            const none = document.createElement('div');
            none.className = 'text-xs text-slate-500';
            none.textContent = '‚Äî';
            chips.appendChild(none);
          }
          numsWrap.appendChild(chips);

          const cta = document.createElement('div');
          cta.className = 'mt-3 text-sm text-slate-700';
          cta.innerHTML = `Haz clic en <span class="font-black text-rose-700">‚ÄúSeguir al evento‚Äù</span> y agrega tus ${missing} boleta(s) ahora para aprovechar la promo.`;

          hero.appendChild(title);
          hero.appendChild(subtitle);
          hero.appendChild(time);
          hero.appendChild(numsWrap);
          hero.appendChild(cta);
        }

        if (reservationTxs.length) {
          // No header card: each story contains its own badge.
        }

        reservationTxs.forEach((tx: any) => {
          const card = document.createElement('div');
          card.className = 'snap-start shrink-0 w-full bg-white/80 border border-slate-200 rounded-2xl p-4';
          card.setAttribute('data-welcome-reservation-card', '1');

          const badge = document.createElement('div');
          badge.className = 'inline-flex items-center gap-1 text-[11px] font-black text-amber-800 bg-amber-50 border border-amber-200 px-2 py-1 rounded-full';
          badge.textContent = '‚è≥ Reserva activa';

          const header = document.createElement('div');
          header.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2';

          const left = document.createElement('div');
          left.className = 'text-sm text-slate-900';
          const txNumber = String(tx?.transactionNumber || '').trim();
          left.textContent = txNumber ? `Reserva: ${txNumber}` : 'Reserva';

          const right = document.createElement('div');
          right.className = 'text-xs text-slate-600';
          const msRemaining = Number(tx?.reservationMsRemaining ?? 0) || 0;
          const countdown = msRemaining > 0 ? formatCountdown(msRemaining) : '';
          const expiresIso2 = tx?.reservationExpiresAt ? String(tx.reservationExpiresAt) : '';
          if (expiresIso2 && countdown) {
            right.setAttribute('data-welcome-reservation-expires', expiresIso2);
            right.textContent = `‚è≥ ${countdown}`;
          }

          header.appendChild(left);
          header.appendChild(right);

          const meta = document.createElement('div');
          meta.className = 'mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2 text-xs';
          const cantidad = Number(tx?.cantidad ?? 0) || 0;
          const totalPrice = Number(tx?.totalPrice ?? 0) || 0;

          const a = document.createElement('div');
          a.className = 'text-slate-700';
          a.textContent = `Boletas: ${cantidad}`;
          const b = document.createElement('div');
          b.className = 'text-slate-700';
          b.textContent = `Total: ${formatCOP(totalPrice)}`;
          const c = document.createElement('div');
          c.className = 'text-slate-700';
          c.textContent = 'Estado: Reservado';

          meta.appendChild(a);
          meta.appendChild(b);
          meta.appendChild(c);

          const nums = document.createElement('div');
          nums.className = 'mt-3 text-xs text-slate-700';
          const numsList = Array.isArray(tx?.numeros) ? tx.numeros : [];
          nums.innerHTML = `N√∫meros: <span class="font-black text-slate-900">${numsList.join(', ') || '‚Äî'}</span>`;

          const note = document.createElement('div');
          note.className = 'mt-2 text-xs text-slate-600';
          note.textContent = 'Si se vence el tiempo, estos n√∫meros vuelven a estar disponibles.';

          card.appendChild(header);
          card.appendChild(badge);
          card.appendChild(meta);
          card.appendChild(nums);
          card.appendChild(note);
          listEl.appendChild(card);
        });

        if (promoTxs.length) {
          // No header card: hero + each story communicates the context.
        }

        promoTxs.forEach((tx: any) => {
          const card = document.createElement('div');
          card.className = 'snap-start shrink-0 w-full bg-white/80 border border-slate-200 rounded-2xl p-4';
          card.setAttribute('data-welcome-grace-card', '1');

          const badge = document.createElement('div');
          badge.className = 'inline-flex items-center gap-1 text-[11px] font-black text-amber-800 bg-amber-50 border border-amber-200 px-2 py-1 rounded-full';
          badge.textContent = '‚≠ê Ventana promo';

          const header = document.createElement('div');
          header.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2';

          const left = document.createElement('div');
          left.className = 'text-sm text-slate-900';
          const txNumber = String(tx?.transactionNumber || '').trim();
          left.textContent = txNumber ? `Operaci√≥n: ${txNumber}` : 'Operaci√≥n';

          const right = document.createElement('div');
          right.className = 'text-xs text-slate-600';
          const createdAt = tx?.createdAt ? new Date(tx.createdAt).toLocaleString('es-CO') : '';
          const msRemaining = Number(tx?.msRemaining ?? 0) || 0;
          const countdown = msRemaining > 0 ? formatCountdown(msRemaining) : '';
          const expiresIso2 = tx?.promoExpiresAt ? String(tx.promoExpiresAt) : '';
          if (expiresIso2 && countdown) {
            right.setAttribute('data-welcome-grace-expires', expiresIso2);
            right.textContent = `‚è≥ ${countdown}`;
          } else {
            right.textContent = createdAt;
          }

          header.appendChild(left);
          header.appendChild(right);

          const meta = document.createElement('div');
          meta.className = 'mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2 text-xs';
          const cantidad = Number(tx?.cantidad ?? 0) || 0;
          const totalPrice = Number(tx?.totalPrice ?? 0) || 0;
          const creditedTotal = Number(tx?.creditedTotal ?? 0) || 0;
          const saldoPendiente = Number(tx?.saldoPendiente ?? 0) || 0;

          const a = document.createElement('div');
          a.className = 'text-slate-700';
          a.textContent = `Boletas: ${cantidad}`;
          const b = document.createElement('div');
          b.className = 'text-slate-700';
          b.textContent = `Total: ${formatCOP(totalPrice)}`;
          const c = document.createElement('div');
          c.className = saldoPendiente > 0 ? 'text-amber-800 font-semibold' : 'text-emerald-700 font-semibold';
          c.textContent = saldoPendiente > 0 ? `Pendiente: ${formatCOP(saldoPendiente)}` : `Pagada: ${formatCOP(creditedTotal)}`;

          meta.appendChild(a);
          meta.appendChild(b);
          meta.appendChild(c);

          const nums = Array.isArray(tx?.numeros) ? tx.numeros : [];
          const numsEl = document.createElement('div');
          numsEl.className = 'mt-3 text-xs text-slate-600';
          numsEl.textContent = nums.length ? `N√∫meros: ${nums.join(', ')}` : '';

          const qty2 = Math.max(0, Number(tx?.cantidad ?? 0) || 0);
          const missing2 = qty2 > 0 ? ((packSize - (qty2 % packSize)) % packSize) : (packSize - 1);
          const missingEl = document.createElement('div');
          missingEl.className = 'mt-2 text-xs font-semibold text-amber-800';
          missingEl.textContent = `Te falta(n) ${missing2} boleta(s) para promo.`;

          card.appendChild(header);
          card.appendChild(badge);
          card.appendChild(meta);
          card.appendChild(missingEl);
          if (numsEl.textContent) card.appendChild(numsEl);
          listEl.appendChild(card);
        });

        startWelcomeGraceCountdown();
      }

      async function welcomeLoadTransactions(cedula: string) {
        try {
          setWelcomeTxStatus('Cargando transacciones...');
          const payload = await fetchWelcomeTransactions(cedula);
          setWelcomeTxStatus('');
          renderWelcomeTransactions(payload, cedula);
        } catch (e) {
          console.error('Error loading welcome transactions:', e);
          setWelcomeTxStatus('No se pudieron cargar tus transacciones.');
          const listEl = document.getElementById('welcomeTxList');
          if (listEl) {
            const hero = document.getElementById('welcomeGraceHero');
            Array.from(listEl.children).forEach((child) => {
              if (hero && child === hero) return;
              child.remove();
            });
            if (hero) {
              hero.classList.add('hidden');
              hero.innerHTML = '';
            }
            const err = document.createElement('div');
            err.className = 'snap-start shrink-0 w-full bg-red-900/20 border border-red-500/20 rounded-2xl p-4 text-red-200 text-sm';
            err.textContent = String((e as any)?.message || e);
            listEl.appendChild(err);
          }
        }
      }

      function welcomeRefreshTransactions() {
        const cedula = String((document.getElementById('cedula') as HTMLInputElement | null)?.value || '').trim();
        if (!cedula) return;
        void welcomeLoadTransactions(cedula);
      }

      async function handleFormSubmit(event: Event) {
        event.preventDefault();

        const formData = {
          id: document.getElementById('usuarioId').value || null,
          cedula: document.getElementById('cedula').value,
          primerNombre: document.getElementById('primerNombre').value,
          segundoNombre: document.getElementById('segundoNombre').value,
          primerApellido: document.getElementById('primerApellido').value,
          segundoApellido: document.getElementById('segundoApellido').value,
          fechaNacimiento: document.getElementById('fechaNacimiento').value || null,
          departamento: document.getElementById('departamento').value || null,
          ciudad: document.getElementById('ciudad').value || null,
          correoElectronico: document.getElementById('correoElectronico').value || null,
          telefono: document.getElementById('telefono').value || null,
        };

        try {
          const response = await fetch('/api/save-usuario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (response.ok) {
            // Move to numbers selection
            showNumbersStep();
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          console.error('Error saving usuario:', error);
          alert('Error al guardar datos');
        }
      }

      async function showNumbersStep() {
        document.getElementById('participantForm').classList.add('hidden');
        document.getElementById('numbersStep').classList.remove('hidden');

        // If the user returns to this step in the same session, don't keep old overlays/views.
        resetSummaryPanelView();
        resetNumbersStepTransientUI();
        selectedNumbers = [];
        availableNumbers = [];

        const grid = document.getElementById('numbersGrid');
        if (grid) {
          grid.innerHTML = '<div class="col-span-full text-center text-sm text-slate-500 py-8">Cargando n√∫meros‚Ä¶</div>';
        }

        // Set event info
        document.getElementById('numEventsCampaign').textContent = currentEvent.campaignName;
        document.getElementById('numEventsName').textContent = currentEvent.eventName;
        document.getElementById('numEventsParticipant').textContent = 
          document.getElementById('primerNombre').value + ' ' + document.getElementById('primerApellido').value;

        // Generate and display numbers
        await generateNumbers();

        // Ensure the summary panel has a consistent initial render (even with 0 numbers)
        updateSelectionSummary();

        // Mobile: always start closed; user opens via "üí∞ Ver resumen".
        if (typeof window !== 'undefined' && window.innerWidth < 768) {
          hideSummary();
        }

        // Promo window guidance (best-effort)
        refreshPromoStatus();
      }

      // Abono global input: if user types manually, stop auto-overriding (unless it falls below minimum).
      // (Best-effort; the min clamp is still enforced in updateSelectionSummary.)
      if (typeof document !== 'undefined') {
        const ab = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
        if (ab && !(ab as any).__boundAutoFlag) {
          (ab as any).__boundAutoFlag = true;
          ab.addEventListener('input', () => {
            abonoGlobalWasAutoSet = false;
          });
        }
      }

      async function generateNumbers() {
        const numbersMode = currentEvent.numbersMode;
        let maxNumber = 0;

        if (numbersMode === '0-99') maxNumber = 100;
        else if (numbersMode === '0-999') maxNumber = 1000;
        else if (numbersMode === '0-9999') maxNumber = 10000;

        const padding = numbersMode === '0-99' ? 2 : numbersMode === '0-999' ? 3 : 4;

        try {
          // Obtener n√∫meros ocupados del servidor
          const response = await fetch(`/api/numeros-ocupados?eventId=${currentEvent.eventId}`);
          const data = await response.json();
          const ocupados = data.numerosOcupados || [];
          ocupadosSet = new Set(ocupados);

          // Generate all possible numbers
          const allNumbers = Array.from({length: maxNumber}, (_, i) => i);
          
          // Separar disponibles de ocupados
          const available = [];
          
          allNumbers.forEach(num => {
            const formattedNum = String(num).padStart(padding, '0');
            if (ocupadosSet.has(formattedNum)) {
              // no incluir en el grid
            } else {
              available.push(num);
            }
          });

          // Seleccionar hasta 400 disponibles aleatoriamente
          const shuffled = available.sort(() => 0.5 - Math.random());
          const selectedAvailable = shuffled.slice(0, Math.min(400, available.length));
          
          // Solo mostrar disponibles (hasta 400 aleatorios)
          availableNumbers = [...selectedAvailable];
          
          displayNumbers();
          // Keep promo banner accurate while user is on the grid
          refreshPromoStatus();
        } catch (error) {
          console.error('Error loading available numbers:', error);
          alert('Error al cargar n√∫meros disponibles');
        }
      }

      function displayNumbers() {
        const numbersMode = currentEvent.numbersMode;
        const padding = numbersMode === '0-99' ? 2 : numbersMode === '0-999' ? 3 : 4;
        
        const grid = document.getElementById('numbersGrid');
        grid.innerHTML = '';

        // IMPORTANT: keep the grid truly random (no asc/desc ordering)
        availableNumbers.forEach(num => {
          const button = document.createElement('button');
          button.type = 'button';
          const formattedNum = String(num).padStart(padding, '0');
          button.dataset.number = formattedNum;
          
          // Grid solo muestra disponibles, pero por seguridad revalidamos
          const isOcupado = ocupadosSet.has(formattedNum);

          if (isOcupado) {
            // Si se ocup√≥ despu√©s del fetch, no permitir seleccionar
            button.textContent = formattedNum;
            button.className = 'bg-slate-100 border border-slate-200 text-slate-400 font-bold py-2 rounded cursor-not-allowed opacity-80';
            button.disabled = true;
          } else if (selectedNumbers.includes(formattedNum)) {
            // N√∫mero seleccionado por el usuario
            button.textContent = formattedNum;
            button.className = 'bg-amber-100 border border-amber-200 text-amber-900 font-extrabold py-2 rounded transition-colors ring-2 ring-amber-200';
            button.onclick = () => toggleNumber(formattedNum);
          } else {
            // N√∫mero disponible
            button.textContent = formattedNum;
            button.className = 'bg-rose-100 border border-rose-200 text-rose-900 font-extrabold py-2 rounded transition-colors hover:bg-rose-200 active:bg-rose-300';
            button.onclick = () => toggleNumber(formattedNum);
          }
          
          grid.appendChild(button);
        });
      }

      function toggleNumber(numero: string) {
        const index = selectedNumbers.indexOf(numero);
        
        if (index > -1) {
          // Remove from selection
          selectedNumbers.splice(index, 1);
        } else {
          // Nuevo comportamiento: permitir selecci√≥n libre (sin l√≠mite durante gracia)
          // Add to selection
          selectedNumbers.push(numero);
        }
        
        displayNumbers();
        // Any selection change invalidates previously confirmed abono detail
        resetAbonoDetailState();
        updateSelectionSummary();
      }

      function updateSelectionSummary() {
        const summaryBtn = document.getElementById('summaryFloatingBtn');
        const summarySection = document.getElementById('selectedNumbersSection');
        const summaryCount = document.getElementById('summaryCount');

        const hasSelection = selectedNumbers.length > 0;

        // Update count badge (always)
        if (summaryCount) summaryCount.textContent = String(selectedNumbers.length);

        // Visibility rules:
        // - Mobile: show the button even if empty; open/close is controlled by toggleSummary().
        // - Desktop: keep the panel visible (empty or not) so the layout stays 50/50.
        if (window.innerWidth < 768) {
          summaryBtn?.classList.remove('hidden');
          if (!hasSelection) {
            // Keep the panel closed by default on mobile when empty
            if (summarySection) summarySection.style.display = 'none';
          }
        } else {
          if (summarySection) summarySection.style.display = 'block';
        }

        // Enable/disable checkout buttons
        document.querySelectorAll('.selectNumberBtn').forEach(btn => (btn.disabled = !hasSelection));

        // Display selected numbers as badges
        const listDiv = document.getElementById('selectedNumbersList');
        if (!listDiv) return;
        listDiv.innerHTML = '';

        if (!hasSelection) {
          const empty = document.createElement('div');
          empty.className = 'text-xs text-slate-500 italic';
          empty.textContent = 'Selecciona n√∫meros para ver el resumen.';
          listDiv.appendChild(empty);
        } else {
          const sortedSelected = [...selectedNumbers].sort();
          sortedSelected.forEach(num => {
            const badge = document.createElement('span');
            badge.className = 'bg-rose-50 border border-rose-200 text-rose-900 px-3 py-1 rounded-full text-sm font-extrabold flex items-center gap-2';
            badge.innerHTML = `${num} <button onclick="toggleNumber('${num}')" class="text-rose-700 hover:text-rose-900">\u00d7</button>`;
            listDiv.appendChild(badge);
          });
        }

        // Calculate pricing with promo logic (single source of truth)
        const pricing = computeSelectionPricing();
        const quantity = pricing.quantity;
        const promoSets = pricing.promoSets;
        const remainingNormal = pricing.remainingNormal;
        const normalTotal = pricing.normalTotal;
        const promoTotal = pricing.promoTotal;
        const total = pricing.total;

        renderTxBreakdown(pricing.breakdown);

        // Regla: si el usuario est√° COMPLETANDO promo dentro de gracia y a√∫n falta m√≠nimo (20k),
        // no permitir "solo reservar".
        try {
          const { plan } = computeTxPlanWithNumbers(pricing);
          const completingPromo = plan.find((p: any) => p?.kind === 'grace' && /complet\w*\s+promo/i.test(String(p?.label || '')));
          const checkoutReserva = document.getElementById('checkoutReserva') as HTMLInputElement | null;
          const checkoutPago = document.getElementById('checkoutPago') as HTMLInputElement | null;
          const checkoutMsg = document.getElementById('checkoutMessage');

          const minAdditional = Math.max(0, Number(completingPromo?.min ?? 0) || 0);
          const priorCredited = Math.max(0, Number(completingPromo?.priorCredited ?? 0) || 0);
          const mustHaveProof = Boolean(promoGraceActive() && completingPromo && minAdditional > 0);

          if (checkoutReserva) checkoutReserva.disabled = mustHaveProof;

          if (mustHaveProof && checkoutAction === 'reserva') {
            if (checkoutPago) checkoutPago.checked = true;
            setCheckoutAction('pago');
          }

          // Mostrar aviso s√≥lo cuando el usuario est√° en Pago/Abono (proofSection visible)
          if (checkoutMsg && mustHaveProof && checkoutAction !== 'reserva') {
            checkoutMsg.classList.remove('hidden');
            checkoutMsg.className = 'text-sm rounded-lg p-2 border bg-amber-50 border-amber-200 text-amber-800';
            checkoutMsg.textContent = `Para completar la promoci√≥n debes registrar un comprobante. Abono m√≠nimo adicional: ${formatCOPShort(minAdditional)} (ya validado: ${formatCOPShort(priorCredited)}).`;
          } else if (checkoutMsg) {
            // No sobrescribir otros mensajes; s√≥lo ocultar si es el mensaje nuestro.
            if (String(checkoutMsg.textContent || '').includes('Para completar la promoci√≥n')) {
              checkoutMsg.classList.add('hidden');
              checkoutMsg.textContent = '';
              checkoutMsg.className = 'hidden text-xs rounded-lg p-2 border';
            }
          }
        } catch {
          // ignore
        }

        // Abono profesional: mostrar m√≠nimo global y exigir confirmar detalle si hay varias operaciones.
        const abonoGlobalRow = document.getElementById('abonoGlobalRow');
        const abonoGlobalAmount = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
        const abonoGlobalHint = document.getElementById('abonoGlobalHint');
        const abonoDetailBtn = document.getElementById('abonoDetailBtn') as HTMLButtonElement | null;

        const multipleTx = (pricing.breakdown || []).length > 1;

        if (checkoutAction === 'abono') {
          abonoGlobalRow?.classList.remove('hidden');
          const { plan, globalMin } = computeTxPlanWithNumbers(pricing);

          const globalMaxAllowed = plan.reduce((s: number, p: any) => {
            const t = Number(p?.total ?? 0) || 0;
            return s + (t > 0 ? t : 0);
          }, 0);

          const raw = String(abonoGlobalAmount?.value || '').trim();
          const val = raw ? Number(raw) : NaN;

          // Regla din√°mica seg√∫n cantidad de boletas:
          // - Si hay transacci√≥n de gracia completando promo Y es la √∫nica transacci√≥n: usar su m√≠nimo
          // - Si completa gracia PERO hay m√°s transacciones: usar globalMin (suma de todas)
          // - Menos de 3 boletas (sin gracia): usar m√≠nimo simple
          // - 4+ boletas: usar m√≠nimo global
          const selectedQty = selectedNumbers.length;
          const graceCompletionPlan = plan.find(p => p.kind === 'grace' && /complet\w*\s+promo/i.test(p.label || ''));
          
          const effectiveMin = graceCompletionPlan && plan.length === 1
            ? (Number(graceCompletionPlan.min ?? 0) || 0)
            : (selectedQty < 3 && plan.length === 1
              ? (Number(plan[0]?.min ?? 0) || 10000)
              : globalMin);

          const okVal = Number.isFinite(val) && val >= effectiveMin;

          // Siempre reflejar el m√≠nimo efectivo y hacer que el input no acepte menos.
          if (abonoGlobalAmount) {
            abonoGlobalAmount.min = String(effectiveMin);
            if (globalMaxAllowed > 0) abonoGlobalAmount.max = String(Math.trunc(globalMaxAllowed));

            // Din√°mico: si el m√≠nimo efectivo cambia, mantener el valor >= m√≠nimo.
            // - No pisar cuando el usuario ya escribi√≥ un valor v√°lido.
            // - Si el valor actual est√° por debajo del m√≠nimo, auto-ajustar (incluso enfocado).
            // - Si estaba en auto-set, actualizar hacia arriba Y hacia abajo.
            const minChanged = lastAbonoGlobalMin == null || Math.abs(effectiveMin - lastAbonoGlobalMin) > 0.0001;
            const curr = Number.isFinite(val) ? val : NaN;

            if (!raw || !Number.isFinite(curr)) {
              abonoGlobalAmount.value = String(effectiveMin);
              abonoGlobalWasAutoSet = true;
            } else if (curr + 0.0001 < effectiveMin) {
              abonoGlobalAmount.value = String(effectiveMin);
              abonoGlobalWasAutoSet = true;
            } else if (minChanged && abonoGlobalWasAutoSet) {
              // Si ven√≠a en modo auto-set, mantenerlo sincronizado al m√≠nimo efectivo (sube y baja).
              abonoGlobalAmount.value = String(effectiveMin);
            }

            // Clamp max (best-effort)
            const after = Number(String(abonoGlobalAmount.value || '').trim() || 0);
            if (globalMaxAllowed > 0 && Number.isFinite(after) && after > globalMaxAllowed + 0.0001) {
              abonoGlobalAmount.value = String(Math.trunc(globalMaxAllowed));
              abonoGlobalWasAutoSet = true;
            }

            lastAbonoGlobalMin = effectiveMin;
          }

          if (abonoGlobalHint) {
            const minTxt = formatCOPShort(effectiveMin);
            const maxTxt = globalMaxAllowed > 0 ? ` M√°ximo: ${formatCOPShort(globalMaxAllowed)}.` : '';
            const dynLabel = selectedNumbers.length < 3 ? 'Abono m√≠nimo' : 'M√≠nimo global para esta operaci√≥n';
            abonoGlobalHint.textContent = multipleTx
              ? `${dynLabel}: ${minTxt}.${maxTxt} Debes confirmar el detalle antes de enviar.`
              : `Abono m√≠nimo: ${minTxt}.${maxTxt}`;
          }

          if (abonoDetailBtn) {
            abonoDetailBtn.disabled = !okVal;
            abonoDetailBtn.textContent = abonoDetailConfirmed ? 'Ver detalle (confirmado)' : 'Ver detalle de abono';
            abonoDetailBtn.classList.toggle('opacity-60', !okVal);
            abonoDetailBtn.classList.toggle('cursor-not-allowed', !okVal);
          }
        } else {
          abonoGlobalRow?.classList.add('hidden');
        }

        const qtyEl = document.getElementById('totalQuantity');
        const promosEl = document.getElementById('totalPromos');
        const normalEl = document.getElementById('normalPrice');
        const promoEl = document.getElementById('promoPrice');
        const totalEl = document.getElementById('totalPrice');

        if (qtyEl) qtyEl.textContent = quantity;
        if (promosEl) promosEl.textContent = promoSets;
        if (normalEl) normalEl.textContent = normalTotal.toLocaleString();
        if (promoEl) promoEl.textContent = promoTotal.toLocaleString();
        if (totalEl) totalEl.textContent = '$' + total.toLocaleString();

        // Promo UX messages (2 seconds each)
        // Only show during an active grace window; don't spam unless selection count changes.
        if (promoGraceActive()) {
          const remainingToComplete = Math.max(0, (Number(promoRequiredAdditional || 0) || 0) - Math.min(selectedNumbers.length, (Number(promoRequiredAdditional || 0) || 0)));
          const selectionCountChanged = lastPromoToastSelectionCount == null || lastPromoToastSelectionCount !== selectedNumbers.length;

          if (selectionCountChanged) {
            const prevRemaining = lastPromoRemainingToComplete;

            if (remainingToComplete > 0) {
              showPromoToast(`Te faltan ${remainingToComplete} para completar la promoci√≥n`);
            } else if (remainingToComplete === 0 && prevRemaining != null && prevRemaining > 0) {
              showPromoToast('Completaste tu promoci√≥n. Si quieres, escoge m√°s n√∫meros.');
            }

            lastPromoRemainingToComplete = remainingToComplete;
            lastPromoToastSelectionCount = selectedNumbers.length;
          }
        } else {
          // Reset state when grace is not active
          lastPromoRemainingToComplete = null;
          lastPromoToastSelectionCount = null;
        }
      }

      function toggleSummary() {
        const el = document.getElementById('selectedNumbersSection');
        const modalContent = el?.querySelector('.modal-content');
        if (!el) return;

        // Desktop: summary is inline; no toggle.
        if (typeof window !== 'undefined' && window.innerWidth >= 768) {
          el.style.display = 'block';
          return;
        }
        
        if (el.style.display === 'none') {
          el.style.display = 'flex';
          modalContent?.classList.add('show');
        } else {
          el.style.display = 'none';
          modalContent?.classList.remove('show');
        }
      }

      function hideSummary() {
        const el = document.getElementById('selectedNumbersSection');
        const modalContent = el?.querySelector('.modal-content');
        if (!el) return;

        // Desktop: keep it visible.
        if (typeof window !== 'undefined' && window.innerWidth >= 768) {
          el.style.display = 'block';
          return;
        }
        el.style.display = 'none';
        modalContent?.classList.remove('show');
      }

      function refreshNumbers() {
        generateNumbers();
      }

      // Search panel UX
      let searchPanelOpen = false;

      function setSearchPanel(open: boolean) {
        searchPanelOpen = open;
        const panel = document.getElementById('searchPanel');
        const btn = document.getElementById('searchToggleBtn') as HTMLButtonElement | null;
        const resultDiv = document.getElementById('searchResult');
        const input = document.getElementById('searchNumber') as HTMLInputElement | null;

        if (panel) panel.classList.toggle('hidden', !open);
        if (btn) {
          if (!open) {
            delete (btn as any).dataset.selectNumero;
            btn.textContent = 'üîé Buscar n√∫mero';
          } else {
            btn.textContent = (btn as any).dataset.selectNumero ? '‚úÖ Seleccionar' : 'üîé Buscar (Enter)';
          }
        }

        if (!open) {
          if (input) input.value = '';
          if (resultDiv) {
            resultDiv.classList.add('hidden');
            resultDiv.innerHTML = '';
          }
          return;
        }

        // open
        if (resultDiv) {
          resultDiv.classList.add('hidden');
          resultDiv.innerHTML = '';
        }
        setTimeout(() => input?.focus?.(), 0);
      }

      function onSearchButtonClick() {
        if (!searchPanelOpen) {
          setSearchPanel(true);
          return;
        }

        const btn = document.getElementById('searchToggleBtn') as HTMLButtonElement | null;
        const selectNumero = btn ? String((btn as any).dataset.selectNumero || '').trim() : '';
        if (selectNumero) {
          selectSearchedNumber(selectNumero);
          return;
        }

        void checkNumber();
      }

      function selectSearchedNumber(numero: string) {
        toggleNumber(numero);
        setSearchPanel(false);
      }

      // If user edits the input after an available result, go back to search mode
      document.addEventListener('input', (e) => {
        if (!searchPanelOpen) return;
        const t = e.target as HTMLInputElement | null;
        if (!t || t.id !== 'searchNumber') return;
        const btn = document.getElementById('searchToggleBtn') as HTMLButtonElement | null;
        if (!btn) return;
        delete (btn as any).dataset.selectNumero;
        btn.textContent = 'üîé Buscar (Enter)';
      });

      // Enter triggers search
      document.addEventListener('keydown', (e) => {
        if (!searchPanelOpen) return;
        if (e.key !== 'Enter') return;
        const active = document.activeElement as HTMLElement | null;
        if (active && active.id === 'searchNumber') {
          e.preventDefault();
          void checkNumber();
        }
      });

      async function checkNumber() {
        const inputEl = document.getElementById('searchNumber') as HTMLInputElement | null;
        const searchInput = String(inputEl?.value || '').trim();
        if (!searchInput) {
          alert('Ingresa un n√∫mero para buscar');
          return;
        }

        const numbersMode = currentEvent.numbersMode;
        const padding = numbersMode === '0-99' ? 2 : numbersMode === '0-999' ? 3 : 4;
        const paddedNumber = searchInput.padStart(padding, '0');

        const numberValue = parseInt(searchInput);
        const maxNumber = numbersMode === '0-99' ? 100 : numbersMode === '0-999' ? 1000 : 10000;

        const resultDiv = document.getElementById('searchResult');
        resultDiv.classList.remove('hidden');

        if (numberValue >= maxNumber) {
          resultDiv.className = 'mt-2 p-3 rounded-lg bg-red-900/30 border border-red-500/30 text-red-300';
          resultDiv.textContent = `‚ùå N√∫mero ${paddedNumber} no existe en este evento`;
          return;
        }

        // Buscar el estado del n√∫mero en la base de datos
        try {
          const response = await fetch(`/api/check-numero?eventId=${currentEvent.eventId}&numero=${paddedNumber}`);
          const data = await response.json();

          const btn = document.getElementById('searchToggleBtn') as HTMLButtonElement | null;
          if (btn) {
            delete (btn as any).dataset.selectNumero;
            btn.textContent = 'üîé Buscar (Enter)';
          }

          if (!data.exists) {
            resultDiv.className = 'mt-2 p-3 rounded-lg bg-red-900/30 border border-red-500/30 text-red-300';
            resultDiv.textContent = `‚ùå N√∫mero ${paddedNumber} no existe en este evento`;
            return;
          }

          // Mostrar estado seg√∫n la respuesta
          if (data.estado === 'disponible') {
            resultDiv.className = 'mt-2 p-3 rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-800';
            resultDiv.innerHTML = `‚úì N√∫mero ${paddedNumber} est√° DISPONIBLE <button onclick="selectSearchedNumber('${paddedNumber}')" class="ml-2 bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded font-bold">Seleccionar n√∫mero</button>`;

            // UX: if there is a number in the input and it's available, the main button becomes "Seleccionar"
            if (btn) {
              (btn as any).dataset.selectNumero = paddedNumber;
              btn.textContent = '‚úÖ Seleccionar';
            }
          } else if (data.estado === 'reservado') {
            resultDiv.className = 'mt-2 p-3 rounded-lg bg-amber-50 border border-amber-200 text-amber-800';
            resultDiv.textContent = `‚ö† N√∫mero ${paddedNumber} est√° RESERVADO`;
          } else if (data.estado === 'vendido') {
            resultDiv.className = 'mt-2 p-3 rounded-lg bg-red-900/30 border border-red-500/30 text-red-300';
            resultDiv.textContent = `‚ùå N√∫mero ${paddedNumber} est√° VENDIDO`;
          } else {
            resultDiv.className = 'mt-2 p-3 rounded-lg bg-red-900/30 border border-red-500/30 text-red-300';
            resultDiv.textContent = `‚ùå N√∫mero ${paddedNumber} no est√° disponible (${String(data.estado || '').toUpperCase()})`;
          }
        } catch (error) {
          console.error('Error checking number:', error);
          resultDiv.className = 'mt-2 p-3 rounded-lg bg-red-900/30 border border-red-500/30 text-red-300';
          resultDiv.textContent = 'Error al verificar el n√∫mero';
        }
      }

      async function selectNumbers() {
        if (selectedNumbers.length === 0) {
          alert('Por favor selecciona al menos un n√∫mero');
          return;
        }
        
        const pricing = computeSelectionPricing();
        const quantity = pricing.quantity;
        const cedula = document.getElementById('cedula').value;

        const promoSets = pricing.promoSets;
        const remainingNormal = pricing.remainingNormal;
        const normalUnitPrice = pricing.normalUnitPrice;
        const promoUnitPrice = pricing.promoUnitPrice;
        const normalTotal = pricing.normalTotal;
        const promoTotal = pricing.promoTotal;
        const totalPrice = pricing.total;

        // Disable all buttons to prevent double submission
        const buttons = document.querySelectorAll('.selectNumberBtn');
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'Guardando...';
        });

        try {
          let response;
          if (checkoutAction === 'reserva') {
            response = await fetch('/api/reservar-numeros', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                eventId: currentEvent.eventId,
                numeros: selectedNumbers,
                cedula: cedula,
                precioTotal: totalPrice,
                precioNormal: normalUnitPrice,
                precioPromo: promoUnitPrice,
                precioNormalTotal: normalTotal,
                precioPromoTotal: promoTotal,
                promociones: promoSets,
                cantidadNormal: remainingNormal,
                cantidadPromo: promoSets * 3
              })
            });
          } else {
            const proofFile = document.getElementById('proofFile') as HTMLInputElement | null;
            const file = proofFile?.files?.[0];
            if (!file) {
              alert('Debes adjuntar la imagen del comprobante.');
              buttons.forEach(btn => {
                btn.disabled = false;
                btn.textContent = 'Confirmar';
              });
              showSummary();
              return;
            }
            const fd = new FormData();
            fd.set('eventId', String(currentEvent.eventId));
            fd.set('numeros', JSON.stringify(selectedNumbers));
            fd.set('cedula', cedula);
            fd.set('precioTotal', String(totalPrice));
            fd.set('precioNormal', String(normalUnitPrice));
            fd.set('precioPromo', String(promoUnitPrice));
            fd.set('precioNormalTotal', String(normalTotal));
            fd.set('precioPromoTotal', String(promoTotal));
            fd.set('promociones', String(promoSets));
            fd.set('cantidadNormal', String(remainingNormal));
            fd.set('cantidadPromo', String(promoSets * 3));
            fd.set('kind', checkoutAction);
            if (checkoutAction === 'abono') {
              const pricing2 = computeSelectionPricing();
              const { plan, globalMin } = computeTxPlanWithNumbers(pricing2);
              const multipleTx = (pricing2.breakdown || []).length > 1;

              const globalAmountInput = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
              const globalAmountRaw = String(globalAmountInput?.value || '').trim();
              const globalAmount = globalAmountRaw ? Number(globalAmountRaw) : NaN;
              if (!Number.isFinite(globalAmount) || globalAmount <= 0) {
                alert('Ingresa un monto de abono v√°lido.');
                buttons.forEach(btn => {
                  btn.disabled = false;
                  btn.textContent = 'Confirmar';
                });
                showSummary();
                return;
              }
              if (globalAmount < globalMin) {
                alert(`El abono m√≠nimo para esta operaci√≥n es ${formatCOPShort(globalMin)}.`);
                buttons.forEach(btn => {
                  btn.disabled = false;
                  btn.textContent = 'Confirmar';
                });
                showSummary();
                return;
              }

              if (multipleTx) {
                const allocations = abonoAllocationsFinal;
                if (!allocations || allocations.length < plan.length) {
                  alert('Debes confirmar el detalle de abono antes de enviar.');
                  buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = 'Confirmar';
                  });
                  showSummary();
                  openAbonoDetail();
                  return;
                }
                fd.set('abonoAllocations', JSON.stringify(allocations));
              } else {
                // Single tx: send amount
                fd.set('amount', String(Math.trunc(globalAmount)));
              }
            }
            fd.set('file', file);

            response = await fetch('/api/reservar-numeros', {
              method: 'POST',
              body: fd,
            });
          }

          const result = await response.json();

          if (response.ok) {
            // Vercel Hobby: no Cron. Kick the outbox processor in a separate request (non-blocking).
            kickEmailOutbox();

            // Keep selection locked to avoid creating multiple transactions accidentally
            buttons.forEach(btn => {
              btn.disabled = true;
              btn.textContent = 'Reservado';
            });

            // Mostrar confirmaci√≥n profesional dentro del panel (sin URLs crudas)
            showCheckoutSuccess(result, { checkoutAction, totalPrice });
          } else {
            const errorMsg = result.error || 'Error desconocido';
            
            if (result.unavailableNumbers && result.unavailableNumbers.length > 0) {
              // Mostrar mensaje detallado sobre n√∫meros no disponibles
              alert(`‚ùå ${errorMsg}\n\n‚ùå Ya reservados por otro usuario: ${result.unavailableNumbers.join(', ')}\n\n‚ö†Ô∏è No se ha reservado ning√∫n n√∫mero.\nPor favor, cambia tu selecci√≥n y vuelve a confirmar.`);
              
              // NO deseleccionar - mantener la selecci√≥n actual
              // Actualizar la vista para mostrar los n√∫meros reservados tachados
              await generateNumbers();
              updateSelectionSummary();
            } else {
              alert(`‚ùå Error: ${errorMsg}`);
            }
            
            buttons.forEach(btn => {
              btn.disabled = false;
              btn.textContent = 'Confirmar';
            });
          }
        } catch (error) {
          console.error('Error reserving numbers:', error);
          alert('‚ùå Error al guardar la reserva. Por favor intenta nuevamente.');
          buttons.forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'Confirmar';
          });
        }
      }

      function kickEmailOutbox() {
        // Best-effort: on Vercel Hobby we don't have Cron, so this "kicks" the worker.
        // Use sendBeacon/keepalive to reduce the chance of the request getting cancelled.
        try {
          if (typeof navigator !== 'undefined' && typeof navigator.sendBeacon === 'function') {
            navigator.sendBeacon('/api/process-email-outbox');
          }
        } catch (e) {
          // ignore
        }

        const tryFetch = () =>
          fetch('/api/process-email-outbox', {
            method: 'POST',
            keepalive: true,
            headers: { 'cache-control': 'no-store' },
          }).catch(() => {
            // Intentionally ignored: outbox will be processed on next trigger.
          });

        tryFetch();
        setTimeout(tryFetch, 1500);
        setTimeout(tryFetch, 6000);
      }

      function selectNumberClick(numero: number, button: HTMLElement, numbersMode: string) {
        // This function is no longer used but kept for compatibility
      }

      // Close modal on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeParticipantsForm();
          closePaymentsModal();
        }
      });

      // Mobile UX: back button closes any open modal (instead of feeling like "cache")
      window.addEventListener('popstate', () => {
        if (ignoreNextPopstate) {
          ignoreNextPopstate = false;
          return;
        }

        const participantsModal = document.getElementById('participantsModal');
        if (participantsModal && !participantsModal.classList.contains('hidden')) {
          closeParticipantsForm({ fromPopstate: true });
          return;
        }

        const paymentsModal = document.getElementById('paymentsModal');
        if (paymentsModal && !paymentsModal.classList.contains('hidden')) {
          closePaymentsModal({ fromPopstate: true });
        }
      });

      // If the browser restores the page from back-forward cache, reset any stale modal UI.
      window.addEventListener('pageshow', (e) => {
        if ((e as PageTransitionEvent).persisted) {
          closeParticipantsForm({ fromPopstate: true });
          closePaymentsModal({ fromPopstate: true });
        }
      });

      // Make functions globally accessible
      window.openParticipantsForm = openParticipantsForm;
      window.closeParticipantsForm = closeParticipantsForm;
      window.openPaymentsModal = openPaymentsModal;
      window.closePaymentsModal = closePaymentsModal;
      window.paymentsSearch = paymentsSearch;
      window.searchUsuario = searchUsuario;
      window.handleFormSubmit = handleFormSubmit;
      window.backToSearch = backToSearch;
      window.backToForm = backToForm;
      window.welcomeEditDatos = welcomeEditDatos;
      window.welcomeContinue = welcomeContinue;
      window.welcomeRefreshTransactions = welcomeRefreshTransactions;
      window.selectNumbers = selectNumbers;
      window.onConfirmCheckout = onConfirmCheckout;
      window.toggleNumber = toggleNumber;
      window.refreshNumbers = refreshNumbers;
      window.checkNumber = checkNumber;
      window.onSearchButtonClick = onSearchButtonClick;
      window.selectSearchedNumber = selectSearchedNumber;

      // Wire payments modal buttons
      const paymentsCloseBtn = document.getElementById('paymentsCloseBtn');
      const paymentsSearchBtn = document.getElementById('paymentsSearchBtn');
      const paymentsCedulaInput = document.getElementById('paymentsCedulaInput');
      paymentsCloseBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        closePaymentsModal();
      });
      paymentsSearchBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        paymentsSearch();
      });
      paymentsCedulaInput?.addEventListener('keydown', (e: any) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          paymentsSearch();
        }
      });
      // Wire checkout option events
      const checkoutReserva = document.getElementById('checkoutReserva');
      const checkoutPago = document.getElementById('checkoutPago');
      const checkoutAbono = document.getElementById('checkoutAbono');

      checkoutReserva?.addEventListener('change', () => setCheckoutAction('reserva'));
      checkoutPago?.addEventListener('change', () => setCheckoutAction('pago'));
      checkoutAbono?.addEventListener('change', () => setCheckoutAction('abono'));

      // Abono detail flow controls
      const abonoGlobalAmount = document.getElementById('abonoGlobalAmount') as HTMLInputElement | null;
      const abonoDetailBtn = document.getElementById('abonoDetailBtn') as HTMLButtonElement | null;
      const abonoDetailBackBtn = document.getElementById('abonoDetailBackBtn') as HTMLButtonElement | null;
      const abonoDetailConfirmBtn = document.getElementById('abonoDetailConfirmBtn') as HTMLButtonElement | null;
      const abonoApplyExcessBtn = document.getElementById('abonoApplyExcessBtn') as HTMLButtonElement | null;

      abonoGlobalAmount?.addEventListener('input', () => {
        // Changing the global amount invalidates previously confirmed detail
        resetAbonoDetailState();
        updateSelectionSummary();
      });

      abonoGlobalAmount?.addEventListener('blur', () => {
        if (checkoutAction !== 'abono') return;
        const pricing = computeSelectionPricing();
        const { globalMin } = computeTxPlanWithNumbers(pricing);
        const raw = String(abonoGlobalAmount.value || '').trim();
        const val = raw ? Number(raw) : NaN;
        if (!raw || !Number.isFinite(val) || val < globalMin) {
          abonoGlobalAmount.value = String(globalMin);
          resetAbonoDetailState();
          updateSelectionSummary();
        }
      });

      abonoDetailBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        openAbonoDetail();
      });
      abonoApplyExcessBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        applyAbonoExcessToTarget();
      });
      abonoDetailBackBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        setAbonoDetailError(null);
        hideAbonoDetailView();
      });
      abonoDetailConfirmBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        confirmAbonoDetail();
      });

      // Initialize checkout UI
      resetCheckoutUI();
    </script>
  </body>
</html>
